// ==UserScript==
// @name              LinkSwift
// @namespace         github.com/hmjz100
// @version           1.1.0.1
// @author            KanouAo、Hmjz100、油小猴
// @icon              data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cGF0aCBkPSJNMTAzLjYgMTA3LjRjMy41LTIuMiA4LjktNi4xIDEzLjgtMTIuNXM3LjMtMTIuNSA4LjUtMTYuNWMuNS0xLjcgMi4yLTcuNSAyLjItMTQuNyAwLTEwLjEtMy4zLTI1LjEtMTUuNC0zNi44LTE0LjUtMTQtMzIuMS0xNC4zLTM1LjctMTQuMy04IDAtMTUuNyAxLjktMjIuNiA1LjJDNDQgMjMgMzUuNyAzMS40IDMwLjggNDEuN2MtMS4zIDIuOC00IDQuNy03LjEgNS00IC4zLTcuNSA0LjQtOC45IDkuNi0uNSAxLjktMS42IDMuNS0zLjEgNC43QzQuNCA2Ni44IDAgNzUuNyAwIDg1YzAgNi44IDIuMyAxMy4xIDYuMSAxOC4yIDUuNSA3LjQgMTQuMiAxMi4yIDI0IDEyLjJoNDcuMWM0LjQgMCAxMS0uNSAxOC4zLTMuNSAzLjItMS40IDUuOS0zIDguMS00LjV6IiBmaWxsPSIjQTA5OUYwIi8+PHBhdGggZD0iTTExOS44IDY0LjNjLjEtMTcuMS0xMC40LTI4LTEyLjUtMzAuMUM5NSAyMi4xIDc5LjkgMjEuOCA3Ni45IDIxLjhjLTE3LjYgMC0zMy4zIDEwLjUtMzkuOSAyNi43LS42IDEuMy0xLjggMi4zLTMuNCAyLjNoLS40Yy01LjggMC0xMC42IDQuOC0xMC42IDEwLjd2LjVjMCAxLjQtLjggMi42LTEuOSAzLjNDMTMuNCA2OSA4LjggNzYuOCA4LjggODVjMCAxMi4yIDkuOSAyMi4zIDIyLjIgMjIuM2g0NS4yYzMuNi0uMSAxNy42LS45IDI5LjYtMTIgMi45LTIuOCAxMy45LTEzLjcgMTQtMzF6IiBmaWxsPSIjNTc0QUI4Ii8+PHBhdGggZD0iTTExMC44IDU3LjRsLjIgMy4zYzAgMS4zLTEuMSAyLjQtMi4zIDIuNC0xLjMgMC0yLjMtMS4xLTIuMy0yLjRsLS4xLTIuOHYtLjNjMC0xLjIuOS0yLjIgMi4xLTIuM2guM2MuNyAwIDEuMy4zIDEuNy43LS4yLjEuMy41LjQgMS40em0tMy4zLTEwLjNjMCAxLjItMSAyLjMtMi4yIDIuM2gtLjFjLS44IDAtMS42LS41LTItMS4yLTQuNi04LjMtMTMuMy0xMy41LTIyLjgtMTMuNS0xLjIgMC0yLjMtMS0yLjMtMi4ydi0uMWMwLTEuMiAxLTIuMyAyLjItMi4zaC4xYTMwLjM3IDMwLjM3IDAgMCAxIDE1LjggNC40YzQuNiAyLjggOC40IDYuOCAxMS4xIDExLjUuMS4zLjIuNy4yIDEuMXpNODguMyA3My44TDczLjUgOTMuMmMtMS41IDEuOS0zLjUgMy4xLTUuNyAzLjVoLS4yYy0uNC4xLS44LjEtMS4yLjEtLjYgMC0xLjEtLjEtMS42LS4yLTIuMi0uNC00LjItMS43LTUuNi0zLjVMNDQuMyA3My45Yy0yLTIuNi0yLjUtNS40LTEuNC03LjcuMS0uMS4xLS4yLjItLjIgMS4yLTIgMy41LTMuMiA2LjQtMy4yaDYuNnYtNS43YzAtNi44IDQuNy0xMiAxMC45LTEyIDQuOCAwIDguNSAyLjYgMTAuMyA3LjIuNSAxLjMtLjIgMi43LTEuNSAzLjJzLTIuOC0uMS0zLjMtMS40Yy0xLjEtMi43LTIuOS00LTUuNS00LTMuNSAwLTYgMy02IDd2OC4xYzAgLjUtLjIgMS0uNiAxLjQtLjYuNy0xLjcgMS4xLTIuNiAxLjFoLTguNGMtMS4zIDAtMiAuNC0yLjEuNy0uMi40IDAgMS4zLjkgMi40TDYzLjEgOTBjLjkgMS4yIDIuMSAxLjggMy4zIDEuOHMyLjMtLjYgMy4xLTEuN2wxNC44LTE5LjNjLjktMS4xIDEuMS0yIC45LTIuNC0uMi0uMy0uOS0uNy0yLjEtLjdoLTcuNmMtLjkgMC0xLjctLjUtMi4xLTEuMi0uMy0uNC0uNC0uOC0uNC0xLjMgMC0xLjQgMS4xLTIuNSAyLjUtMi41aDcuNmMzLjEgMCA1LjUgMS4zIDYuNiAzLjVsLjMuN2MuNyAyLjEuMSA0LjYtMS43IDYuOXoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=
// @description       《也许同类型中最好用？》系列 - 一个基于 JavaScript 的网盘文件下载地址获取工具，基于【网盘直链下载助手】修改 | 支持 百度网盘/阿里云盘/中国移动云盘/天翼云盘/迅雷云盘/夸克网盘/UC网盘/123云盘 八大网盘 | 开源・自用・去广 | 改界面・添功能・修Bug | 既超越原版，亦是同类中最好用版本！👋
// @description:zh-TW 《也許同類型中最好用？》系列 - 一個基於 JavaScript 的網盤檔案下載地址獲取工具，基於【網盤直鏈下載助手】改編 | 支援 百度網盤/阿里雲盤/中國移動雲盤/天翼雲盤/迅雷雲盤/夸克網盤/UC網盤/123雲盤 八大平台 | 開源・自用・除廣 | 改介面・擴功能・修Bug | 既超越原版，亦是同類中最好用版本！👋
// @description:zh-HK 《也許同類型中最好用？》系列 - 一個基於 JavaScript 的網盤檔案下載地址獲取工具，基於【網盤直鏈下載助手】改編 | 支援 百度網盤/阿里雲盤/中國移動雲盤/天翼雲盤/迅雷雲盤/夸克網盤/UC網盤/123雲盤 八大平台 | 開源・自用・除廣 | 改介面・擴功能・修Bug | 既超越原版，亦是同類中最好用版本！👋
// @license           AGPL-3.0-or-later
// @homepage          https://github.com/hmjz100/LinkSwift/
// @support           https://github.com/hmjz100/LinkSwift/issues
// @supportURL        https://github.com/hmjz100/LinkSwift/issues
// @require           https://unpkg.com/jquery@3.6.0/dist/jquery.min.js
// @require           https://unpkg.com/sweetalert2@11.4.8/dist/sweetalert2.min.js
// @resource SwalLigt https://unpkg.com/sweetalert2@11.4.8/dist/sweetalert2.min.css
// @resource SwalDark https://unpkg.com/@sweetalert2/theme-dark@5.0.26/dark.min.css
// @require           https://unpkg.com/js-md5@0.7.3/build/md5.min.js
// @run-at            document-start
// @match             *://pan.baidu.com/disk/home*
// @match             *://yun.baidu.com/disk/home*
// @match             *://pan.baidu.com/disk/timeline*
// @match             *://yun.baidu.com/disk/timeline*
// @match             *://pan.baidu.com/disk/main*
// @match             *://yun.baidu.com/disk/main*
// @match             *://pan.baidu.com/youth/pan/main*
// @match             *://yun.baidu.com/youth/pan/main*
// @match             *://pan.baidu.com/disk/base*
// @match             *://yun.baidu.com/disk/base*
// @match             *://pan.baidu.com/disk/timeline*
// @match             *://yun.baidu.com/disk/timeline*
// @match             *://pan.baidu.com/pfile/*
// @match             *://yun.baidu.com/pfile/*
// @match             *://pan.baidu.com/s/*
// @match             *://pan.baidu.com/aipan/*
// @match             *://yun.baidu.com/s/*
// @match             *://yun.baidu.com/aipan/*
// @match             *://pan.baidu.com/share/*
// @match             *://yun.baidu.com/share/*
// @match             *://pan.baidu.com/embed/*
// @match             *://yun.baidu.com/embed/*
// @match             *://openapi.baidu.com/*
// @match             *://www.aliyundrive.com/s/*
// @match             *://www.aliyundrive.com/drive*
// @match             *://www.alipan.com/s/*
// @match             *://www.alipan.com/drive*
// @match             *://cloud.189.cn/web/*
// @match             *://pan.xunlei.com/*
// @match             *://pan.quark.cn/*
// @match             *://drive.uc.cn/*
// @match             *://yun.139.com/*
// @match             *://caiyun.139.com/*
// @match             *://*.123pan.com/*
// @match             *://*.123pan.cn/*
// @match             *://*.123684.com/*
// @match             *://*.123865.com/*
// @match             *://*.123952.com/*
// @match             *://*.123912.com/*
// @match             *://*.youxiaohou.com/*
// @connect           baidu.com
// @connect           baidupcs.com
// @connect           aliyundrive.com
// @connect           aliyundrive.net
// @connect           alipan.com
// @connect           alicloudccp.com
// @connect           aliyundrive.cloud
// @connect           189.cn
// @connect           xunlei.com
// @connect           quark.cn
// @connect           uc.cn
// @connect           123pan.com
// @connect           123pan.cn
// @connect           123684.com
// @connect           123865.com
// @connect           123952.com
// @connect           123912.com
// @connect           cjjd19.com
// @connect           localhost
// @connect           *
// @grant             unsafeWindow
// @grant             window.close
// @grant             GM_xmlhttpRequest
// @grant             GM.xmlhttpRequest
// @grant             GM_setClipboard
// @grant             GM_setValue
// @grant             GM_getValue
// @grant             GM_deleteValue
// @grant             GM_openInTab
// @grant             GM_info
// @grant             GM_registerMenuCommand
// @grant             GM_cookie
// @grant             GM_getResourceText
// @compatible	      Chrome
// @compatible	      Edge
// @compatible	      Firefox
// @compatible	      Safari
// @compatible	      Opera
// ==/UserScript==
/**
 * @name LinkSwift
 * @template （改）网盘直链下载助手
 * @author 油小猴
 * @author hmjz100
 * @namespace github.com/hmjz100
 * @description  一个基于 JavaScript 盘的文件下载地址获取工具  
 * 支持 百度网盘/阿里云盘/中国移动云盘/天翼云盘/迅雷云盘/夸克网盘/UC网盘/123云盘 八大网盘
 * @version 1.1.0.1
 * @license AGPL-3.0-or-later
 * @see {@link https://github.com/hmjz100/LinkSwift/ Github 仓库}
 */
(function linkSwift() { 
	// 严格模式，确保代码安全执行
	'use strict';
	// unsafeWindow 检测
	if (typeof unsafeWindow === 'undefined') {
		window.unsafeWindow = window;
	}

	/*
	防止代码因其他原因被执行多次
	代码出自 “Via 轻插件”，作者谷花泰
	*/
	const key = encodeURIComponent('LinkSwift:主代码');
	if (window[key]) return;
	window[key] = true;

	/*
	网盘直链下载助手
	代码改自 “网盘直链下载助手”，作者油小猴
	有增添新代码
	*/
	/* 全局参数 */
	let mount = idontknow("LinkSwift")
	let page = '', selectList = [], shareParams = {}, mode = '', color = '',
		doc = $(document), progress = {}, request = {}, ins = {}, idm = {}, colored = false, replacedElements = new Set(),
		scriptInfo = GM_info.script,
		sauthor = scriptInfo.author,
		sname = scriptInfo.name,
		sversion = (scriptInfo?.version?.toString() || "1.1.0.1"),
		sicon = (scriptInfo?.icon || "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cGF0aCBkPSJNMTAzLjYgMTA3LjRjMy41LTIuMiA4LjktNi4xIDEzLjgtMTIuNXM3LjMtMTIuNSA4LjUtMTYuNWMuNS0xLjcgMi4yLTcuNSAyLjItMTQuNyAwLTEwLjEtMy4zLTI1LjEtMTUuNC0zNi44LTE0LjUtMTQtMzIuMS0xNC4zLTM1LjctMTQuMy04IDAtMTUuNyAxLjktMjIuNiA1LjJDNDQgMjMgMzUuNyAzMS40IDMwLjggNDEuN2MtMS4zIDIuOC00IDQuNy03LjEgNS00IC4zLTcuNSA0LjQtOC45IDkuNi0uNSAxLjktMS42IDMuNS0zLjEgNC43QzQuNCA2Ni44IDAgNzUuNyAwIDg1YzAgNi44IDIuMyAxMy4xIDYuMSAxOC4yIDUuNSA3LjQgMTQuMiAxMi4yIDI0IDEyLjJoNDcuMWM0LjQgMCAxMS0uNSAxOC4zLTMuNSAzLjItMS40IDUuOS0zIDguMS00LjV6IiBmaWxsPSIjQTA5OUYwIi8+PHBhdGggZD0iTTExOS44IDY0LjNjLjEtMTcuMS0xMC40LTI4LTEyLjUtMzAuMUM5NSAyMi4xIDc5LjkgMjEuOCA3Ni45IDIxLjhjLTE3LjYgMC0zMy4zIDEwLjUtMzkuOSAyNi43LS42IDEuMy0xLjggMi4zLTMuNCAyLjNoLS40Yy01LjggMC0xMC42IDQuOC0xMC42IDEwLjd2LjVjMCAxLjQtLjggMi42LTEuOSAzLjNDMTMuNCA2OSA4LjggNzYuOCA4LjggODVjMCAxMi4yIDkuOSAyMi4zIDIyLjIgMjIuM2g0NS4yYzMuNi0uMSAxNy42LS45IDI5LjYtMTIgMi45LTIuOCAxMy45LTEzLjcgMTQtMzF6IiBmaWxsPSIjNTc0QUI4Ii8+PHBhdGggZD0iTTExMC44IDU3LjRsLjIgMy4zYzAgMS4zLTEuMSAyLjQtMi4zIDIuNC0xLjMgMC0yLjMtMS4xLTIuMy0yLjRsLS4xLTIuOHYtLjNjMC0xLjIuOS0yLjIgMi4xLTIuM2guM2MuNyAwIDEuMy4zIDEuNy43LS4yLjEuMy41LjQgMS40em0tMy4zLTEwLjNjMCAxLjItMSAyLjMtMi4yIDIuM2gtLjFjLS44IDAtMS42LS41LTItMS4yLTQuNi04LjMtMTMuMy0xMy41LTIyLjgtMTMuNS0xLjIgMC0yLjMtMS0yLjMtMi4ydi0uMWMwLTEuMiAxLTIuMyAyLjItMi4zaC4xYTMwLjM3IDMwLjM3IDAgMCAxIDE1LjggNC40YzQuNiAyLjggOC40IDYuOCAxMS4xIDExLjUuMS4zLjIuNy4yIDEuMXpNODguMyA3My44TDczLjUgOTMuMmMtMS41IDEuOS0zLjUgMy4xLTUuNyAzLjVoLS4yYy0uNC4xLS44LjEtMS4yLjEtLjYgMC0xLjEtLjEtMS42LS4yLTIuMi0uNC00LjItMS43LTUuNi0zLjVMNDQuMyA3My45Yy0yLTIuNi0yLjUtNS40LTEuNC03LjcuMS0uMS4xLS4yLjItLjIgMS4yLTIgMy41LTMuMiA2LjQtMy4yaDYuNnYtNS43YzAtNi44IDQuNy0xMiAxMC45LTEyIDQuOCAwIDguNSAyLjYgMTAuMyA3LjIuNSAxLjMtLjIgMi43LTEuNSAzLjJzLTIuOC0uMS0zLjMtMS40Yy0xLjEtMi43LTIuOS00LTUuNS00LTMuNSAwLTYgMy02IDd2OC4xYzAgLjUtLjIgMS0uNiAxLjQtLjYuNy0xLjcgMS4xLTIuNiAxLjFoLTguNGMtMS4zIDAtMiAuNC0yLjEuNy0uMi40IDAgMS4zLjkgMi40TDYzLjEgOTBjLjkgMS4yIDIuMSAxLjggMy4zIDEuOHMyLjMtLjYgMy4xLTEuN2wxNC44LTE5LjNjLjktMS4xIDEuMS0yIC45LTIuNC0uMi0uMy0uOS0uNy0yLjEtLjdoLTcuNmMtLjkgMC0xLjctLjUtMi4xLTEuMi0uMy0uNC0uNC0uOC0uNC0xLjMgMC0xLjQgMS4xLTIuNSAyLjUtMi41aDcuNmMzLjEgMCA1LjUgMS4zIDYuNiAzLjVsLjMuN2MuNyAyLjEuMSA0LjYtMS43IDYuOXoiIGZpbGw9IiNmZmYiLz48L3N2Zz4="),
		mhandler = GM_info.scriptHandler,
		mversion = GM_info.version,
		globalDirHandle=undefined,//TODO Blob下载要用，File System Access API下载要用户给个权限
		globalSleep=500, //延时，统一在1个地方修改方便用，可以考虑做个接口给用户修改，做好限制，别让用户做死
		globalSleepRandSeed=100,//延时随机种子，直接在上面的数值上加 
		globalBatchsize=50;//每次处理批次的大小

	/* 设置选项 */
	// Shell类型（用于curl下载）
	let terminalType = {
		wc: "Microsoft Windows 命令提示符",
		wp: "Microsoft Windows PowerShell",
		lt: "Linux 终端",
		ls: "Linux Shell",
		mt: "Apple MacOS 终端",
	};

	// 更换 百度网盘新界面/阿里云盘/迅雷云盘/移动云盘 主题颜色
	let assistantTheme = {
		yes: "更换主题颜色",
		no: "不更换主题颜色"
	};

	/* Sweet Alert 2 */
	// 自定义元素 Class 名（于 showMainDialog() 中）
	let customClass = {
		popup: 'pl-popup',
		header: 'pl-header',
		title: 'pl-title',
		closeButton: 'pl-close',
		content: 'pl-content',
		input: 'pl-input',
		footer: 'pl-footer'
	};

	// 弹窗默认设置
	let swalDefault = {
		heightAuto: false,
		scrollbarPadding: false,
	}

	/**
	 * SweetAlert2 的 Toast 提示框基础配置
	 * @author 油小猴
	 * @author hmjz100
	 * @description 创建一个全局通用的 Toast 提示框实例，支持自动关闭、鼠标悬停暂停、右下角弹出等特性。
	 *
	 * @type {Sweetalert2.Toast}
	 */
	let toast = Swal.mixin({
		toast: true,
		position: 'bottom-end',
		showConfirmButton: false,
		timer: 3500,
		timerProgressBar: true,
		showCloseButton: true,
		didOpen: function (toast) {
			toast.addEventListener('mouseenter', Swal.stopTimer);
			toast.addEventListener('mouseleave', Swal.resumeTimer);
		}
	});

	/**
	 * 消息提示工具类
	 * @author 油小猴
	 * @description 提供统一的提示信息展示方法，基于 SweetAlert2 的 Toast 实现；
	 * 包含 success / error / warning / info / question 等类型。
	 */
	let message = {
		success: function (text) {
			toast.fire({ title: text, icon: 'success' });
		},
		error: function (text) {
			toast.fire({ title: text, icon: 'error' });
		},
		warning: function (text) {
			toast.fire({ title: text, icon: 'warning' });
		},
		info: function (text) {
			toast.fire({ title: text, icon: 'info' });
		},
		question: function (text) {
			toast.fire({ title: text, icon: 'question' });
		}
	};

	/**
	 * 基础配置集合
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	const config = {
		base: {
			num: "865746",
			license: "AGPL3",
			service: {
				account: "https://pic.rmb.bdstatic.com/bjh/8b9e14345b3cdf96aedac2f3971adcb02681.png",
				rpc: "http://d.youxiaohou.com"
			},
			dom: {
				footer: "o(≧▽≦)o 十分感谢您的支持！来给此项目一个 <a href=\"https://github.com/hmjz100/LinkSwift\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Star</a> 吧~",
				button: {
					api: {
						title: "API 下载",
						footer: "适用于 <a href=\"https://www.youxiaohou.com/zh-cn/idm.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">IDM</a>，<a href=\"https://www.youxiaohou.com/zh-cn/ndm.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">NDM</a> 以及浏览器自带下载<br/>o(≧▽≦)o 十分感谢您的支持！来给此项目一个 <a href=\"https://github.com/hmjz100/LinkSwift\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Star</a> 吧~"
					},
					aria: {
						title: "Aria 下载",
						footer: "适用于 <a href=\"https://www.youxiaohou.com/zh-cn/xdown.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">XDown</a> 及 <a href=\"https://www.youxiaohou.com/zh-cn/linux.html#linux-shell\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Linux Shell命令行</a><br/>o(≧▽≦)o 十分感谢您的支持！来给此项目一个 <a href=\"https://github.com/hmjz100/LinkSwift\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Star</a> 吧~"
					},
					rpc: {
						title: "RPC 下载",
						footer: "适用于 <a href=\"https://www.youxiaohou.com/zh-cn/motrix.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Motrix</a>，<a href=\"https://www.youxiaohou.com/download.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Aria2 Tools</a>，<a href=\"https://www.youxiaohou.com/download.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">AriaNgGUI</a><br/>o(≧▽≦)o 十分感谢您的支持！来给此项目一个 <a href=\"https://github.com/hmjz100/LinkSwift\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Star</a> 吧~"
					},
					curl: {
						title: "cURL 下载",
						footer: "适用于 <a href=\"https://www.youxiaohou.com/zh-cn/curl.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Windows，Linux，MacOS 终端</a><br/>o(≧▽≦)o 十分感谢您的支持！来给此项目一个 <a href=\"https://github.com/hmjz100/LinkSwift\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Star</a> 吧~"
					},
					bc: {
						title: "BC 下载",
						footer: "适用于 <a href=\"https://www.youxiaohou.com/zh-cn/bitcomet.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">比特彗星</a><br/>o(≧▽≦)o 十分感谢您的支持！来给此项目一个 <a href=\"https://github.com/hmjz100/LinkSwift\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Star</a> 吧~"
					}
				}
			},
			assistant: {
				message: "请先安装网盘万能助手哦，安装后再刷新本页就好啦",
				link: "https://www.crxsoso.com/addon/detail/mphijdmblaalbakceeadippfkbgfgaaa"
			}
		},
		$baidu: {
			api: {
				ua: {
					downloadLink: "pan.baidu.com"
				},
				getAccessToken: "https://openapi.baidu.com/oauth/2.0/authorize?response_type=token&scope=basic,netdisk&client_id=IlLqBbU3GjQ0t46TRwFateTprHWl39zF&redirect_uri=oob&confirm_login=0",
				getLink:{
					home:"https://pan.baidu.com/rest/2.0/xpan/multimedia?method=filemetas&dlink=1",
					share:""
				},
				getFiles:{
					home:"https://pan.baidu.com/rest/2.0/xpan/file?method=list&showempty=1",
					share:""
				},
				getShareLink: "https://pan.baidu.com/api/sharedownload?channel=chunlei&clienttype=0&web=1&app_id=250528",
				getShareInfo: "https://pan.baidu.com/share/tplconfig?fields=sign,timestamp&channel=chunlei&web=1&app_id=250528&clienttype=0",
				getShareFiles: "https://pan.baidu.com/rest/2.0/xpan/share?method=list&showempty=1"
			},
			mount: {
				home: ".frame-main>div>div>div>div:has(.g-dropdown-button.g-new-create)",
				main: ".wp-s-agile-tool-bar__header",
				share: ".module-share-top-bar .x-button-box .g-dropdown-button.tools-more"
			}
		},
		$aliyun: {
			api: {
				getLink:{
					home:"https://api.aliyundrive.com/v2/file/get_download_url",
					share:"https://api.aliyundrive.com/v2/file/get_share_link_download_url"
				},
				getFiles:{
					home:"https://api.aliyundrive.com/adrive/v3/file/list?jsonmask=next_marker%2Citems(name%2Cfile_id%2Cdrive_id%2Ctype%2Csize%2Ccreated_at%2Cupdated_at%2Ccategory%2Cfile_extension%2Cparent_file_id%2Cmime_type%2Cstarred%2Cthumbnail%2Curl%2Cstreams_info%2Ccontent_hash%2Cuser_tags%2Cuser_meta%2Ctrashed%2Cvideo_media_metadata%2Cvideo_preview_metadata%2Csync_meta%2Csync_device_flag%2Csync_flag%2Cpunish_flag%2Cfrom_share_id)",
					share:"https://api.aliyundrive.com/adrive/v2/file/list_by_share"
				},
			},
			mount: {
				home: "[class^=\"header--\"]>[class^=\"actions--\"]",
				share: "[class^=\"banner--\"]>[class^=\"right--\"]",
				list: "[class^=\"node-list-table-view--\"]",
				grid: "[class^=\"node-list-grid-view--\"]",
				switch: "[class^=\"switch-wrapper--\"]"
			}
		},
		$mcloud: {
			api: {
				getLink:{
					home:"https://personal-kd-njs.yun.139.com/hcy/file/getDownloadUrl",
					share:""
				},
				getFiles:{
					home:"https://personal-kd-njs.yun.139.com/hcy/file/list",
					share:""
				},
			},
			mount: {
				home: ".top_button",
				share: ".top-btns"
			}
		},
		$tcloud: {
			api: {
				getAccessToken: "https://api.cloud.189.cn/open/oauth2/ssoH5.action",
				getLink:{
					home:"https://api.cloud.189.cn/open/file/getFileDownloadUrl.action",
					share:""
				},
				getFiles:{
					home:"https://cloud.189.cn/api/open/file/listFiles.action",
					share:"https://cloud.189.cn/api/open/share/listShareDir.action"
				},
			},
			mount: {
				home: "[class*=\"FileHead_file-head-left\"]",
				share: ".nav-opea"
			}
		},
		$xunlei: {
			api: {
				mirror: [
					"vod0007-h05-vip-lixian.xunlei.com", "vod0008-h05-vip-lixian.xunlei.com", "vod0009-h05-vip-lixian.xunlei.com", "vod0010-h05-vip-lixian.xunlei.com", "vod0011-h05-vip-lixian.xunlei.com", "vod0012-h05-vip-lixian.xunlei.com", "vod0013-h05-vip-lixian.xunlei.com", "vod0014-h05-vip-lixian.xunlei.com", "vod0067-aliyun08-vip-lixian.xunlei.com", "vod0254-aliyun08-vip-lixian.xunlei.com", "vod0255-aliyun08-vip-lixian.xunlei.com", "vod0256-aliyun08-vip-lixian.xunlei.com", "vod0257-aliyun08-vip-lixian.xunlei.com", "vod0258-aliyun08-vip-lixian.xunlei.com", "vod0259-aliyun08-vip-lixian.xunlei.com", "vod0260-aliyun08-vip-lixian.xunlei.com", "vod0261-aliyun08-vip-lixian.xunlei.com", "vod0262-aliyun08-vip-lixian.xunlei.com", "vod0263-aliyun08-vip-lixian.xunlei.com", "vod0264-aliyun08-vip-lixian.xunlei.com", "vod0265-aliyun08-vip-lixian.xunlei.com", "vod0266-aliyun08-vip-lixian.xunlei.com", "vod0267-aliyun08-vip-lixian.xunlei.com", "vod0554-aliyun06-vip-lixian.xunlei.com", "vod0555-aliyun06-vip-lixian.xunlei.com", "vod0556-aliyun06-vip-lixian.xunlei.com", "vod0680-aliyun08-vip-lixian.xunlei.com", "vod0681-aliyun08-vip-lixian.xunlei.com", "vod0682-aliyun08-vip-lixian.xunlei.com", "vod0683-aliyun08-vip-lixian.xunlei.com", "vod0684-aliyun08-vip-lixian.xunlei.com", "vod0685-aliyun08-vip-lixian.xunlei.com", "vod0686-aliyun08-vip-lixian.xunlei.com", "vod0687-aliyun08-vip-lixian.xunlei.com", "vod0688-aliyun08-vip-lixian.xunlei.com", "vod0689-aliyun08-vip-lixian.xunlei.com", "vod0690-aliyun08-vip-lixian.xunlei.com", "vod0724-aliyun08-vip-lixian.xunlei.com", "vod0725-aliyun08-vip-lixian.xunlei.com", "vod0726-aliyun08-vip-lixian.xunlei.com", "vod0727-aliyun08-vip-lixian.xunlei.com", "vod0728-aliyun08-vip-lixian.xunlei.com", "vod0075.aliyun06.vip.lixian.xunlei.com", "vod0076.aliyun06.vip.lixian.xunlei.com", "vod0077.aliyun06.vip.lixian.xunlei.com", "vod0779-aliyun04-vip-lixian.xunlei.com", "vod0078.aliyun06.vip.lixian.xunlei.com", "vod0780-aliyun04-vip-lixian.xunlei.com", "vod0781-aliyun04-vip-lixian.xunlei.com", "vod0079.aliyun06.vip.lixian.xunlei.com", "vod0080.aliyun06.vip.lixian.xunlei.com", "vod0117.aliyun04.vip.lixian.xunlei.com", "vod0118.aliyun04.vip.lixian.xunlei.com", "vod0119.aliyun04.vip.lixian.xunlei.com", "vod1284-aliyun06-vip-lixian.xunlei.com", "vod1285-aliyun06-vip-lixian.xunlei.com", "vod1363-aliyun06-vip-lixian.xunlei.com", "vod1371-aliyun06-vip-lixian.xunlei.com", "vod1372-aliyun06-vip-lixian.xunlei.com", "vod1426-aliyun06-vip-lixian.xunlei.com", "vod1427-aliyun06-vip-lixian.xunlei.com", "vod1428-aliyun06-vip-lixian.xunlei.com", "vod1429-aliyun06-vip-lixian.xunlei.com", "vod1442-aliyun06-vip-lixian.xunlei.com", "vod1443-aliyun06-vip-lixian.xunlei.com", "vod1444-aliyun06-vip-lixian.xunlei.com", "vod1445-aliyun06-vip-lixian.xunlei.com", "vod1446-aliyun06-vip-lixian.xunlei.com", "vod1447-aliyun06-vip-lixian.xunlei.com", "vod1469-aliyun06-vip-lixian.xunlei.com", "vod1470-aliyun06-vip-lixian.xunlei.com", "vod1471-aliyun06-vip-lixian.xunlei.com", "vod1489-aliyun06-vip-lixian.xunlei.com", "vod1490-aliyun06-vip-lixian.xunlei.com", "vod1491-aliyun06-vip-lixian.xunlei.com", "vod1492-aliyun06-vip-lixian.xunlei.com", "vod1493-aliyun06-vip-lixian.xunlei.com", "vod0215.aliyun06.vip.lixian.xunlei.com", "vod0216.aliyun06.vip.lixian.xunlei.com", "vod0217.aliyun06.vip.lixian.xunlei.com", "vod0218.aliyun06.vip.lixian.xunlei.com", "vod0219.aliyun06.vip.lixian.xunlei.com", "vod0220.aliyun06.vip.lixian.xunlei.com", "vod0241.aliyun08.vip.lixian.xunlei.com", "vod0244.aliyun08.vip.lixian.xunlei.com", "vod0251.aliyun08.vip.lixian.xunlei.com", "vod0252.aliyun08.vip.lixian.xunlei.com", "vod0253.aliyun08.vip.lixian.xunlei.com", "vod0254.aliyun08.vip.lixian.xunlei.com", "vod0255.aliyun08.vip.lixian.xunlei.com", "vod0256.aliyun08.vip.lixian.xunlei.com", "vod0257.aliyun08.vip.lixian.xunlei.com", "vod0260.aliyun08.vip.lixian.xunlei.com", "vod0261.aliyun08.vip.lixian.xunlei.com", "vod0262.aliyun08.vip.lixian.xunlei.com", "vod0263.aliyun08.vip.lixian.xunlei.com", "vod0264.aliyun08.vip.lixian.xunlei.com", "vod0265.aliyun08.vip.lixian.xunlei.com", "vod0266.aliyun08.vip.lixian.xunlei.com", "vod0267.aliyun08.vip.lixian.xunlei.com", "vod3379-aliyun04-vip-lixian.xunlei.com", "vod3380-aliyun04-vip-lixian.xunlei.com", "vod3429-aliyun04-vip-lixian.xunlei.com", "vod3458-aliyun04-vip-lixian.xunlei.com", "vod3459-aliyun04-vip-lixian.xunlei.com", "vod3496-aliyun04-vip-lixian.xunlei.com", "vod3497-aliyun04-vip-lixian.xunlei.com", "vod3498-aliyun04-vip-lixian.xunlei.com", "vod3499-aliyun04-vip-lixian.xunlei.com", "vod3500-aliyun04-vip-lixian.xunlei.com", "vod3501-aliyun04-vip-lixian.xunlei.com", "vod3522-aliyun04-vip-lixian.xunlei.com", "vod3523-aliyun04-vip-lixian.xunlei.com", "vod3533-aliyun04-vip-lixian.xunlei.com", "vod3534-aliyun04-vip-lixian.xunlei.com", "vod3535-aliyun04-vip-lixian.xunlei.com", "vod3536-aliyun04-vip-lixian.xunlei.com", "vod3549-aliyun04-vip-lixian.xunlei.com", "vod3550-aliyun04-vip-lixian.xunlei.com", "vod3551-aliyun04-vip-lixian.xunlei.com", "vod3552-aliyun04-vip-lixian.xunlei.com", "vod3553-aliyun04-vip-lixian.xunlei.com", "vod3554-aliyun04-vip-lixian.xunlei.com", "vod3555-aliyun04-vip-lixian.xunlei.com", "vod0551.aliyun06.vip.lixian.xunlei.com", "vod0552.aliyun06.vip.lixian.xunlei.com", "vod0553.aliyun06.vip.lixian.xunlei.com", "vod0554.aliyun06.vip.lixian.xunlei.com", "vod0555.aliyun06.vip.lixian.xunlei.com", "vod0556.aliyun06.vip.lixian.xunlei.com", "vod0686.aliyun08.vip.lixian.xunlei.com", "vod0687.aliyun08.vip.lixian.xunlei.com", "vod0688.aliyun08.vip.lixian.xunlei.com", "vod0689.aliyun08.vip.lixian.xunlei.com", "vod0724.aliyun08.vip.lixian.xunlei.com", "vod0725.aliyun08.vip.lixian.xunlei.com", "vod0726.aliyun08.vip.lixian.xunlei.com", "vod0727.aliyun08.vip.lixian.xunlei.com", "vod0728.aliyun08.vip.lixian.xunlei.com", "vod0759.aliyun04.vip.lixian.xunlei.com", "vod0760.aliyun04.vip.lixian.xunlei.com", "vod0769.aliyun04.vip.lixian.xunlei.com", "vod0770.aliyun04.vip.lixian.xunlei.com", "vod0771.aliyun04.vip.lixian.xunlei.com", "vod0772.aliyun04.vip.lixian.xunlei.com", "vod0773.aliyun04.vip.lixian.xunlei.com", "vod0774.aliyun04.vip.lixian.xunlei.com", "vod0775.aliyun04.vip.lixian.xunlei.com", "vod0776.aliyun04.vip.lixian.xunlei.com", "vod0777.aliyun04.vip.lixian.xunlei.com", "vod0778.aliyun04.vip.lixian.xunlei.com", "vod0779.aliyun04.vip.lixian.xunlei.com", "vod0780.aliyun04.vip.lixian.xunlei.com", "vod0781.aliyun04.vip.lixian.xunlei.com", "vod3522.aliyun04.vip.lixian.xunlei.com", "vod3523.aliyun04.vip.lixian.xunlei.com", "vod3533.aliyun04.vip.lixian.xunlei.com", "vod3535.aliyun04.vip.lixian.xunlei.com", "vod3550.aliyun04.vip.lixian.xunlei.com", "vod3551.aliyun04.vip.lixian.xunlei.com", "vod3552.aliyun04.vip.lixian.xunlei.com", "vod3553.aliyun04.vip.lixian.xunlei.com", "vod3554.aliyun04.vip.lixian.xunlei.com", "vod3555.aliyun04.vip.lixian.xunlei.com"
				],
				getLink:{
					home:"https://api-pan.xunlei.com/drive/v1/files/",
					share:""
				},
				getFiles:{
					home:"https://api-pan.xunlei.com/drive/v1/files?",
					share:"https://api.aliyundrive.com/adrive/v2/file/list_by_share"
				},
			},
			mount: {
				home: "[class^=\"FileMenu__menu--\"]",
				share: "[class^=\"Share__batchActionBox--\"]"
			}
		},
		$quark: {
			api: {
				ua: {
					downloadLink: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) quark-cloud-drive/2.5.20 Chrome/100.0.4896.160 Electron/18.3.5.4-b478491100 Safari/537.36 Channel/pckk_other_ch"
				},
				getLink:{
					home:"https://drive.quark.cn/1/clouddrive/file/download?pr=ucpro&fr=pc",
					share:""
				},
				getFiles:{
					home:"https://drive.quark.cn/1/clouddrive/file/sort?pr=ucpro&fr=pc",
					share:""
				}
			},
			mount: {
				home: ".btn-operate .btn-main",
				share: ".share-btns"
			}
		},
		$uc: {
			api: {
				ua: {
					//TODO 为啥是夸克的？怕你写错改了下
					// downloadLink: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) uc-cloud-drive/2.5.20 Chrome/100.0.4896.160 Electron/18.3.5.4-b478491100 Safari/537.36 Channel/pckk_other_ch"
					downloadLink: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36 Edg/136.0.0.0"
				},
				getLink:{
					home:"https://pc-api.uc.cn/1/clouddrive/file/download?pr=UCBrowser&fr=pc",
					share:""
				},
				getFiles:{
					home:"https://pc-api.uc.cn/1/clouddrive/file/sort",
					share:""
				},
			},
			mount: {
				home: ".btn-operate .btn-main",
				share: ".file-info-share-buttom"
			}
		},
		$123pan: {
			api: {
				getLink:{
					home:"https://www.123pan.com/api/file/download_info",
					share:"https://www.123pan.com/api/share/download/info"
				},
				getFiles:{
					home:"https://www.123pan.com/b/api/file/list/new",
					share:"https://www.123pan.com/b/api/share/get"
				},
			},
			mount: {
				home: "main.ant-layout-content .site-layout-background .homeClass .wenserh",
				share: ".conter .rightInfo .qrcode_btn"
			}
		}
	}

	/**
	 * 基础工具集合
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	let base = {
		/**
		 * 生成 Aria2 下载命令
		 * @author 油小猴
		 * @author hmjz100
		 * @author KanouAo
		 * @description 将链接转换为 Aria2 格式命令，自动处理文件名特殊字符
		 * @param {string} link - 下载链接
		 * @param {string} filename - 文件名
		 * @param {string} path - 下载路径
		 * @param {string} [header] - 自定义请求头参数（可选）
		 * @returns {string} 编码后的 aria2c 命令字符串
		 */
		convertLinkToAria(link, filename, path, header) {
			filename = base.fixFilename(filename);
			return encodeURIComponent(`aria2c "${link}" --out "${path}/${filename}"${header ? (" " + header) : ""}`);
		},

		/**
		 * 生成 BC 协议下载链接
		 * @author 油小猴
		 * @author hmjz100
		 * @description 将链接转换为 BC 协议格式，自动处理 URL 编码
		 * @param {string} link - 下载链接
		 * @param {string} filename - 文件名
		 * @param {string} [header] - 自定义请求头参数（可选）
		 * @returns {string} 编码后的 BC 协议 URL
		 */
		convertLinkToBC(link, filename, header) {
			let bc = `AA/${encodeURIComponent(filename)}/?url=${encodeURIComponent(link)}${header ? ("&" + header) : ""}ZZ`;
			return encodeURIComponent(`bc://http/${base.encodeBase(bc)}`);
		},

		/**
		 * 生成 cURL 下载命令
		 * @author 油小猴
		 * @author hmjz100
		 * @author KanouAo
		 * @description 根据终端类型生成对应 curl 命令，支持断点续传，自动处理文件名特殊字符
		 * @param {string} link - 下载链接
		 * @param {string} filename - 文件名
		 * @param {string} path - 下载路径
		 * @param {string} [header] - 自定义请求头参数（可选）
		 * @returns {string} 编码后的 curl 命令字符串
		 */
		convertLinkToCurl(link, filename,path, header) {
			let terminal = base.getValue('setting_terminal_type');
			filename = base.fixFilename(filename);
			//TODO 用curl命令，如果目录不存在会失败，所以加了创建目录，不知其它操作系统和下载器是否适用
			//TODO 如果有 header 的话，我 win11 会提示'refer' 不是内部或外部命令，也不是可运行的程序，因为我不知道你测试环境，我不敢改。
			switch (terminal){
				case 'wc':
					return encodeURIComponent(`mkdir "${path}" 2>nul & curl -L -C - "${link}" -o "${path}/${filename}"${header ? (" " + header) : ""}`);
				case 'wp':
					return encodeURIComponent(`mkdir "${path}" -Force; curl.exe -L -C - "${link}" -o "${path}/${filename}"${header ? (" " + header) : ""}`);
				case 'lt':
				case 'ls':
				case 'mt'://TODO 我没有苹果电脑，只有armbian(linux)，虽然AI说都通用的，先这样写，你可能要实际测试下
					return encodeURIComponent(`mkdir -p "${path}" >/dev/null; curl -L -C - "${link}" -o "${path}/${filename}"${header ? (" " + header) : ""}`);
				default:
					console.log(`检测不到对应终端 ${terminal}.`);
					break;
			}
		},

		/**
		 * 发送链接到 RPC 下载器
		 * @author 油小猴
		 * @author hmjz100
		 * @author KanouAo
		 * @description RPC 下载必备
		 * @param {string} link - 下载链接
		 * @param {string} filename - 文件名
		 * @param {string} [header] - 自定义请求头参数（可选）
		 * @param {string} path - 下载路径
		 * @returns {Promise<'success'|'fail'>} 发送态结果
		 */
		async sendLinkToRPC(link, filename, path, header) {
			let rpc = {
				domain: base.getValue('setting_rpc_domain'),
				port: base.getValue('setting_rpc_port'),
				path: base.getValue('setting_rpc_path'),
				token: base.getValue('setting_rpc_token'),
				dir: base.getValue('setting_rpc_dir')+path,
			};

			let url = `${rpc.domain}:${rpc.port}${rpc.path}`;
			let rpcData = {
				id: new Date().getTime(),
				jsonrpc: '2.0',
				method: 'aria2.addUri',
				params: [`token:${rpc.token}`, [link], {
					dir: rpc.dir,
					out: filename,
					header
				}]
			};
			try {
				let res = await base.post(url, rpcData, {}, '');
				if (res.result) return 'success';
				return 'fail';
			} catch (e) {
				return 'fail';
			}
		},

		/**
		 * 注册 GreaseMonkey-Compatible-Manager 扩展菜单命令
		 * @author 油小猴
		 * @author hmjz100
		 * @description 包含 "设置"、"美化"、"更新" 和 "调试" 四个功能入口
		 */
		registerMenuCommand() {
			GM_registerMenuCommand('⚙️ 设置', function () {
				base.showSetting();
			});
			GM_registerMenuCommand('🍃️ 美化', function () {
				base.showBeautify();
			});
			GM_registerMenuCommand('📃 更新', function () {
				base.showUpdate();
			});
			GM_registerMenuCommand('🛠️ 调试', function () {
				base.showDebug();
			});
		},

		/**
		 * 取消初始化配置并重置相关存储数据
		 * @author hmjz100
		 * @param {number} [value=111111] - 要设置的错误 `暗号`
		 */
		unRegisterInit(value = 111111) {
			message.warning("正在“注入”设置项目...");
			base.setValue('setting_init_code', value);
			base.setValue('setting_init_license', value);
			base.setValue('baidu_access_token', "");
			if (location.host.includes("baidu")) base.setStorage('baiduyunPlugin_BDUSS', "")
			history.go(0)
		},

		/**
		 * 判断 JavaScript 对象类型
		 * @author 油小猴
		 * @description 通过 Object.prototype.toString 精确识别对象类型
		 * @param {*} obj - 待检测对象
		 * @returns {string} 类型名称（全小写），如：array/number/null/date 等
		 * @example
		 * isType([]) // => "array"
		 * isType(null) // => "null"
		 */
		isType(obj) {
			return Object.prototype.toString.call(obj).replace(/^\[object (.+)\]$/, '$1').toLowerCase();
		},

		/**
		 * 获取 GreaseMonkey-Compatible-Manager 存储的值
		 * @author 油小猴
		 * @param {string} name - 存储键名
		 * @returns {*} 存储的值
		 */
		getValue(name) {
			return GM_getValue(name);
		},

		/**
		 * 设置 GreaseMonkey-Compatible-Manager 存储的值
		 * @author 油小猴
		 * @param {string} name - 存储键名
		 * @param {*} value - 要存储的值
		 */
		setValue(name, value) {
			GM_setValue(name, value);
		},

		/**
		 * 删除 GreaseMonkey-Compatible-Manager 存储的值
		 * @author 油小猴
		 * @param {string} name - 要删除的存储键名
		 */
		deleteValue(name) {
			GM_deleteValue(name);
		},

		/**
		 * 从 localStorage 获取存储值
		 * @description 自动解析 JSON 格式内容
		 * @author 油小猴
		 * @param {string} key - 存储键名
		 * @returns {*} 存储的原始值或解析后的对象
		 */
		getStorage(key) {
			try {
				return JSON.parse(localStorage.getItem(key));
			} catch (e) {
				return localStorage.getItem(key);
			}
		},

		/**
		 * 设置 localStorage 存储值
		 * @author 油小猴
		 * @description 自动 `JSON.stringify` `对象` `数组` 类型的数据
		 * @param {string} key - 存储键名
		 * @param {*} value - 要存储的值
		 */
		setStorage(key, value) {
			if (this.isType(value) === 'object' || this.isType(value) === 'array') {
				return localStorage.setItem(key, JSON.stringify(value));
			}
			return localStorage.setItem(key, value);
		},

		/**
		 * 剪贴板写入
		 * @author 油小猴
		 * @param {string} text - 要复制的文本内容
		 */
		setClipboard(text) {
			GM_setClipboard(text, 'text');
		},

		/**
		 * Base64-URI 编码处理
		 * @author 油小猴
		 * @author hmjz100
		 * @description 自动执行 URI 兼容性编码转换
		 * @param {string} str - 待编码的字符串
		 * @returns {string} Base64 编码结果字符串
		 */
		encodeBase(str) {
			try { str = btoa(str) } catch { }
			return str;
		},

		/**
		 * Base64-URI 解码处理
		 * @author 油小猴
		 * @author hmjz100
		 * @description 自动执行 URI 兼容性解码转换
		 * @param {string} str - Base64 编码字符串
		 * @returns {string} 解码后的原始字符串
		 */
		decodeBase(str) {
			try { str = decodeURIComponent(str) } catch { }
			try { str = atob(str) } catch { }
			try { str = decodeURIComponent(str) } catch { }
			return str;
		},

		/**
		 * 数字补零格式化
		 * @author hmjz100
		 * @description 对 1-9 的数字自动补前导零
		 * @param {number} i - 待格式化的数字
		 * @returns {string} 格式化后的字符串（如"05"）
		 */
		timeFormat(i) {
			if (i >= 0 && i <= 9) {
				return "0" + i;
			} else {
				return i;
			}
		},

		/**
		 * 获取文件扩展名并转为大写
		 * @author 油小猴
		 * @param {string} name - 完整文件名
		 * @returns {string} 大写的文件扩展名（如 `TXT`）
		 */
		getExtension(name) {
			const reg = /(?!\.)\w+$/;
			if (reg.test(name)) {
				let match = name.match(reg);
				return match[0].toUpperCase();
			}
			return '';
		},

		/**
		 * 文件大小格式化
		 * @author hmjz100
		 * @description 自动转换单位到最合适的存储单位（如 `1.2MB`）
		 * @param {number} value - 文件字节大小
		 * @returns {string} 可读格式的大小描述
		 */
		sizeFormat(value) {
			if (value === +value) {
				let unit = ["字节(B)", "千字节(KB)", "兆字节(MB)", "吉字节(GB)", "太字节(TB)", "拍字节(PB)", "艾字节(EB)", "泽字节(ZB)", "尧字节(YB)"];
				if (value === 0) {
					return "0字节(B)";
				} else {
					let index = Math.floor(Math.log(value) / Math.log(1024));
					let size = value / Math.pow(1024, index);
					size = size.toFixed(1);
					return size + unit[index];
				}
			}
			return '';
		},

		/**
		 * 将剩余时间（秒）格式化为可读的时间字符串
		 *
		 * @param {number} remainingTimeSeconds 剩余总秒数（支持小数）
		 * @returns {string} 格式化后的时间字符串，包含以下可能格式：
		 *   - "X天 HH时:MM分:SS秒"（超过1天）
		 *   - "HH时:MM分:SS秒"（超过1小时）
		 *   - "MM分:SS秒"（超过1分钟）
		 *   - "SS秒"（1分钟内）
		 *   - "即将完成"（0秒时）
		 *   - "计算中..."（无效输入时）
		 *
		 * @example
		 * formatRemainingTime(86400) // "1天 00时:00分:00秒"
		 * formatRemainingTime(3661.5) // "01时:01分:01秒"
		 * formatRemainingTime(0) // "即将完成"
		 * formatRemainingTime(-5) // "计算中..."
		 * formatRemainingTime(NaN) // "计算中..."
		 */
		rtimeFormat(remainingTimeSeconds) {
			if (!Number.isFinite(remainingTimeSeconds) || remainingTimeSeconds < 0) {
				return '计算中...';
			}

			let remainingDays = Math.floor(remainingTimeSeconds / (60 * 60 * 24));
			remainingTimeSeconds %= (60 * 60 * 24);

			let remainingHours = Math.floor(remainingTimeSeconds / (60 * 60));
			remainingTimeSeconds %= (60 * 60);

			let remainingMinutes = Math.floor(remainingTimeSeconds / 60);
			let remainingSeconds = Math.floor(remainingTimeSeconds % 60);

			if (remainingDays > 0) {
				return `${remainingDays}天 ${base.timeFormat(remainingHours)}时:${base.timeFormat(remainingMinutes)}分:${base.timeFormat(remainingSeconds)}秒`;
			} else if (remainingHours > 0) {
				return `${base.timeFormat(remainingHours)}时:${base.timeFormat(remainingMinutes)}分:${base.timeFormat(remainingSeconds)}秒`;
			} else if (remainingMinutes > 0) {
				return `${base.timeFormat(remainingMinutes)}分:${base.timeFormat(remainingSeconds)}秒`;
			} else if (remainingSeconds > 0) {
				return `${remainingSeconds}秒`;
			} else {
				return '即将完成';
			}
		},

		/**
		 * 文件列表排序
		 * @author 油小猴
		 * @description 按中文拼音顺序对文件数组进行排序
		 * @param {Array} arr - 包含文件对象的数组
		 * @param {string} arr[].filename - 文件名属性（兼容 server_filename）
		 */
		sortByName(arr) {
			const handle = function () {
				return (a, b) => {
					const p1 = a.filename ? a.filename : a.server_filename;
					const p2 = b.filename ? b.filename : b.server_filename;
					return p1.localeCompare(p2, "zh-CN");
				};
			};
			arr.sort(handle());
		},

		/**
		 * 文件名安全处理
		 * @author 油小猴
		 * @description 替换非法字符为下划线
		 * @param {string} name - 原始文件名
		 * @returns {string} 修正后的安全文件名
		 */
		fixFilename(name) {
			let replace = /[!?&|`"'*\/:<>\\]/g
			return name.replace(replace, '_');
		},

		/**
		 * 获取 Cookie 值
		 * @author 油小猴
		 * @param {string} name - Cookie名称
		 * @returns {string} 对应的 Cookie 值
		 */
		getCookie(name) {
			let cname = name + "=";
			let ca = document.cookie.split(';');
			for (let i = 0; i < ca.length; i++) {
				let c = ca[i].trim();
				if (c.indexOf(cname) == 0) return c.substring(cname.length, c.length);
			}
			return "";
		},

		/**
		 * Blob 文件下载
		 * @author 油小猴
		 * @description 通过创建临时链接实现文件下载
		 * @param {Blob} blob - 要下载的 Blob 对象
		 * @param {string} filename - 下载时提示保存的文件名
		 */
		blobDownload(blob, filename) {
			if (blob instanceof Blob) {
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = filename;
				a.click();
				URL.revokeObjectURL(url);
			}
		},

		
		/**
		 * Blob 文件嵌套文件夹下载
		 * @author KanouAo
		 * @description 通过创建临时链接实现嵌套文件夹下载，windows平台使用File System Access API创建文件夹。该API主要支持Chromium内核浏览器（Chrome/Edge），Firefox和Safari需检测API可用性。
		 * @param {Blob} blob - 要下载的 Blob 对象
		 * @param {string} filename - 下载时提示保存的文件名
		 */
		async fsBlobDownload(blob, filename, path) {
			try {
				if(navigator.userAgent.match(/Chrom(e|ium)/)){//Chromium内核
					// 创建嵌套目录
					async function createNestedDirectory(baseHandle,path) {
						const parts = path.split('/').filter(Boolean);
						let currentHandle = baseHandle;
						for (const part of parts) {
						  currentHandle = await currentHandle.getDirectoryHandle(part, { create: true });
						}
						return currentHandle;
					}
					const folderHandle = await createNestedDirectory(globalDirHandle, path);
					
					// 创建文件并写入
					const fileHandle = await folderHandle.getFileHandle(filename, { create: true });
					const writable = await fileHandle.createWritable();
					await writable.write(blob);
					await writable.close();
					
					return true;
				}else{
					// 降级到基础下载
					this.blobDownload(blob, filename);
					return true;
				}
			} catch (err) {
			  console.error('文件夹操作失败:', err);
			  // 降级到基础下载
			  this.blobDownload(blob, filename);
			  return false;
			}
		  },
		  

		/**
		 * 可跨域 xmlhttpRequest 请求
		 * @author hmjz100
		 * @description 封装 `GreaseMonkey-Compatible_xmlhttpRequest` 实现的跨域请求，与原始函数参数相同
		 * @param {Object} option - 请求配置对象
		 * @returns {XMLHttpRequest} 请求对象实例
		 */
		xmlHttpRequest(option) {
			let request = (typeof GM_xmlhttpRequest !== "undefined") ? GM_xmlhttpRequest : GM.xmlHttpRequest;
			if (request && typeof request === 'function') {
				return request(option);
			}
		},

		/**
		 * 发送 POST 请求
		 * @author 油小猴
		 * @author hmjz100
		 * @description 支持自动重试和数据格式化，内置错误处理，请求数据自动 `JSON.stringify`
		 * @param {string} url - 请求地址
		 * @param {Object|string} data - 请求数据
		 * @param {Object} headers - 请求头配置
		 * @param {string} [type='json'] - 响应类型（支持 `json`, `blob` 等）
		 * @param {number} [maxRetries=3] - 最大重试次数
		 * @param {number} [currentRetry=0] - 已重试次数（内部使用）
		 * @returns {Promise} 包含响应数据的 `Promise` 对象
		 */
		post(url, data, headers, type, maxRetries = 3, currentRetry = 0) {
			if (this.isType(data) === 'object') {
				data = JSON.stringify(data);
			}
			return new Promise((resolve, reject) => {
				const sendRequest = function () {
					base.xmlHttpRequest({
						method: "POST", url, headers, data,
						responseType: type || 'json',
						onloadstart() {
							console.log('【LinkSwift】Post(start)\n请求地址：' + url + '\n请求头部：', headers);
						},
						onload: function (res) {
							// 尝试格式化请求结果以方便调试
							if (res.response) {
								try {
									res.decodedResponse = JSON.parse(res.response);
								} catch (e) { }
								try {
									res.decodedResponse = JSON.parse(base.decodeBase(res.response));
								} catch (e) { }
							}
							if (res.responseText) {
								try {
									res.decodedResponseText = JSON.stringify(JSON.parse(res.responseText));
								} catch (e) { }
								try {
									res.decodedResponseText = JSON.stringify(base.decodeBase(res.responseText));
								} catch (e) { }
							}
							console.log('【LinkSwift】Post(load)\n请求地址：' + url + '\n请求头部：', headers, '\n请求数据：' + JSON.stringify(data) + '\n请求结果：', res);
							type === 'blob' ? resolve(res) : resolve(res.response || res.responseText);
						},
						onerror: function (err) {
							if (currentRetry < maxRetries) {
								currentRetry++;
								console.error(`【LinkSwift】Post(error)\n请求出现错误，可能是网络问题\n5秒后将重试 (错误次数：${currentRetry}/${maxRetries})...`, err);
								setTimeout(function () {
									console.log(`【LinkSwift】Post(error)\n重新尝试请求...`);
									sendRequest(); // 重新发送请求
								}, 5000)
							} else {
								reject('【LinkSwift】Post(error)\n请求出现错误，可能是网络问题\n无法继续请求，达到最大错误次数。', err); // 达到最大重试次数，拒绝 Promise
							}
						},
					});
				};
				sendRequest(); // 初始请求
			});
		},

		/**
		 * 发送 GET 请求
		 * @author 油小猴
		 * @author hmjz100
		 * @author KanouAo
		 * @description 支持进度监控、文件下载和自动重试，可处理被下载工具捕获特殊逻辑
		 * @param {string} url - 请求地址
		 * @param {Object} headers - 请求头配置
		 * @param {string} [type='json'] - 响应类型
		 * @param {Object} [extra] - 附加参数（需包含 `filename` 和 `index` 属性）
		 * @param {number} [maxRetries=3] - 最大重试次数
		 * @param {number} [currentRetry=0] - 已重试次数（内部使用）
		 * @returns {Promise} 包含响应数据的 `Promise` 对象
		 */
		get(url, headers, type, extra, maxRetries = 3, currentRetry = 0) {
			return new Promise((resolve, reject) => {
				const sendRequest = function () {
					let requestObj = base.xmlHttpRequest({
						method: "GET", url, headers,
						responseType: type || 'json',
						onload: function (res) {
							if (res.status === 204) {
								console.log('【LinkSwift】Get(load)\n\x1B[31m该请求已被某个下载工具捕获。' + (res.statusText ? ("\n\x1B[0m工具提示：\x1B[31m" + res.statusText) : "") + '\x1B[0m\n请求地址：' + url + '\n请求头部：', headers, '\n请求结果：', res);
								requestObj.abort();
								idm[extra.index] = true;
								return;
							}
							if (type === 'blob') {
								console.log('【LinkSwift】Get(load) Blob\n请求地址：' + url + '\n请求头部：', headers, '\n请求结果：', res);
								res.status === 200 && base.fsBlobDownload(res.response, extra.filename,extra.path);
								resolve(res);
							} else {
								// 尝试格式化请求结果以方便调试
								if (res.response) {
									try {
										res.decodedResponse = JSON.parse(res.response);
									} catch (e) { }
									try {
										res.decodedResponse = JSON.parse(base.decodeBase(res.response));
									} catch (e) { }
								}
								if (res.responseText) {
									try {
										res.decodedResponseText = JSON.stringify(JSON.parse(res.responseText));
									} catch (e) { }
									try {
										res.decodedResponseText = JSON.stringify(base.decodeBase(res.responseText));
									} catch (e) { }
								}
								console.log('【LinkSwift】Get(load)\n请求地址：' + url + '\n请求头部：', headers, '\n请求结果：', res);
								resolve(res.response || res.responseText);
							}
						},
						onprogress: function (res) {
							if (res.status === 204) {
								console.log('【LinkSwift】Get(progress)\n\x1B[31m该请求已被某个下载工具捕获。' + (res.statusText ? ("\n\x1B[0m工具提示：\x1B[31m" + res.statusText) : "") + '\x1B[0m\n请求地址：' + url + '\n请求头部：', headers, '\n请求结果：', res);
								requestObj.abort();
								idm[extra.index] = true;
								return;
							}
							if (extra && extra.filename && extra.index) {
								res.total > 0 ? progress[extra.index] = (res.loaded * 100 / res.total).toFixed(2) : progress[extra.index] = 0.00;
							}
						},
						onloadstart(res) {
							if (res.status === 204) {
								console.log('【LinkSwift】Get(start)\n\x1B[31m该请求已被某个下载工具捕获。' + (res.statusText ? ("\n\x1B[0m工具提示：\x1B[31m" + res.statusText) : "") + '\x1B[0m\n请求地址：' + url + '\n请求头部：', headers, '\n请求结果：', res);
								requestObj.abort();
								idm[extra.index] = true;
								return;
							}
							console.log('【LinkSwift】Get(start)\n请求地址：' + url + '\n请求头部：', headers);
							if (extra && extra.filename && extra.index) request[extra.index] = requestObj;
						},
						onerror: function (err) {
							if (currentRetry < maxRetries) {
								currentRetry++;
								console.error(`【LinkSwift】Get(error)\n请求出现错误，可能是网络问题\n5秒后将重试 (错误次数：${currentRetry}/${maxRetries})...`, err);
								setTimeout(function () {
									console.log(`【LinkSwift】Get(error)\n重新尝试请求...`);
									sendRequest(); // 重新发送请求
								}, 5000)
							} else {
								reject('【LinkSwift】Get(error)\n请求出现错误，可能是网络问题\n无法继续请求，达到最大错误次数。', err); // 达到最大重试次数，拒绝 Promise
							}
						},
					});
				};

				sendRequest(); // 初始请求
			});
		},

		/**
		 * 获取最终重定向 URL（手动处理 30x 跳转）
		 * @author 油小猴
		 * @author hmjz100
		 * @description 手动追踪 HTTP 30x 重定向，返回最终访问地址
		 * @param {string} url - 初始请求地址
		 * @param {Object} headers - 请求头配置
		 * @param {number} [maxRetries=3] - 最大重试次数
		 * @param {number} [currentRetry=0] - 已重试次数（内部使用）
		 * @returns {Promise<string>} 最终 URL 地址
		 */
		getFinalUrl(url, headers, maxRetries = 3, currentRetry = 0) {
			return new Promise((resolve, reject) => {
				// 防止无限递归跳转
				if (currentRetry >= maxRetries) {
					return reject(new Error(`【LinkSwift】Head(start) FinalUrl\n达到最大重试次数 ${maxRetries}，停止跳转。`));
				}

				base.xmlHttpRequest({
					method: "HEAD",
					url: url,
					headers: headers,
					onloadstart: () => {
						console.log('【LinkSwift】Head(start) FinalUrl\n请求地址：' + url + '\n请求头部：', headers);
					},
					onload: function (res) {
						console.log('【LinkSwift】Head(load) FinalUrl\n请求地址：' + res.finalUrl + '\n响应状态：' + res.status);

						let status = res.status;
						if (status >= 300 && status < 400) {
							base.getFinalUrl(res.finalUrl, headers, maxRetries, currentRetry + 1).then(resolve).catch(reject);
						} else {
							resolve(res.finalUrl);
						}
					},
					onerror: function (err) {
						if (currentRetry < maxRetries) {
							currentRetry++;
							console.error(`【LinkSwift】Head(error) FinalUrl\n请求出现错误，可能是网络问题\n5秒后将重试 (错误次数：${currentRetry}/${maxRetries})...`);
							setTimeout(() => {
								console.log(`【LinkSwift】Head(error) FinalUrl\n重新尝试请求...`);
								base.getFinalUrl(url, headers, maxRetries, currentRetry)
									.then(resolve)
									.catch(reject);
							}, 5000);
						} else {
							reject('【LinkSwift】Get(error) FinalUrl\n请求出现错误，可能是网络问题\n无法继续请求，达到最大错误次数。', err);
						}
					}
				});
			});
		},

		/**
		 * RPC服务测试
		 * @author hmjz100
		 * @description 验证 `JSON-RPC` 接口可用性
		 * @param {string} domain - 服务域名
		 * @param {string} port - 服务端口
		 * @param {string} path - RPC 路径
		 * @param {string} token - 认证令牌
		 * @returns {Promise<'success'|'fail'>} 连接状态结果
		 */
		async rpcTest(domain, port, path, token) {
			return new Promise((resolve, reject) => {
				let rpc = { domain, port, path, token };
				let url = `${rpc.domain}:${rpc.port}${rpc.path}`;
				let rpcData = {
					id: new Date().getTime(),
					jsonrpc: '2.0',
					method: 'system.listMethods',
					params: [`token:${rpc.token}`],
				};
				base.xmlHttpRequest({
					method: "POST", url, headers: {}, data: JSON.stringify(rpcData),
					responseType: 'json',
					onloadstart() {
						console.log('【LinkSwift】Post(start) RPCTest\n请求地址：' + url + '\n请求内容：', rpcData);
					},
					onload: function (res) {
						console.log('【LinkSwift】Post(load) RPCTest\n请求地址：' + url + '\n请求结果：', res);
						if (res.response) {
							resolve("success");
						} else {
							resolve("fail");
						}
					},
					onerror: function (err) {
						console.error('【LinkSwift】Post(error) RPCTest\n请求失败', err);
						resolve("fail");
					},
				});
			});
		},

		/**
		 * 重置请求相关数据
		 * @author 油小猴
		 * @description 中止所有进行中的请求，清除进度记录和定时器
		 */
		_resetAllData() {
			progress = {};
			$.each(request, function (key) {
				(request[key]).abort();
			});
			$.each(ins, function (key) {
				clearInterval(ins[key]);
			});
			idm = {};
			ins = {};
			request = {};
		},

		/**
		 * 重置请求相关数据
		 * @author 油小猴
		 * @description 中止指定的进行中的请求，清除进度记录和定时器
		 */
		_resetData(i) {
			ins[i] && clearInterval(ins[i]);
			request[i] && request[i].abort();
			progress[i] = 0;
			idm[i] = false;
		},

		/**
		 * 将对象转换为 URL 编码字符串
		 * @author 油小猴
		 * @description 递归处理嵌套数组，自动进行 URI 编码
		 * @param {Object} obj - 待转换的键值对对象
		 * @returns {string} URL 编码格式字符串（如`key1=value1&key2=value2`）
		 */
		stringify(obj) {
			let str = '';
			for (let key in obj) {
				if (obj.hasOwnProperty(key)) {
					let value = obj[key];
					if (Array.isArray(value)) {
						for (let i = 0; i < value.length; i++) {
							str += encodeURIComponent(key) + '=' + encodeURIComponent(value[i]) + '&';
						}
					} else {
						str += encodeURIComponent(key) + '=' + encodeURIComponent(value) + '&';
					}
				}
			}
			return str.slice(0, -1); // 去掉末尾的 "&"
		},

		/**
		 * 动态注入样式表
		 * @author 油小猴
		 * @author hmjz100
		 * @description 支持 `样式标签` `外链CSS` 注入，提供精准的 DOM 定位和插入位置控制
		 * @param {string} id - 样式元素 ID
		 * @param {'style'|'link'} tag - 标签类型（`style` 或 `link`）
		 * @param {string} css - CSS 内容或外链 URL
		 * @param {string} [element='.{mount}'] - 定位基准元素选择器
		 * @param {'before'|'after'|'prepend'|'append'} [position='append'] - 插入位置
		 */
		addStyle(id, tag = 'style', css, element = `.${mount}`, position = "append") {
			base.waitForKeyElements(element, (element) => {
				let $styleDom = $(`#${id}`);
				let $style = $(`<${tag}>`, {
					rel: 'stylesheet',
					id: id
				});
				tag === 'style' ? $style.html(css) : $style.attr('href', css);
				if ($styleDom.length) {
					replacedElements.add(id);
					$styleDom.replaceWith($style);
					return true;
				}

				if (position === "before") {
					element.before($style);
				} else if (position === "after") {
					element.after($style);
				} else if (position === "prepend") {
					element.prepend($style);
				} else {
					element.append($style);
				}
				return true;
			}, true);
		},

		/**
		 * 十六进制颜色转 RGBA
		 * @author hmjz100
		 * @description 支持 4 位和 8 位十六进制格式，自动解析透明度通道
		 * @param {string} hex - 十六进制颜色值（如 `#09f` 或 `#0099ffaa` ）
		 * @returns {string} RGBA 格式字符串（如 `15, 170, 255, 0.67`）
		 */
		hexToRgba(hex) {
			// 去掉 # 号
			hex = hex.replace(/^#/, '');
			// 如果是四位十六进制颜色值，转换为八位
			if (hex.length === 4) {
				hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2] + hex[3] + hex[3];
			}
			// 解析 RGB 分量
			let r = parseInt(hex.substring(0, 2), 16);
			let g = parseInt(hex.substring(2, 4), 16);
			let b = parseInt(hex.substring(4, 6), 16);
			let a = '';
			// 如果是八位十六进制颜色值，解析 alpha 通道
			if (hex.length === 8) {
				a = parseInt(hex.substring(6, 8), 16) / 255; // 将 alpha 值转换为 0 到 1 之间的小数
				a = ',' + a
			}
			// 返回 rgba 格式字符串
			return r + ', ' + g + ', ' + b + a;
		},

		/**
		 * RGBA 颜色转十六进制
		 * @author hmjz100
		 * @description 支持透明度转换，自动补全缩写格式
		 * @param {string} rgba - RGBA 格式颜色值（如 `rgba(15,170,255,0.67)`）
		 * @returns {string} 十六进制颜色值（如 `#09aaffaa`）
		 */
		rgbaToHex(rgba) {
			// 去掉前缀 "rgba" 或 "rgb" 并移除空格
			rgba = rgba.replace(/^(rgba?|RGBA?)\(/, '').replace(/\s+/g, '').replace(')', '');

			// 将颜色值分割为数组
			let [r, g, b, a] = rgba.split(',');

			// 将 RGB 转换为十六进制
			r = parseInt(r).toString(16).padStart(2, '0');
			g = parseInt(g).toString(16).padStart(2, '0');
			b = parseInt(b).toString(16).padStart(2, '0');

			// 如果存在 alpha 通道，处理透明度值
			if (a !== undefined) {
				// 将 alpha 转换为 0 到 255 的十六进制
				a = Math.round(parseFloat(a) * 255).toString(16).padStart(2, '0');
				return `#${r}${g}${b}${a}`;
			}

			// 如果没有 alpha 通道，返回标准六位的十六进制颜色
			return `#${r}${g}${b}`;
		},

		/**
		 * 批量替换 CSS 颜色值
		 * @author hmjz100
		 * @description 支持全局样式替换和资源路径修正，处理颜色渐变过渡效果
		 * @param {string} cssText - 原始 CSS 内容
		 * @param {string} baseURI - 资源基础路径
		 * @param {'default'|'other'} type - 替换模式（默认模式包含过渡效果）
		 * @param {Array<Array<string>>} colorMap - 颜色映射表（旧颜色 → 新颜色）
		 * @returns {string} 处理后的 CSS 内容
		 */
		replaceColors(cssText, baseURI, type, colorMap) {
			if (!cssText) return '';
			let colorList = ['#09AAFF', '#cc3235', '#518c17', '#ed944b', '#f969a5', '#bca280', '#574AB8', '#b673ab', '#1d2327', '#18a497', '#637dff', '#0d53ff', '#3181f9', '#f8d800', '#0396ff', '#32ccbc', '#f6416c', '#2271b1', '#59524c', '#ff679a', '#f44236', '#fec107', '#8bc24a', '#2594ed', '#9c28b1']
			colorList.forEach(function (oldColor) {
				cssText = cssText.replace(new RegExp(base.hexToRgba(oldColor), 'ig'), base.hexToRgba(color));
				cssText = cssText.replace(new RegExp(oldColor, 'ig'), color);
			});
			if (type === 'other') {
				// 遍历颜色映射数组，将旧颜色替换为新颜色，并添加过渡效果
				colorMap.forEach(function (colorPair) {
					let oldColor = colorPair[0];
					let newColor = colorPair[1];
					// 判断新颜色是否为 color
					cssText = cssText.replace(new RegExp(oldColor, 'ig'), newColor);
				});
				return cssText;
			}
			if (colorMap) {
				// 遍历颜色映射数组，将旧颜色替换为新颜色，并添加过渡效果
				colorMap.forEach(function (colorPair) {
					let oldColor = colorPair[0];
					let newColor = colorPair[1];
					// 判断新颜色是否为 color
					if (oldColor.includes("#")) {
						cssText = cssText.replace(new RegExp(oldColor + '(.*?)}', 'ig'), newColor + '$1; ' + 'transition: all 0.1s ease;}');
						cssText = cssText.replace(new RegExp(oldColor, 'ig'), newColor);
					} else {
						cssText = cssText.replace(new RegExp(oldColor, 'ig'), newColor);
					}
				});
			};
			if (baseURI) {
				// 替换相对路径资源为绝对路径
				cssText = cssText.replace(/url\(\s*(['"]?)([^'"]*?)\1\s*\)/ig, (match, quote, url) => {
					// 如果 URL 是相对路径，则将其转换为绝对路径
					if (url && !/^(data:|https?:|\/\/)/i.test(url)) {
						try {
							let absoluteURL = new URL(url, baseURI).href;
							return `url(${absoluteURL})`;
						} catch (e) {
							return match;
						}
					}
					return match;
				});
			}
			return cssText;
		},

		/**
		 * 全局主题颜色设置
		 * @author hmjz100
		 * @description 自动遍历并替换 `页面所有样式表` `SVG 元素` 的颜色值
		 * @param {Array<Array<string>>} colorMap - 颜色映射表
		 * @param {'default'|'other'} type - 替换模式
		 */
		setColors(colorMap, type) {
			base.waitForKeyElements(`[id^="${mount}-ColorUI-"]`, function (tag) {
				if (tag.html() === base.replaceColors(tag.text(), '', type, colorMap)) return;
				let cssText = base.replaceColors(tag.text(), '', type, colorMap);
				base.addStyle(tag.attr("id"), 'style', cssText, tag[0]);
				return true;
			}, true)
			let count = 0;
			if (!colored) {
				base.waitForKeyElements('link[rel="stylesheet"]', function (tag) {
					if (!tag.parent().length || !tag.attr('href')) return;
					let href = tag.attr('href');
					try {
						href = new URL(href, location.href).href;
					} catch (e) {
						return;
					}
					fetch(href)
						.then(response => response.text())
						.then(responseText => {
							let id = `${mount}-ColorUI-` + href.replace(/[^\w]/g, "_");
							let cssText = base.replaceColors(responseText, href, type, colorMap);
							if (responseText === base.replaceColors(responseText, '', type, colorMap)) return;
							base.addStyle(id, 'style', cssText, tag[0], "after");
							console.log(`【LinkSwift】UI\n覆盖原始 <link> 样式\n原始：`, tag[0]);
						})
				}, true);
				base.waitForKeyElements(`style:not([id^="${mount}-"],[id^="swal-pub"],[class^="darkreader"])`, function (tag) {
					let id = tag.attr("id");
					let text = tag.html()
					if (tag.data("styles") === text) return;
					tag.data("styles", text);
					// 替换颜色并添加样式
					let cssText = base.replaceColors(text, '', type, colorMap);
					if (text === cssText) return;
					id = id ? id : `${mount}-ColorUI-${count++}`
					base.addStyle(id, 'style', cssText, tag[0], "after");
					console.log(`【LinkSwift】UI\n覆盖原始 <style> 样式\n原始：`, tag[0]);
				}, true)
				base.waitForKeyElements('svg', function (element) {
					element.find('*').each(function () {
						let fill = $(this).attr('fill');
						let stroke = $(this).attr('stroke');
						if (fill) {
							let newFill = base.replaceColors(fill, '', type, colorMap);
							if (newFill !== fill) {
								$(this).attr('fill', newFill);
								console.log(`【LinkSwift】UI\n覆盖 <svg> fill 样式\n原始：`, $(this)[0]);
							}
						}
						if (stroke) {
							let newStroke = base.replaceColors(stroke, '', type, colorMap);
							if (newStroke !== stroke) {
								$(this).attr('stroke', newStroke);
								console.log(`【LinkSwift】UI\n覆盖 <svg> stroke 样式\n原始：`, $(this)[0]);
							}
						}
					});
				}, true);
				colored = true;
			}
		},

		/**
		 * 延时执行
		 * @author 油小猴
		 * @param {number} time - 等待时间（毫秒）
		 * @returns {Promise<void>} 延时完成的 `Promise`
		 */
		sleep(time) {
			return new Promise(resolve => setTimeout(resolve, time));
		},

		/**
		 * 延时执行（随机）
		 * @author KanouAo
		 */
		customSleep(){
			base.sleep(globalSleep+Math.random()*globalSleepRandSeed);
		},

		/**
		 * 判断版本号新旧
		 * @author hmjz100
		 * @description 该函数将版本号按 `.` 分割为数字数组，逐段比较大小。
		 * 若某段 a 的数字大于 b，则 a 更新；
		 * 若所有段均相等，则版本相等（返回 false）。
		 * @param {string} a - 待比较的版本号
		 * @param {string} b - 基准版本号（如 "1.0.9.7"）
		 * @returns {boolean} - 若 a 比 b 更新，返回 true；否则返回 false
		 */
		isNewerVersion(a, b) {
			const partsA = a.split('.').map(Number);
			const partsB = b.split('.').map(Number);
			const maxLength = Math.max(partsA.length, partsB.length);
			for (let i = 0; i < maxLength; i++) {
				const numA = partsA[i] || 0;
				const numB = partsB[i] || 0;

				if (numA > numB) return true;
				if (numA < numB) return false;
			}
			return false;
		},

		/**
		 * 提取版本号主版本
		 * @author 油小猴
		 * @param {string} version - 完整版本号（如 `1.2.3`）
		 * @returns {string|null} 主版本号（如 `1`）或 `null`（格式错误时）
		 */
		getMajorVersion(version) {
			const [major] = (version || '').split('.');
			return /^\d+$/.test(major) ? major : null;
		},

		/**
		 * 查找 React 组件实例
		 * @author 油小猴
		 * @description 支持 Fiber 架构遍历，可指定向上查找层级
		 * @param {HTMLElement} dom - 起始 DOM 元素
		 * @param {number} [traverseUp=0] - 向上遍历层级
		 * @returns {Object|null} React 组件实例或 `null`
		 */
		findReact(dom, traverseUp = 0) {
			const key = Object.keys(dom).find(key => {
				return key.startsWith("__reactFiber$")
					|| key.startsWith("__reactInternalInstance$");
			});
			const domFiber = dom[key];
			if (domFiber == null) return null;

			if (domFiber._currentElement) {
				let compFiber = domFiber._currentElement._owner;
				for (let i = 0; i < traverseUp; i++) {
					compFiber = compFiber._currentElement._owner;
				}
				return compFiber._instance;
			}

			const GetCompFiber = fiber => {
				let parentFiber = fiber.return;
				while (typeof parentFiber.type == "string") {
					parentFiber = parentFiber.return;
				}
				return parentFiber;
			};
			let compFiber = GetCompFiber(domFiber);
			for (let i = 0; i < traverseUp; i++) {
				compFiber = GetCompFiber(compFiber);
			}
			return compFiber.stateNode || compFiber;
		},

		/**
		 * 初始化默认配置
		 * @author 油小猴
		 * @author hmjz100
		 * @description 创建基础配置、主题设置等存储项（仅当不存在时）
		 */
		initDefaultConfig() {
			let value = [
				// RPC 设置
				{
					name: 'setting_rpc_domain',
					value: 'http://localhost'
				}, {
					name: 'setting_rpc_port',
					value: '16800'
				}, {
					name: 'setting_rpc_path',
					value: '/jsonrpc'
				}, {
					name: 'setting_rpc_token',
					value: ''
				}, {
					name: 'setting_rpc_dir',
					value: 'D:\\Downloads\\'
				},
				// 杂项
				{
					name: 'setting_terminal_type',
					value: 'wc'
				}, {
					name: 'setting_theme_color',
					value: '#574AB8'
				}, {
					name: 'setting_init_code',
					value: ''
				}, {
					name: 'setting_init_license',
					value: ''
				}, {
					name: 'setting_init_version',
					value: ''
				},
				// 额外
				{
					name: 'setting_theme_baidu',
					value: 'no'
				}, {
					name: 'setting_theme_ali',
					value: 'no'
				}, {
					name: 'setting_theme_mcloud',
					value: 'no'
				}, {
					name: 'setting_theme_tcloud',
					value: 'no'
				}, {
					name: 'setting_theme_xunlei',
					value: 'no'
				}, {
					name: 'setting_theme_quark',
					value: 'no'
				}, {
					name: 'setting_theme_uc',
					value: 'no'
				}, {
					name: 'setting_theme_123',
					value: 'no'
				}];

			value.forEach(function (v) {
				// 没有对应的项目就添加上项目
				if (!base.getValue(v.name)) base.setValue(v.name, v.value);
			});
		},

		/**
		 * 显示设置界面
		 * @author 油小猴
		 * @author hmjz100
		 * @description 构建包含RPC配置、终端类型等设置项的交互界面
		 * @see {@link https://www.youxiaohou.com/zh-cn/motrix.html#使用指南 RPC 配置说明}、{@link https://www.youxiaohou.com/zh-cn/curl.html cURL 使用教程}
		 */
		showSetting() {
			let dom = ''
			dom += `<div style="text-align: center;">带星号的设置项目将在网页刷新后生效</div>`
			dom += `<label class="pl-setting-label"><div class="pl-label">RPC主机</div><input type="text"  placeholder="主机地址，需带上http(s)://，但不需要写端口与路径" class="swal2-input pl-input listener-rpc-domain" value="${base.getValue('setting_rpc_domain')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">RPC端口</div><input type="text" placeholder="端口号，例如：Motrix下载器为16800" class="swal2-input pl-input listener-rpc-port" value="${base.getValue('setting_rpc_port')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">RPC路径</div><input type="text" placeholder="路径，默认为/jsonrpc" class="swal2-input pl-input listener-rpc-path" value="${base.getValue('setting_rpc_path')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">RPC密钥</div><input type="text" placeholder="无密钥无需填写" class="swal2-input pl-input listener-rpc-token" value="${base.getValue('setting_rpc_token')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">RPC保存</div><input type="text" placeholder="文件下载后保存路径，例如：D:\\Downloads\\" class="swal2-input pl-input listener-rpc-dir" value="${base.getValue('setting_rpc_dir')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">当前RPC</div><div><span id="pl-rpcDomain">${base.getValue('setting_rpc_domain')}</span>:<span id="pl-rpcPort">${base.getValue('setting_rpc_port')}</span><span id="pl-rpcPath">${base.getValue('setting_rpc_path')}</span><button type="button" class="pl-button-mini swal2-confirm swal2-styled listener-rpc-test">测试</button></div></label>`;
			dom += `<label class="pl-setting-label" style="padding-top:0;flex-direction:row-reverse;text-align:right;"><span><a href="https://www.youxiaohou.com/zh-cn/motrix.html#使用指南" target="_blank" class="pl-a" data-no-instant="1">RPC配置说明</a>，适用于 RPC 下载👆</span></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">终端类型</div><select class="swal2-select pl-input listener-terminal">`;
			Object.keys(terminalType).forEach(k => {
				dom += `<option value="${k}" ${base.getValue('setting_terminal_type') === k ? 'selected' : ''}>${terminalType[k]}</option>`;
			});
			dom += `</select></label>`;
			dom += `<label class="pl-setting-label" style="padding-top:0;flex-direction:row-reverse;text-align:right;"><span><a href="https://www.youxiaohou.com/zh-cn/curl.html" target="_blank" class="pl-a" data-no-instant="1">cURL使用教程</a>，适用于 cURL 下载👆</span></label>`;

			dom += `<button type="button" style="margin-top: 30px;" class="pl-button-mini swal2-deny swal2-styled listener-register">熄灭已经点亮的按钮*</button>`

			dom = '<div>' + dom + '</div>';

			Swal.fire({
				title: '助手设置',
				html: dom,
				icon: 'info',
				iconHtml: '⚙︎',
				allowOutsideClick: false,
				showCloseButton: true,
				showConfirmButton: false,
				footer: `<div>&#76;&#105;&#110;&#107;&#83;&#119;&#105;&#102;&#116;&#32;&#30001;&#32;&#104;&#109;&#106;&#122;&#49;&#48;&#48;&#32;&#21046;&#20316;</div><div>${config.base.dom.footer}</div>`,
				...swalDefault
			});
			doc.on('click', '.listener-register', async function (e) {
				base.unRegisterInit();
			});
			doc.on('click', '.listener-rpc-test', async function (e) {
				e.preventDefault();
				let domain = base.getValue('setting_rpc_domain'),
					port = base.getValue('setting_rpc_port'),
					path = base.getValue('setting_rpc_path'),
					token = base.getValue('setting_rpc_token');
				if (e.target.innerHTML !== "测试") return;
				e.target.innerHTML = "等待";
				e.target.style.opacity = 0.9;
				let result = await base.rpcTest(domain, port, path, token);
				if (result === "success") {
					e.target.innerHTML = "成功";
					e.target.style.backgroundColor = "#52c41a";
				} else {
					e.target.innerHTML = "失败";
					e.target.style.backgroundColor = "#cb1616";
				}
				e.target.style.opacity = "";
				setTimeout(function () {
					e.target.innerHTML = "测试";
					e.target.style.backgroundColor = "";
				}, 3000)
			});
			doc.on('input', '.listener-rpc-domain', async function (e) {
				base.setValue('setting_rpc_domain', e.target.value);
				document.getElementById("pl-rpcDomain").innerHTML = e.target.value;
			});
			doc.on('input', '.listener-rpc-port', async function (e) {
				base.setValue('setting_rpc_port', e.target.value);
				document.getElementById("pl-rpcPort").innerHTML = e.target.value;
			});
			doc.on('input', '.listener-rpc-path', async function (e) {
				base.setValue('setting_rpc_path', e.target.value);
				document.getElementById("pl-rpcPath").innerHTML = e.target.value;
			});
			doc.on('input', '.listener-rpc-token', async function (e) {
				base.setValue('setting_rpc_token', e.target.value);
			});
			doc.on('input', '.listener-rpc-dir', async function (e) {
				base.setValue('setting_rpc_dir', e.target.value);
			});
			doc.on('change', '.listener-terminal', async function (e) {
				base.setValue('setting_terminal_type', e.target.value);
			});
		},

		/**
		 * 显示美化设置界面
		 * @author hmjz100
		 * @description 提供主题颜色选择器和各网盘界面美化配置
		 * @fires .listener-color - 主题色选择事件
		 * @fires .listener-theme - 网盘主题配置变更事件
		 */
		showBeautify() {
			let dom = '',
				btn = '',
				colorList = ['#09AAFF', '#cc3235', '#518c17', '#ed944b', '#f969a5', '#bca280', '#b673ab', '#574AB8', '#1d2327', '#18a497', '#637dff', '#0d53ff', '#3181f9', '#f8d800', '#0396ff', '#32ccbc', '#f6416c', '#2271b1', '#59524c', '#ff679a', '#f44236', '#fec107', '#8bc24a', '#2594ed', '#9c28b1'],
				colorNameList = ['度盘<br/>经典蓝', '度盘<br/>平安红', '度盘<br/>盎然绿', '度盘<br/>周年橙', '度盘<br/>幸会粉', '度盘<br/>午后棕', '度盘<br/>物语紫', '度盘<br/>星空紫', 'OpenAI<br/>默认黑', 'OpenAI<br/>默认青', '度里叁<br/>霞光紫', '夸克<br/>极简蓝', '移动<br/>彩云蓝', '果核<br/>柠檬黄', '果核<br/>默认蓝', '果核<br/>碧波绿', '果核<br/>玫瑰红', '文派<br/>默认蓝', '文派<br/>咖啡灰', '哔哩<br/>少女粉', '哔哩<br/>高能红', '哔哩<br/>咸蛋黄', '哔哩<br/>早苗绿', '哔哩<br/>宝石蓝', '哔哩<br/>罗兰紫'];
			dom += `<div style="text-align: center;">带星号的美化项目将在网页刷新后生效</div>`

			colorList.forEach((v, i) => {
				btn += `<div style="background: ${v};border: 1px solid ${v}" class="pl-color-box ${v === base.getValue('setting_theme_color') ? 'listener-color' : 'listener-color'}">
				<div data-color="${v}" class="pl-mask">${colorNameList[i]} ${v === base.getValue('setting_theme_color') ? '<span id="pl-thisColor">(当前)</span>' : ''}</div>
			</div>`;
			});

			dom += `<label class="pl-setting-label"><div class="pl-label">主题颜色</div> <div class="pl-color">${btn}</div></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[百度网盘]<br/>更换界面为主题颜色*</div><select class="swal2-select pl-input listener-theme" data-type="baidu">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_baidu') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;
			dom += `<label class="pl-setting-label" style="padding-top:0;flex-direction:row-reverse;text-align:right;"><span>旧版页面会美化,新版页面则是更换主题色👆</span></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[阿里云盘]<br/>更换界面为主题颜色*</div><select class="swal2-select pl-input listener-theme" data-type="ali">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_ali') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[移动云盘]<br/>更换界面为主题颜色*</div><select class="swal2-select pl-input listener-theme" data-type="mcloud">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_mcloud') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[天翼云盘]<br/>更换界面为主题颜色*</div><select class="swal2-select pl-input listener-theme" data-type="tcloud">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_tcloud') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[迅雷云盘]<br/>更换界面为主题颜色*</div><select class="swal2-select pl-input listener-theme" data-type="xunlei">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_xunlei') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[夸克网盘]<br/>更换界面为主题颜色*</div><select class="swal2-select pl-input listener-theme" data-type="quark">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_quark') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[UC网盘]<br/>更换界面为主题颜色*</div><select class="swal2-select pl-input listener-theme" data-type="uc">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_uc') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[123云盘]<br/>更换界面为主题颜色*</div><select class="swal2-select pl-input listener-theme" data-type="123">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_123') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom = '<div>' + dom + '</div>';

			Swal.fire({
				title: '助手美化',
				html: dom,
				icon: 'success',
				iconHtml: '🍃︎',
				allowOutsideClick: false,
				showCloseButton: true,
				showConfirmButton: false,
				footer: `<div>&#76;&#105;&#110;&#107;&#83;&#119;&#105;&#102;&#116;&#32;&#30001;&#32;&#104;&#109;&#106;&#122;&#49;&#48;&#48;&#32;&#21046;&#20316;</div><div>${config.base.dom.footer}</div>`,
				...swalDefault
			});
			doc.on('click', '.listener-color', async function (e) {
				if (e.target.dataset.color) {
					if (document.getElementById("pl-thisColor")) {
						document.getElementById("pl-thisColor").remove();
					}
					e.target.innerHTML += '<span id="pl-thisColor">(当前)</span>';
					base.setValue('setting_theme_color', e.target.dataset.color);
					base.addPanLinkerStyle();
				}
			});
			doc.on('change', '.listener-theme', async function (e) {
				base.setValue(`setting_theme_${e.target.dataset.type}`, e.target.value);
			});
		},

		/**
		 * 显示调试信息面板
		 * @description 展示脚本运行时环境、版本信息及依赖状态
		 * @author hmjz100
		 * @property {string} manageHandler - 外部管理器名称
		 * @property {string} manageVersion - 外部管理器版本
		 */
		showDebug() {
			let debugInfo = '';
			debugInfo += `<span>以下内容均为脚本自检信息<br/>本页面仅作为调试使用<span>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[外置]<br/>管理器名称</div>${mhandler ? mhandler : "无法获取"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[外置]<br/>管理器版本</div>${mversion ? mversion : "无法获取"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[内置]<br/>脚本名称</div>${sname ? sname : "无法获取"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[内置]<br/>脚本版本</div>${sversion ? sversion : "无法获取"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[内置]<br/>脚本作者</div>${sauthor ? sauthor : "无法获取"}</label>`;

			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[内置]<br/>公众号码</div>${config.base.service.account ? `${config.base.service.account}<img src="${config.base.service.account}"></img>` : "无法获取"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[内置]<br/>Toast页脚</div>${config.base.dom.footer ? config.base.dom.footer : "此网站暂无"}</label>`;


			debugInfo = '<div>' + debugInfo + '</div>';

			Swal.fire({
				icon: 'info',
				title: '调试信息',
				html: debugInfo,
				allowOutsideClick: false,
				showCloseButton: true,
				confirmButtonText: '关闭',
				...swalDefault
			});
		},

		/**
		 * 显示版本更新日志
		 * @author hmjz100
		 * @description 按时间倒序展示所有历史版本更新内容
		 */
		showUpdate() {
			Swal.fire({
				icon: 'info',
				title: '更新日志',
				html: `<div class="version-log">
				<div class="block">
					<blockquote>
						<div>风雨送春归，飞雪迎春到。已是悬崖百丈冰，犹有花枝俏。</div>
						<div>俏也不争春，只把春来报。待到山花烂漫时，她在丛中笑。</div>
					</blockquote>
				</div>
				<div class="block">
					<name>V1.1.0.1</name>
					<div>
					<div>1、修复查看 RPC 下载任务的 Bug。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.1.0</name>
					<div>
					<div>1、支持 UC 网盘、123 云盘；</div>
					<div>2、改进了网盘主题的注入方式；</div>
					<div>3、聚合并重构了部分重复函数，对整体脚本逻辑进行了梳理和精简；</div>
					<div>4、将脚本执行阶段从 document-body 适配为 document-start。</div>
					</div>
				</div>
				<hr/>
				<div class="block">
					<name>V1.0.9.7</name>
					<div>
					<div>1、修复移动云盘下载错误；</div>
					<div>2、优化代码，更好的错误识别；</div>
					<div>3、去除了游小猴云服务。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.9.6</name>
					<div>
					<div>1、支持在百度网盘中选择文件夹下载；</div>
					<div>2、优化部分提示。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.9.5</name>
					<div>
					<div>1、修复因代码逻辑错误而无法获取链接的 Bug。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.9.4</name>
					<div>
					<div>1、修复因百度网盘 AccessToken 过期导致无法获取链接的 Bug。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.9.3</name>
					<div>
					<div>1、若网盘不支持在分享中下载，将仅显示保存网盘按钮；</div>
					<div>2、优化下载界面，支持选择 Iframe 或 Blob 的方式来下载文件，增加按钮的提示文本；</div>
					<div>3、优化 CSS 样式，统一了 SweetAlert2 按钮样式，同时适配了 Dark Reader 插件，界面更协调；</div>
					<div>4、支持修改油小猴网站主题色；</div>
					<div>5、原有主题相关设置现已移动至助手美化页面中。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.9.2</name>
					<div>
					<div>1、修复使用API 下载时有可能会导致IDM无限弹窗的Bug。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.9.1</name>
					<div>
					<div>1、修复在百度网盘旧版下脚本无法删除元素的Bug。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.9</name>
					<div>
					<div>1、跟进官方V6.2.7，修复因无法进行百度授权而导致获取直链报错 9019 的 Bug。</div>
					</div>
				</div>
				<hr/>
				<div class="block">
					<name>V1.0.8.9</name>
					<div>
					<div>1、跟进官方V6.2.3，优化保存到网盘提示，修复阿里云盘、移动云盘失效的问题；</div>
					<div>2、优化修改网盘主题的代码，减少对页面的破坏。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.8.8</name>
					<div>
					<div>1、修复下载菜单字体过小的Bug。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.8.7</name>
					<div>
					<div>1、修复在阿里云盘分享页面下点击“未点亮”按钮时没有任何反应的Bug；</div>
					<div>2、更新并优化网盘界面精简规则；</div>
					<div>3、支持更换 百度网盘、阿里云盘、迅雷云盘、夸克网盘、移动云盘 界面的主题颜色。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.8.6</name>
					<div>
					<div>1、新增移动云盘会员中心页面，可在网盘中点击“会员中心”按钮查看(但无法使用第三方支付)。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.8.5</name>
					<div>
					<div>1、跟进官方V6.1.6，修复迅雷网盘分享页面无法选中文件，修复移动云盘无法判断页面。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.8.4</name>
					<div>
					<div>1、修复因重复绑定按钮而导致命令重复执行的Bug；</div>
					<div>2、优化调试信息界面排版；</div>
					<div>3、移除对百度网盘手机网页版的支持。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.8.3</name>
					<div>
					<div>1、适配阿里云盘新域名alipan.com。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.8.2</name>
					<div>
					<div>1、更换新图标。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.8.1</name>
					<div>
					<div>1、修复因重复绑定按钮而导致RPC 下载会发送多条下载请求的Bug；</div>
					<div>2、选择不使用油小猴服务器时，“用ghproxy连接Github仓库”更换为“用jsdelivr连接Github仓库”；</div>
					<div>3、跟进官方V6.1.4版本，修复移动网盘无法获取链接，支持阿里云盘新域名alipan.com。</div>
					</div>
				</div>
				<hr/>
				<div class="block">
					<name>V1.0.8</name>
					<div>
					<div>1、修复迅雷网盘无法勾选文件。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7.9</name>
					<div>
					<div>1、更新精简网盘元素匹配规则，防止因通知横条而导致不能点到“API 下载”以下的按钮。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7.8</name>
					<div>
					<div>1、跟进官方V6.1.2，加入V2接口。</div>
					<div>2、修复百度网盘下载时因为获取不到accessToken而一直转圈。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7.7</name>
					<div>
					<div>1、修复百度网盘的按钮会因为主题不同而被改变颜色的Bug；</div>
					<div>2、更新夸克网盘按钮与界面。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7.6</name>
					<div>
					<div>1、修复“注入”功能；</div>
					<div>2、黑暗模式支持随设置热切换。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7.5</name>
					<div>
					<div>1、修复阿里云盘下载逻辑；</div>
					<div>2、精简代码；</div>
					<div>3、支持深色模式；</div>
					<div>4、修改部分提示文本；</div>
					<div>5、修改部分CSS；</div>
					<div>6、设置可测试RPC连接。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7.4</name>
					<div>
					<div>1、优化下载逻辑；</div>
					<div>2、修复阿里云盘无法使用API 下载。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7.3</name>
					<div>
					<div>1、如果出现网络请求错误时支持自动重新请求；</div>
					<div>2、可选择是否使用油小猴服务器。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7.2</name>
					<div>
					<div>1、修复使用RPC 下载时会重复发送链接的Bug。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7.1</name>
					<div>
					<div>[实验功能，不影响正常使用]支持百度网盘手机网页版，勾选文件后可在顶栏找到“下载助手”按钮。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.7</name>
					<div>
					<div>1、重构夸克网盘、阿里云盘按钮。</div>
					</div>
				</div>
				<hr/>
				<div class="block">
					<name>V1.0.6.9</name>
					<div>
					<div>1、下载窗口加入关闭按钮。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.6.8</name>
					<div>
					<div>1、修复夸克网盘按钮错位。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.6.7</name>
					<div>
					<div>1、将百度网盘界面修改为主题色，可在设置选择是否修改；</div>
					<div>2、增加主题色名称，更改部分内容颜色；</div>
					<div>3、移动云盘API 下载支持批量复制；</div>
					<div>4、优化控制台输出结果；</div>
					<div>5、百度网盘API 下载不使用IDM时可以显示剩余时间；</div>
					<div>6、“取消点亮按钮”按钮的位置现已移动到设置页面。</div>
					<div>7、homo特有的彩蛋又回来力(喜)。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.6.6</name>
					<div>
					<div>1、修复暗号错误。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.6.5</name>
					<div>
					<div>1、修复即使输入正确暗号也不能成功点亮按钮的服务器错误。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.6.4</name>
					<div>
					<div>1、跟进官方V6.1.1版本，修复阿里云盘获取下载链接时的问题。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.6.3</name>
					<div>
					<div>1、照顾小屏幕用户，将始终显示复制全部链接的按钮；</div>
					<div>2、增加取消下载时的动画。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.6.2</name>
					<div>
					<div>1、修复部分界面错位，实现CSS内置；</div>
					<div>2、百度网盘界面将变得更加简洁。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.6.1</name>
					<div>
					<div>1、新增百度云盘API 下载支持复制链接；</div>
					<div>2、为了照顾手机浏览器用户，增大项目之间间隙，新增隐藏IDM提示选项，可在助手设置中启用；</div>
					<div>3、修改CSS，界面会出现更多的主题色；</div>
					<div>4、支持在游小猴官网查看暗号；</div>
					<div>5、修复部分语法错误。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.6</name>
					<div>
					<div>1、修复了打开阿里云盘分享连接时因下载移动端广告导致只能点击 API 下载；</div>
					<div>2、跟进官方6.0.4版本，修复夸克网盘获取下载链接失效、支持移动云盘。</div>
					</div>
				</div>
				<hr/>
				<div class="block">
					<name>V1.0.5.5</name>
					<div>
					<div>1、感谢<a href="https://github.com/Night-stars-1">Night-stars-1</a>的帮助，修复因为原作者服务器导致的初始化暗号识别错误；</div>
					<div>2、修改一些文本以及提供给服务器的信息。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.5.4</name>
					<div>
					<div>1、小修小改css，让主题色出现在更多地方；</div>
					<div>2、修改下载链接获取失败的提示；</div>
					<div>3、增加更多的主题色，可在助手设置查看；</div>
					<div>4、homo彩蛋被删去力（悲）。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.5.3</name>
					<div>
					<div>1、修啦修啦，阿里云盘可以摸到下载菜单了。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.5.2</name>
					<div>
					<div>1、增加脚本信息菜单（没有用）；</div>
					<div>2、优化阿里云盘显示svg图片；</div>
					<div>3、修改弹窗按钮颜色。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.5.1</name>
					<div>
					<div>1、修复在切换按钮主题后夸克网盘不能正常显示按钮。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.5</name>
					<div>
					<div>1、跟进官方V5.0.4版本；</div>
					<div>2、小改动，照着官方版本更正文件名称检测；</div>
					<div>3、保留彩蛋，但必须舍弃官方暗号。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.4</name>
					<div>
					<div>大改！</div>
					<div>1、修复了原作者留下的夸克网盘切换文件夹就多一个“下载助手”按钮的大BUG；</div>
					<div>2、终于来了，在下载菜单增加“助手设置”“更新日志”按钮；</div>
					<div>【再也不用点进油猴管理再进设置了(保留油猴管理内设置)】</div>
					<div>3、修改阿里云盘和夸克网盘下载助手按钮样式；</div>
					<div>4、增加“取消点亮按钮”油猴菜单；</div>
					<div>5、修改部分css，使其与选择的主题更贴切。</div>
					</div>
				</div>
				<hr/>
				<div class="block">
					<name>V1.0.3</name>
					<div>
					<div>1、增加一个小彩蛋； 提示：</div>
					<div>homo（需在未点亮按钮状态触发）</div>
					<div>【需要重新恢复按钮为未点亮状态请进入 已安装脚本->编辑->开发者->重置到出厂->确定】</div>
					<div>2、修改/增加默认主题色。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.2</name>
					<div>
					<div>1、修改并加宽界面，调整部分css，使Sweetalert2界面更美观，更与原版相近；</div>
					<div>2、修改部分提示文字，使文字更容易复制。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.1</name>
					<div>
					<div>1、去除更新提示；</div>
					<div>2、更新Sweetalert2至11版本；</div>
					<div>3、部分CDN节点更换为jsdelivr。</div>
					</div>
				</div>
				<div class="block">
					<name>V1.0.0</name>
					<div>
					<div>1、增加“注入”功能（bushi）；</div>
					<div>2、去除广告。</div>
					</div>
				</div>
				</div>
				<style>
				div:where(.swal2-container) div:where(.swal2-popup) {
					width: 36em !important;
				}
				.version-log {
					text-align: left;
				}
				.version-log > .block,
				.version-log > hr {
					margin-bottom: 20px;
				}
				.version-log > hr {
					border-style: inset;
					border-width: 1px;
				}
				.version-log .block name {
					display: block;
					margin-bottom: 10px;
					font-size: 1.2em;
				}
				.version-log .block div {
					margin-bottom: 5px;
				}
				.version-log .block blockquote {
					padding: 0.7em;
					border-left: 5px solid #bdbdbd;
					background-color: #f9f9f9;
				}
				@media (prefers-color-scheme: dark) {
					.version-log .block blockquote {
						border-left: 5px solid #7A7C84;
						background-color: #464851;
					}
				}
				</style>`,
				allowOutsideClick: false,
				showCloseButton: true,
				confirmButtonText: '我已阅',
				...swalDefault
			});
		},

		/**
		 * 创建浮动提示框
		 * @description 监听元素悬停事件，动态显示带文件大小的提示框
		 * @author 油小猴
		 * @author hmjz100
		 * @fires .listener-tip - 鼠标移动事件触发提示框定位
		 * @see {@link color} 使用全局主题色渲染文件大小信息
		 */
		createTip() {
			// 添加提示框到 body
			$('html').append('<div class="pl-tooltip"></div>');

			// 监听所有带有 .listener-tip 类的元素的鼠标移动事件
			$(document).on('mousemove', '.listener-tip', function (e) {
				// 获取提示文字
				let tip = e.currentTarget.dataset.title || `${e.currentTarget.innerText} <span style="margin-left: 10px;color: ${color}">${e.currentTarget.dataset.size}</span>`;

				// 设置提示框的位置并使用 fadeIn() 渐变显示
				$('.pl-tooltip').html(tip).css({
					'left': e.pageX + 10 + 'px',
					'top': e.pageY + 20 + 'px' // 增加一些间距
				}).show();
			});

			$(document).on('mouseleave', '.listener-tip, .pl-tooltip', function (e) {
				$('.pl-tooltip').hide();
			});
		},

		/**
		 * 创建加载状态弹窗
		 * @author 油小猴
		 * @description 生成包含旋转动画的加载容器
		 */
		createLoading() {
			return $('<div class="pl-loading"><div class="pl-loading-box"><div><div></div><div></div></div></div></div>');
		},

		/**
		 * 创建用于下载的隐藏 iframe
		 * @author 油小猴
		 * @description 该方法会创建一个隐藏的 iframe 元素，并将其插入到指定的挂载点中，用于后续的下载操作。
		 * iframe 的 src 设置为 "javascript:;" 以避免加载额外资源，提升性能。
		 */
		createDownloadIframe() {
			let iframe = $('<iframe style="padding:0;margin:0;display:block;display:none" src="javascript:;" id="downloadIframe"></iframe>');
			base.waitForKeyElements(`.${mount}`, (element) => {
				element.append(iframe);
			}, true)
		},

		/**
		 * 获取镜像列表
		 * @author 油小猴
		 * @description 根据原始链接和镜像域名列表生成多个镜像链接，支持多线程下载。
		 * 每个镜像地址会根据 thread 参数生成多个重复链接（通过添加 `&` 符号区分）。
		 * @param {string} link - 原始下载链接
		 * @param {Array<string>} mirror - 镜像域名数组
		 * @param {number} [thread=2] - 每个镜像生成的线程数（链接重复次数），默认为 2
		 * @returns {string} 所有镜像链接组成的字符串，每行一个链接
		 *
		 * @example
		 * getMirrorList("https://example.com/file.zip", ["mirror1.com", "mirror2.com"], 2)
		 * // 返回:
		 * // https://mirror1.com/file.zip
		 * // https://mirror1.com/file.zip&
		 * // https://mirror2.com/file.zip
		 * // https://mirror2.com/file.zip&
		 */
		getMirrorList(link, mirror, thread = 2) {
			let host = new URL(link).host;
			let mirrors = [];
			for (let i = 0; i < mirror.length; i++) {
				for (let j = 0; j < thread; j++) {
					let item = link.replace(host, mirror[i]) + '&'.repeat(j);
					mirrors.push(item);
				}
			}
			return mirrors.join('\n');
		},

		/**
		 * 创建基础样式
		 * @author 油小猴
		 * @author hmjz100
		 * @description 为组件添加默认的公共样式，包括浅色和深色模式适配样式。
		 */
		addPanLinkerStyle() {
			color = base.getValue('setting_theme_color');

			base.addStyle('swal-pub-style', 'style', `@media (prefers-color-scheme: light) {${GM_getResourceText('SwalLigt')}}`);
			base.addStyle('swal-pub-dark-style', 'style', `@media (prefers-color-scheme: dark) {${GM_getResourceText('SwalDark')}}`);
			base.addStyle('swal-pub-custom-style', 'style', `
			.swal2-styled{transition: all 0.2s ease;}
			.swal2-loader{display:none;align-items:center;justify-content:center;width:2.2em;height:2.2em;margin:0 1.875em;-webkit-animation:swal2-rotate-loading 1.5s linear 0s infinite normal;animation:swal2-rotate-loading 1.5s linear 0s infinite normal;border-width:.25em;border-style:solid;border-radius:100%;border-color:${color} transparent }
			.swal2-timer-progress-bar-container{position:absolute;right:0;bottom:0;left:0;grid-column:auto;overflow:hidden;border-bottom-right-radius:5px;border-bottom-left-radius:5px}
			.swal2-timer-progress-bar{width:100%;height:.25em;background:${color}33 }
			.swal2-progress-steps .swal2-progress-step{z-index:20;flex-shrink:0;width:2em;height:2em;border-radius:2em;background:${color};color:#fff;line-height:2em;text-align:center}
			.swal2-progress-steps .swal2-progress-step.swal2-active-progress-step{background:${color} }
			.swal2-progress-steps .swal2-progress-step-line{z-index:10;flex-shrink:0;width:2.5em;height:.4em;margin:0 -1px;background:${color}}
			.swal2-html-container {padding:1em 1.6em 0.3em;margin:0}


			.swal2-close,div:where(.swal2-container) button:where(.swal2-close) {position:absolute;top:1px;right:1px;transition: all 0.2s ease}
			.swal2-close:hover,div:where(.swal2-container) button:where(.swal2-close):hover {color:${color};font-size:60px}

			.swal2-styled.swal2-confirm,div:where(.swal2-container) button:where(.swal2-styled):where(.swal2-confirm){background-color:${color};color:#fff}

			.swal2-styled.swal2-confirm:focus,div:where(.swal2-container) button:where(.swal2-styled):where(.swal2-confirm):focus{box-shadow:0 0 0 3px ${color}80}
			.swal2-styled.swal2-deny:focus,.swal2-close:focus,div:where(.swal2-container) button:where(.swal2-styled):where(.swal2-deny):focus{box-shadow:0 0 0 3px #dc374180}
			.swal2-styled.swal2-cancel:focus,div:where(.swal2-container) button:where(.swal2-styled):where(.swal2-cancel):focus{box-shadow:0 0 0 3px #6e788180}

			.swal2-styled.swal2-confirm,
			.swal2-styled.swal2-deny,
			.swal2-styled.swal2-cancel,
			div:where(.swal2-container) button:where(.swal2-styled):where(.swal2-confirm),
			div:where(.swal2-container) button:where(.swal2-styled):where(.swal2-deny),
			div:where(.swal2-container) button:where(.swal2-styled):where(.swal2-cancel)
			{border-radius:50px}
			div:where(.swal2-container) div:where(.swal2-actions):not(.swal2-loading) .swal2-styled:hover{opacity:0.7}

			.swal2-popup,div:where(.swal2-container) div:where(.swal2-popup){padding-bottom:1em;border-radius:10px}
			div:where(.swal2-container) div:where(.swal2-html-container){padding:1.3em 1.3em 0.3em;margin:0}
			.swal2-footer,div:where(.swal2-container) div:where(.swal2-footer){flex-direction:column;justify-content:center;align-items:center}
			div:where(.swal2-icon) .swal2-icon-content {font-family: sans-serif;}

			.swal2-input, .swal2-file, swal2-select, .swal2-textarea,
			div:where(.swal2-container) input:where(.swal2-input),
			div:where(.swal2-container) input:where(.swal2-file),
			div:where(.swal2-container) input:where(.swal2-select),
			div:where(.swal2-container) textarea:where(.swal2-textarea)
			{box-shadow:none}

			.swal2-input:focus, .swal2-file:focus, .swal2-select:focus, .swal2-textarea:focus,
			.swal2-input:focus-visible, .swal2-file:focus-visible, .swal2-select:focus-visible, .swal2-textarea:focus-visible,
			div:where(.swal2-container) input:where(.swal2-input):focus,
			div:where(.swal2-container) input:where(.swal2-input):focus-visible,
			div:where(.swal2-container) input:where(.swal2-file):focus,
			div:where(.swal2-container) input:where(.swal2-file):focus-visible,
			div:where(.swal2-container) input:where(.swal2-select):focus,
			div:where(.swal2-container) input:where(.swal2-select):focus-visible,
			div:where(.swal2-container) textarea:where(.swal2-textarea):focus,
			div:where(.swal2-container) textarea:where(.swal2-textarea):focus-visible
			{outline:0;border:1px solid ${color};box-shadow:0 0 0 3px ${color}80}
			
			.swal2-checkbox, .swal2-file, .swal2-input, .swal2-radio, .swal2-select, .swal2-textarea,
			div:where(.swal2-container) input:where(.swal2-input), div:where(.swal2-container) input:where(.swal2-file), div:where(.swal2-container) textarea:where(.swal2-textarea), div:where(.swal2-container) select:where(.swal2-select), div:where(.swal2-container) div:where(.swal2-radio), div:where(.swal2-container) label:where(.swal2-checkbox)
			{margin: 1em 2em}`);
			base.addStyle(`${mount}-main-style`, 'style', `
			::-webkit-scrollbar{width:8px;height:8px;transition:all 0.2s ease}
			::-webkit-scrollbar-track{border-radius:10px;background:#fff}
			::-webkit-scrollbar-thumb,::-webkit-scrollbar-thumb:hover{border-radius:10px}
			::-webkit-scrollbar-thumb{background-color:${color}90 !important}
			::-webkit-scrollbar-thumb:hover{background-color:${color}D0 !important}
			.swal2-popup{font-size:16px}
			.pl-a{vertical-align:baseline;color:${color}}
			.pl-a:hover{color:${color}90}
			.pl-popup{font-size:12px;min-width:70%;max-width:95%}
			.pl-popup a:not(.pl-btn-primary){color:${color}}
			.pl-popup a:hover:not(.pl-btn-primary){color:${color}90}
			.pl-header{padding:0;align-items:flex-start;border-bottom:1px solid #eee;margin:0 0 10px;padding:0 0 5px}
			.pl-title{font-size:18px;white-space:nowrap;text-overflow:ellipsis}
			.pl-content{padding:0;font-size:12px}
			.pl-main{background-color:${color}15;overflow:auto;border-radius:10px;max-height:calc(${document.documentElement.clientHeight}px - 250px)}
			.pl-footer{font-size:15px;text-align:center;display:block}
			.pl-item{display:flex;align-items:center;background-color:${color}30;border-radius:5px;margin:8px 6px}
			.pl-item-name{flex:0 0 170px;text-align:left;margin:6px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;cursor:default;height:30px}
			.pl-item-link{flex:1;text-align:left;white-space:nowrap;text-overflow:ellipsis;cursor:pointer;overflow:hidden}
			.pl-item-tip{display:flex;justify-content:space-between;flex:1}
			.pl-ext{display:inline-block;width:44px;background:#999;color:#fff;height:16px;line-height:16px;font-size:12px;border-radius:3px}
			.pl-retry{padding:3px 10px;background:#cc3235;color:#fff;border-radius:3px;cursor:pointer}
			.pl-item-progress{display:flex;flex:1;align-items:center}
			.pl-progress{display:inline-block;vertical-align:middle;width:100%;box-sizing:border-box;line-height:1;position:relative;height:20px;margin:0 6px;flex:1}
			.pl-progress-outer{height:20px;border-radius:100px;background-color:#c1c1c1a1;overflow:hidden;position:relative;vertical-align:middle}
			.pl-progress-inner{position:absolute;left:0;top:0;background-color:${color};border-radius:100px;line-height:1;white-space:nowrap;transition:width .6s ease;height:20px;display:inline-flex;text-align:center;align-items:center}
			.pl-progress-inner-text{display:inline-block;vertical-align:middle;cursor:default;color:#ffffff;font-size:12px;margin:0 5px;height:20px;width:100%}
			.pl-progress-inner-text:after{display:inline-block;content:"";height:100%;vertical-align:middle}
			.pl-extra{margin-top:10px;background-color:${color}15;border-radius:10px;display:flex}
			.pl-extra button{flex:1}
			.pl-btn-primary{background:${color};border:0;border-radius:50px;color:#ffffff;cursor:pointer;font-size:12px;outline:none;display:flex;align-items:center;justify-content:center;margin:6px 6px;padding:0.625em 1.1em;transition:0.3s opacity}
			.pl-btn-primary:hover{opacity:0.8;transition:0.3s opacity}
			.pl-btn-primary:focus{box-shadow:0 0 0 3px ${color}80}
			.pl-btn-success{background:#55af28}
			.pl-btn-success:focus{box-shadow:0 0 0 3px #55af2880}
			.pl-btn-info{background:#606266}
			.pl-btn-info:focus{box-shadow:0 0 0 3px #60626680}
			.pl-btn-warning{background:#da9328}
			.pl-btn-warning:focus{box-shadow:0 0 0 3px #da932880}
			.pl-btn-danger{background:#cc3235}
			.pl-btn-danger:focus{box-shadow:0 0 0 3px #cc323580}
			@keyframes easeOpacity { from {opacity: 1} 50% {opacity: 0.35} to {opacity: 1} }
			.pl-btn-opacity{animation:easeOpacity 1.2s 2;animation-fill-mode:forwards}
			.pl-button-mini{padding:5px 10px}
			.pl-dropdown-menu-item{height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:${color};transition:all 0.2s ease}
			.pl-dropdown-menu-item:hover{background-color:${color}15}
			.pl-button-mode{padding:0px;padding-left:0px !important;color:${color}!important;cursor:pointer;;transition:all 0.2s ease}
			.pl-button-mode:hover{background-color:${color}33 !important}
			.g-button-menu.pl-button-mode{padding:0px !important}
			.pl-button,.pl-dropdown-menu{transition:all 0.2s ease}
			.pl-button{position:relative}
			.pl-button .pl-dropdown-menu{opacity:0;pointer-events:none}
			.pl-button:hover .pl-dropdown-menu{opacity:1;pointer-events:auto}
			@keyframes easeInitOpacity { from {opacity: 0.5} 50% {opacity: 1} to {opacity: 0.5} }
			.pl-button-init{opacity:0.5;animation:easeInitOpacity 1.2s 5;animation-fill-mode:forwards}

			header[style="display:none;"]~.pl-button{display:inline-block;position:fixed;top:0.6em;left:65%;z-index:99999}
			.baidu-button{background:${color}!important;border-color:${color}!important;border:1px solid ${color}!important;display:inline-flex}
			.baidu-button:hover{background:${color}b0 !important;border-color:${color}!important}
			.ali-button{background:${color};border:0 solid transparent;font-size:14px;margin-left:20px;padding:8px 16px;position:relative;height:32px;border-radius:100px;display:flex;align-items:center;justify-content:center;color:var(--basic_white);cursor:pointer;transition:all .3s ease}
			.ali-button:hover{background:${color}D0}
			.ali-btn-icon{vertical-align:-0.2em}
			.tcloud-button{color:#fff;border:1px solid ${color};background:${color};position:relative;height:30px;padding:0 12px;margin-right:12px;font-size:12px;line-height:28px;cursor:pointer}
			.tcloud-button:hover{border-color:${color}b0;background:${color}b0}
			.mcloud-button{float:left;position:relative;margin:20px 24px 20px 0;width:110px;height:36px;background:${color};border-radius:2px;font-size:14px;color:#fff;line-height:39px;text-align:center;cursor:pointer}
			.mcloud-share-button{display:inline-block;position:relative;font-size:14px;line-height:36px;height:36px;text-align:center;color:#fff;border:1px solid ${color};border-radius:2px;padding:0 24px;background:${color}}
			.mcloud-share-button:hover{background:${color}b0}
			.mcloud-button:hover{background:${color}b0}
			.mcloud-btn{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAGNQTFRFAAAA////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////mkUNoAAAACF0Uk5TAAbHPP9AMRtr9PwrV8zqXfmNgDODHTLD4iJxhGJJ8Z269m0aDgAAAMZJREFUeJzd0ssOgyAQBVDUK74rWq0PFP3/ryxqTMdGqJtuvGHD5CTDTGDs3nFc17kEPcC7BH3At/Tjvk5AYbBU+NcrwghL4uQDk3gtRSF1KWCCQEpghkd+3jp/ICNQoDANU0AQCJQmWAJ3h8+q3mFdvSywQdttsGvRWGAPLReoHXrbG6WWAzBoJ+3DaCnWI39NLbcvszvLeuTB2fYoqbNBNo7sGjzk31BhMsEJitxmiKk8zSQwE8gFjBGcNuCzOmdqPrib5A2JRQ7qK9g+hQAAAABJRU5ErkJggg==");height:20px;line-height:20px;display:inline-block;background-repeat:no-repeat;background-size:20px 20px;text-indent:25px}
			.xunlei-button{display:inline-flex;align-items:center;justify-content:center;border:0 solid transparent;border-radius:5px;box-shadow:0 0 0 0 transparent;width:fit-content;white-space:nowrap;flex-shrink:0;font-size:14px;line-height:1.5;outline:0;touch-action:manipulation;transition:background .3s ease,color .3s ease,border .3s ease,box-shadow .3s ease;color:#fff;background:${color};margin-left:12px;padding:0px 12px;position:relative;cursor:pointer;height:36px}
			.xunlei-button:hover{background:${color}b0}
			.quark-button,.uc-button{padding:0 14px;background:${color}!important;background-color:${color}!important}
			.uc-button{padding:10px 20px!important}
			.quark-button:hover,.uc-button:hover{background:${color}b0 !important;background-color:${color}b0 !important}
			.quark-btn-icon,.uc-btn-icon{width:20px;height:20px;vertical-align:-0.3em}

			.pointer{cursor:pointer}
			.pl-setting-label{display:flex;align-items:center;justify-content:space-between;padding-top:10px}
			.pl-label{flex:0 0 100px;text-align:left}
			.pl-input{flex:1;padding:8px 10px!important;border:1px solid #c2c2c2;border-radius:5px;font-size:14px!important;min-width:300px;margin:0;}
			.init-input{width:90%;text-align:center;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",sans-serif;font-weight:300}
			.pl-color{flex:1;display:flex;flex-wrap:wrap}
			.pl-color-box{width:55px;height:55px;margin:10px 10px 0 0;box-sizing:border-box;border:1px solid #fff;cursor:pointer}
			.pl-mask{width:53px;height:53px;opacity:0;transition:opacity 0.3s;color:#fff;font-size:13px;display:flex;align-items:center;justify-content:center;flex-direction:column}
			.pl-color-box:hover .pl-mask{opacity:1}
			.pl-close:focus{outline:0;box-shadow:none}
			.tag-danger{color:#cc3235;margin:0 5px}
			.pl-tooltip{position:absolute;color:#ffffff;max-width:600px;font-size:12px;padding:5px 10px;background:#333;border-radius:5px;z-index:110000;line-height:1.3;display:none;word-break:break-all}
			.pl-loading-box>div>div{position:absolute;border-radius:50%}
			.pl-loading-box>div>div:nth-child(1){top:9px;left:9px;width:82px;height:82px;background:#ffffff}
			@keyframes load{ 0% {transform: rotate(0deg)} 100% {transform: rotate(360deg)} }
			.pl-loading-box>div>div:nth-child(2){top:14px;left:38px;width:25px;height:25px;background:#666666;animation:load 1s linear infinite;transform-origin:12px 36px}
			.pl-loading{width:16px;height:16px;display:inline-block;overflow:hidden;background:none}
			.pl-loading-box{width:100%;height:100%;position:relative;transform:translateZ(0) scale(0.16);backface-visibility:hidden;transform-origin:0 0}
			.pl-loading-box div{box-sizing:content-box}
			.pl-dropdown-menu{position:absolute;padding:5px 0;color:${color};background:#fff;z-index:999;width:110px;border-radius:5px;box-shadow:0 1px 6px ${color}33;-webkit-box-shadow:0 1px 6px ${color}33;text-align:center;border:none;transition:all 0.2s ease}
			@media (prefers-color-scheme: dark) { .pl-dropdown-menu{background:#19191a;} }
			.pl-button-save{background-color:${color}!important;color:#fff !important}
			.pl-button-save:hover{background-color:${color}D0 !important;color:#fff !important}
			.swal2-container{z-index:100000}
			body.swal2-height-auto{height:inherit}
			svg.icon-rpc-devices{width:13px;height:13px}
			[class^="swal2-"],[class*="pl-btn"]{transition:all 0.3s ease}

			/* 适配（改）百度网盘会员青春版 */
			a.downloadSubtitle, button.downloadSubtitle{transition:all 0.3s ease;background-color:${color}}
			a.downloadSubtitle:hover, button.downloadSubtitle:hover{background-color:${color}D0}
			a.downloadSubtitle:disabled, button.downloadSubtitle:disabled {background-color: ${color}D0}

			/* RGB! */
			@keyframes RGB{ 0% {filter: hue-rotate()} to {filter: hue-rotate(-360deg)} }

			/* Webkit, Opera, IE9, Chrome*/
			::selection, ::-webkit-selection, ::-moz-selection, ::-ms-selection,::-edge-selection {background-color:${color}!important;background:${color}!important;color:white!important;}
			`);

			if (/(pan|yun).baidu.com/.test(location.host) && location.pathname !== '/disk/home' && base.getValue('setting_theme_baidu') === 'yes') {
				base.setColors([
					['#717fff', color],
					['#717FFF', color],
					['#06a8ff', color],
					['#06A8FF', color],
					['#06a7ff', color],
					['#06A7FF', color],
					['#dcdfe6', color],
					['#DCDFE6', color],
					['#0095ff', color],
					['#0095FF', color],
					['#09aaff', color],
					['#09AAFF', color],
					['#0ca6ff', color],
					['#0CA6FF', color],
					['#5040ff', color],
					['#5040FF', color],
					['#454d5a', color],
					['#454D5A', color],
					['#a2abbd', color],
					['#A2ABBD', color],
					['#030b1a', color],
					['#030B1A', color],
					['#afb3bf', color],
					['#AFB3BF', color],
					['#ff436a', color],
					['#FF436A', color],
					['#03081a', color],
					['#03081A', color],
					['#2974b6', color],
					['#2974B6', color],
					['#0596e6', color],
					['#0596E6', color],

					['#C3EAFF', color],
					['#c0d9fe', `${color}50`],
					['#0098EA', `${color}D0`],

					['#38b9ff', `${color}D0`],
					['#38B9FF', `${color}D0`],
					['#42d8ff', `${color}D0`],
					['#42D8FF', `${color}D0`],
					['#a48dff', `${color}D0`],
					['#A48DFF', `${color}D0`],
					['#6b79f2', `${color}D0`],
					['#6B79F2', `${color}D0`],

					['#9c86f2', `${color}90`],
					['#9C86F2', `${color}90`],
					['#83d3ff', `${color}90`],
					['#83D3FF', `${color}90`],
					['#C4D8F4', `${color}90`],

					['#fafafc', `${color}20`],
					['#FAFAFC', `${color}20`],
					['#f5fbff', `${color}20`],
					['#F5FBFF', `${color}20`],
					['#b4e5ff', `${color}20`],
					['#B4E5FF', `${color}20`],
					['#f0faff', `${color}20`],
					['#F0FAFF', `${color}20`],
					['#c4d8f4', `${color}20`],

					['#f1f3f8', `${color}15`],
					['#F1F3F8', `${color}15`],

					['#f2faff', `${color}10`],
					['#F2FAFF', `${color}10`],
					['#eef9fe', `${color}10`],
					['#EEF9FE', `${color}10`],
					['#f7f9fc', `${color}10`],
					['#F7F9FC', `${color}10`],
					['#f5f6fa', `${color}10`],
					['#F5F6FA', `${color}10`],
					['#b4e5ff', `${color}10`],
					['#B4E5FF', `${color}10`],
					['#e6f6ff', `${color}10`],
					['#E6F6FF', `${color}10`],

					['0,149,255', base.hexToRgba(color)],
					['30, 175, 255', base.hexToRgba(color)],
					['6, 167, 255, 0.1', base.hexToRgba(`${color}1a`)],
					['6,167,255,.1', base.hexToRgba(`${color}1a`)],
					['6,167,255,.23', base.hexToRgba(`${color}3b`)],
					['164,141,255,.2', base.hexToRgba(`${color}30`)],
					['196,182,255,.2', base.hexToRgba(`${color}20`)],
					['113,127,255,.2', base.hexToRgba(`${color}40`)],
					['3,8,26,.6', base.hexToRgba(`${color}D0`)],
					['255,32,102,.4', base.hexToRgba(`${color}66`)],
					['72,166,248,.7', base.hexToRgba(`${color}66`)],
				]);
			};
			if (/(pan|yun).baidu.com/.test(location.host) && base.getValue('setting_theme_baidu') === 'yes') {
				base.addStyle(`${mount}-baidu`, 'style', `
				#layoutMain,
				.DxdbeCb {
					border-radius: 10px;
					border-bottom-left-radius: 0;
					border-bottom-right-radius: 0;
					background: #ffffffA0 !important
				}
				.KPDwCE,
				.DxdbeCb .OFaPaO .tanwePYr,
				.xGLMIab .fufHyA:hover,
				.module-search-timeline .form-box {
					background: #ffffffA0 !important;
				}
				.KPDwCE .JDeHdxb,
				.NHcGw .AuPKyz,
				.xGLMIab .tvPMvPb,
				.xGLMIab .FcQMwt,
				.cazEfA .yfHIsP,
				.hscjZ4QL .bbxnZ0Bq .ehnyLxWZ span,
				.module-topToolBar,
				.module-timeline-view .timeline-title-curday {
					background: transparent !important;
					border-bottom: 0;
				}
				.MdLxwM {
					background :#fff !important;
				}
				.aside-absolute-container {
					position: absolute !important;
				}
				.aside-absolute-container .QGOvsxb .remainingSpaceUi_span {
					background: #8af248 !important;
					border-radius: 10px 0 0 10px;
					border-right: #fff 1px solid;
					border-bottom: #fff 1px solid;
				}
				.xtJbHcb .CDaavKb .KQcHyA {
					background: rgb(244,207,0) !important;
					padding: 8px 15px;
				}
				.xtJbHcb .web-header-nav-new-version-inner {
					background: ${color} !important;
					padding: 8px 15px;
					line-height: 15px;
					width: auto;
					height: auto;
				}
				a {
					transition: all 0.2s ease !important;
				}
				#bd-main .bd-left {
					margin: auto !important;
				}
				.verify-input input {
					padding-left: 0 !important;
					text-align: center !important;
				}
				.verify-input input:focus {
					border: 2px solid ${color} !important;
				}
				[data-theme=light] .vp-video-page-card .vp-video-page-card__video-detail {
					color: #030b1a;
				}
				dt.level-1 {
					background: #fd6d65 !important;
				}
				dt.level-2 {
					background: #f3a723 !important;
				}
				dt.level-1 i.desc-arrow {
					border-bottom: 10px solid #dd6966 !important;
				}
				dt.level-2 i.desc-arrow {
					border-bottom: 10px solid #d29633 !important;
				}
				`, `.${mount}`);
				base.setColors([
					['#717fff', color],
					['#717FFF', color],
					['#06a8ff', color],
					['#06A8FF', color],
					['#06a7ff', color],
					['#06A7FF', color],
					['#dcdfe6', color],
					['#DCDFE6', color],
					['#0095ff', color],
					['#0095FF', color],
					['#09aaff', color],
					['#09AAFF', color],
					['#0ca6ff', color],
					['#0CA6FF', color],
					['#5040ff', color],
					['#5040FF', color],
					['#454d5a', color],
					['#454D5A', color],
					['#a2abbd', color],
					['#A2ABBD', color],
					['#030b1a', color],
					['#030B1A', color],
					['#afb3bf', color],
					['#AFB3BF', color],
					['#ff436a', color],
					['#FF436A', color],
					['#03081a', color],
					['#03081A', color],
					['#2974b6', color],
					['#2974B6', color],
					['#0596e6', color],
					['#0596E6', color],

					['#C3EAFF', color],
					['#c0d9fe', `${color}50`],
					['#0098EA', `${color}D0`],

					['#38b9ff', `${color}D0`],
					['#38B9FF', `${color}D0`],
					['#42d8ff', `${color}D0`],
					['#42D8FF', `${color}D0`],
					['#a48dff', `${color}D0`],
					['#A48DFF', `${color}D0`],
					['#6b79f2', `${color}D0`],
					['#6B79F2', `${color}D0`],

					['#9c86f2', `${color}90`],
					['#9C86F2', `${color}90`],
					['#83d3ff', `${color}90`],
					['#83D3FF', `${color}90`],
					['#C4D8F4', `${color}90`],

					['#fafafc', `${color}20`],
					['#FAFAFC', `${color}20`],
					['#f5fbff', `${color}20`],
					['#F5FBFF', `${color}20`],
					['#b4e5ff', `${color}20`],
					['#B4E5FF', `${color}20`],
					['#f0faff', `${color}20`],
					['#F0FAFF', `${color}20`],
					['#c4d8f4', `${color}20`],

					['#f1f3f8', `${color}15`],
					['#F1F3F8', `${color}15`],

					['#f2faff', `${color}10`],
					['#F2FAFF', `${color}10`],
					['#eef9fe', `${color}10`],
					['#EEF9FE', `${color}10`],
					['#f7f9fc', `${color}10`],
					['#F7F9FC', `${color}10`],
					['#f5f6fa', `${color}10`],
					['#F5F6FA', `${color}10`],
					['#b4e5ff', `${color}10`],
					['#B4E5FF', `${color}10`],
					['#e6f6ff', `${color}10`],
					['#E6F6FF', `${color}10`],

					['0,149,255', base.hexToRgba(color)],
					['30, 175, 255', base.hexToRgba(color)],
					['6, 167, 255, 0.1', base.hexToRgba(`${color}1a`)],
					['6,167,255,.1', base.hexToRgba(`${color}1a`)],
					['6,167,255,.23', base.hexToRgba(`${color}3b`)],
					['164,141,255,.2', base.hexToRgba(`${color}30`)],
					['196,182,255,.2', base.hexToRgba(`${color}20`)],
					['113,127,255,.2', base.hexToRgba(`${color}40`)],
					['3,8,26,.6', base.hexToRgba(`${color}D0`)],
					['255,32,102,.4', base.hexToRgba(`${color}66`)],
					['72,166,248,.7', base.hexToRgba(`${color}66`)],
				], "other");
			};
			if (/www.(aliyundrive|alipan).com/.test(location.host) && base.getValue('setting_theme_ali') === 'yes') {
				base.setColors([
					['#3763ff', color],
					['#8664ff', `${color}D0`],
					['99, 125, 255', base.hexToRgba(color)],
					['132, 133, 141', base.hexToRgba(color)],
					['112, 136, 255', base.hexToRgba(color)],
					['97, 122, 250', base.hexToRgba(color)],
					['68, 109, 255', base.hexToRgba(color)],
					['82, 110, 250', base.hexToRgba(`${color}20`)],
					['122, 144, 255', base.hexToRgba(`${color}D0`)],
					['138, 157, 255', base.hexToRgba(`${color}D0`)],
					//['49, 49, 54', base.hexToRgba(color)],
				]);
			};
			if (/(yun|caiyun).139.com/.test(location.host) && base.getValue('setting_theme_mcloud') === 'yes') {
				base.setColors([
					['#3181f9', color],
					['#5a9afa', color],
					['#98c0fc', `${color}D0`],
					['#2d76e5', `${color}D0`],
					['49,129,249,.08', base.hexToRgba(`${color}20`)],
				]);
			};
			if (/cloud.189.cn/.test(location.host) && base.getValue('setting_theme_tcloud') === 'yes') {
				base.setColors([
					['#2b89ea', color],
					['#1874d3', `${color}F0`],
					['#1890ff', color],
					['#388fc9', color],
					['#0087ff', color],
					['#255697', color],
					['#3ea6ff', `${color}80`],
					['#1d52f2', color],
					['#3699ff', `${color}D0`],
					['#f4f9fe', `${color}10`],
					['#eaf5ff', `${color}20`],
				], "other");
			}
			if (/pan.xunlei.com/.test(location.host) && base.getValue('setting_theme_xunlei') === 'yes') {
				base.setColors([
					['#3f85ff', color],
					['63,133,255,.1', base.hexToRgba(`${color}20`)],
					['#2670ea', `${color}D0`],
					['#619bff', `${color}D0`],
					['#ecf3ff', `${color}10`],
					['#f6faff', `${color}10`],
					['#1a2845', `${color}20`],
					['#0f2035', `${color}20`],
					['#308bfd', `${color}20`],
					['#eee', `${color}20`],
				], "other");
				base.addStyle(`${mount}-xunlei`, 'style', `
					.web-header {
						background: linear-gradient(0deg,${color}D0,${color})
					}
				`);
			};
			if (/pan.quark.cn/.test(location.host) && base.getValue('setting_theme_quark') === 'yes') {
				base.setColors([
					['#0d53ff', color],
					['#e6f1ff', `${color}20`],
					['#f0faff', `${color}20`],
					['#7da3ff', `${color}D0`],
					['#ddd', `${color}D0`],
					['17,17,17,.9', base.hexToRgba(`${color}D0`)],
					['40,40,255,.04', base.hexToRgba(`${color}20`)],
					['#f7f7ff', 'transparent'],
					['238,247,255,0', base.hexToRgba(`${color}00`)],
				]);
				base.addStyle(`${mount}-quark`, 'style', `
				.file-list .hover-oper .hover-transparent-bg {
					background: transparent !important;
				}
				.ant-checkbox-wrapper .ant-checkbox-checked .ant-checkbox-inner,
				.ant-checkbox-wrapper .ant-checkbox-indeterminate .ant-checkbox-inner:after {
					background-color: ${color}!important;
				}
				`);
			};
			if (/drive.uc.cn/.test(location.host) && base.getValue('setting_theme_uc') === 'yes') {
				base.setColors([
					['#12161a', color],
					['#e6f1ff', `${color}20`],
					['#f0faff', `${color}20`],
					['#7da3ff', `${color}D0`],
					['#ddd', `${color}D0`],
					['17,17,17,.9', base.hexToRgba(`${color}D0`)],
					['40,40,255,.04', base.hexToRgba(`${color}20`)],
					['#f7f7ff', 'transparent'],
					['238,247,255,0', base.hexToRgba(`${color}00`)],
				]);
				base.addStyle(`${mount}-uc`, 'style', `
				.file-list .hover-oper .hover-transparent-bg {
					background: transparent !important;
				}
				`);
			};
			if (/www.(123(pan|684|865|952|912).com|123pan.cn)/.test(location.host) && base.getValue('setting_theme_123') === 'yes') {
				base.setColors([
					['#597dfc', color],
					['#5a7cfc', color],
					['#2A82E4', color],
					['#51a1f0', color],
					['#597DFC', color],
					['#40a9ff', color],
					['#3c80ff', color],
					['#3C80FF', color],
					['#1890ff', color],
					['#f0f9ff', `${color}20`],
					['#F2F5FF', `${color}20`],
					['#325cf0', `${color}D0`],
					['60, 128, 255', base.hexToRgba(color)],
					['42, 130, 228', base.hexToRgba(color)],
				]);
			}
			if (/.*.youxiaohou.com/.test(location.host)) {
				base.setColors([
					['#00aefe', color],
					['#4e6e8e', color],
					['#009fe8', color],
					['#008fd1', color],
					['#05b0ff', `${color}D0`],
				], "other");
				base.addStyle(`${mount}-youxiaohou`, 'style', `
					a[aria-label="View source on GitHub"] svg[style^="fill"] {
						fill: ${color} !important;
					}
				`);
			};
		},

		/**
		 * 初始化引导弹窗
		 * @author 油小猴
		 * @author hmjz100
		 * @description 显示初始化对话框，引导用户进行配置或跳过流程。
		 * 支持输入特定数字触发彩蛋，并自动注入默认设置点亮功能。
		 * @returns {Promise<void>} 弹窗关闭后返回空值，可能触发页面刷新
		 */
		async initDialog() {
			let dialog = await Swal.fire({
				title: `请阅读完以下全文再继续`,
				allowOutsideClick: false,
				showCloseButton: true,
				showDenyButton: true,
				confirmButtonText: '确认',
				denyButtonText: '懒得输入...我要直接点亮！',
				html: `
				<div style="display:flex;flex-direction:column;align-items:center">
					${config.base.service.account ? `<img style="width: 250px;margin-bottom: 10px;" src="${config.base.service.account}">` : ``}
					<input class="swal2-input init-input" id="init" type="text" placeholder="输入内容..."></div>
					<div><span>你心想道: “没什么可以输入的”</span>
				</div>
				<div>↓</div>
				<div>但你不知道的是...</div>
				<div>你可以直接按下下方的<span style="color:red;font-style:italic;vertical-align:unset;">红色按钮</span>来跳过这一有趣的流程</div>
				<div>或者继续流程,输入某些<span style="font-style:italic;vertical-align:unset;">恶臭的数字</span>查看彩蛋并点亮</div>
				<div>↓</div>
				<div><a target="_blank" href="https://www.youxiaohou.com" style="vertical-align:unset;">原作者</a>开发很辛苦,所以请有能力的你请支持下他的公众号</div>
				<div>又或者...来给这个改版点个<a href="https://github.com/hmjz100/LinkSwift/" style="vertical-align:unset;">Star</a>？</div>
				<div>点亮后不仅能精简网盘界面 还能改变众多网盘主题色哦!</div>
				`,
				...swalDefault
			});
			if (dialog.isDenied) {
				console.log("【LinkSwift】\n正在“注入”点亮按钮设置项目...");
				message.warning("正在“注入”设置项目...");
				await base.sleep(2500);
				base.setValue('setting_init_code', config.base.num);
				base.setValue('setting_init_license', config.base.license);
				message.success("“注入”成功了!");
				await base.sleep(1500);
				location.reload();
			};
			if (dialog.isConfirmed) {
				if ($('#init').val() === '114514' || $('#init').val() === '1919810' || $('#init').val() === '1145141919810') {
					await Swal.fire({
						icon: 'error',
						title: '1145141919810',
						html: '<span>homo特有的数字当然不行啦<br/>哼哼哼啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊啊</span>',
						timer: 4000,
						imageUrl: 'https://pic1.zhimg.com/v2-1b97a088e156c015108dec663bba8b04.avis',
						allowOutsideClick: false,
						timerProgressBar: true,
						showConfirmButton: false,
						showDenyButton: true,
						denyButtonText: '哼哼哼啊啊啊啊啊啊啊啊啊啊',
						...swalDefault
					});
					message.info("成就：你触发了一个homo特有的彩蛋！");
					await base.sleep(4000)
					Swal.fire({
						title: '1145141919810',
						text: 'homo特有的数字当然不行啦...吗？',
						icon: 'question',
						imageUrl: 'https://lh1.hetaousercontent.com/img/7d4c1c0b4adb0e95.jpg',
						showConfirmButton: false,
						allowOutsideClick: false,
						...swalDefault
					});
					await base.sleep(3000)
					base.setValue('setting_init_code', config.base.num);
					base.setValue('setting_init_license', config.base.license);
					message.success("成就：哼哼哼啊啊啊啊啊啊啊啊地注入成功(喜)");
					await base.sleep(1500)
					location.reload();
				} else {
					console.log("【LinkSwift】\n暗号错误")
					await this.initDialog();
					return;
				};
			}
		},

		/**
		 * 显示主对话框
		 * @author 油小猴
		 * @author hmjz100
		 * @description 使用 SweetAlert2 显示一个自定义样式的对话框，用于展示信息或操作提示。
		 * @param {string} title - 对话框标题
		 * @param {string} html - 对话框内容的 HTML 字符串
		 * @param {string} footer - 对话框底部说明文字
		 */
		showMainDialog(title, html, footer) {
			Swal.fire({
				title,
				html,
				footer: `<span>${footer}</span>`,
				customClass,
				confirmButtonText: '关闭',
				showCloseButton: true,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				willClose: function () {
					base._resetAllData();
				},
				...swalDefault
			}).then(function () {
				base._resetAllData();
			});
		},
		/**
		 * 等待指定元素加载完成并执行回调
		 * @author hmjz100
		 * @description 监听 DOM 元素是否出现，若未出现则每隔一段时间重试，直到找到为止。
		 * 支持在 iframe 内部查找元素，适用于异步加载场景。
		 * @param {string} selectorElem - 要等待的目标元素选择器
		 * @param {Function} actionFunction - 找到元素后执行的回调函数，接收 jQuery 元素作为参数，返回 true 可以不再继续寻找
		 * @param {boolean} [bWaitOnce=false] - 是否只执行一次回调，默认为 false，如果不设置为 true 的话需要自行判断是否对元素进行操作
		 * @param {string} [iframeSelector] - 若目标元素位于 iframe 中，传入 iframe 的选择器
		 * @param {string} [controlKey] - 控制唯一性的键名，用于避免重复处理
		 */
		waitForKeyElements(selectorElem, actionFunction, bWaitOnce, iframeSelector, controlKey) {
			if (!this.waitForKeyElements.controlObj) {
				this.waitForKeyElements.controlObj = {};
			}
			if (!this.waitForKeyElements.instanceCounter) {
				this.waitForKeyElements.instanceCounter = 0;
			}

			let targetNodes;
			if (typeof iframeSelector === "undefined") {
				targetNodes = $(selectorElem);
			} else {
				targetNodes = $(iframeSelector).contents().find(selectorElem);
			}

			let controlKeyNew = controlKey || `wkfe_${this.waitForKeyElements.instanceCounter++}`;
			let btargetsFound = false;
			if (targetNodes && targetNodes.length > 0) {
				targetNodes.each(function () {
					let jThis = $(this);
					let alreadyFound = jThis.data(controlKeyNew) || false;

					if (!alreadyFound) {
						var cancelFound = actionFunction(jThis);
						if (cancelFound) {
							btargetsFound = true;
						} else if (bWaitOnce) {
							jThis.data(controlKeyNew, true);
						}
					}
				});
			}

			let controlObj = this.waitForKeyElements.controlObj;
			let timeControl = controlObj[controlKeyNew];

			if (btargetsFound && bWaitOnce && timeControl) {
				clearInterval(timeControl);
				delete controlObj[controlKeyNew];
			} else if (!timeControl) {
				timeControl = setInterval(() => {
					this.waitForKeyElements(selectorElem, actionFunction, bWaitOnce, iframeSelector, controlKeyNew);
				}, 1000);
				controlObj[controlKeyNew] = timeControl;
			}

			this.waitForKeyElements.controlObj = controlObj;
		},
	};

	/**
	 * 百度网盘
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	let $baidu = {
		cnt:0,//计数器，用于控制随机延迟
		fileCount:0,//文件计数
		accessToken:"",

		_getExtra() {
			let seKey = decodeURIComponent(base.getCookie('BDCLND'));
			return '{' + '"sekey":"' + seKey + '"' + "}";
		},

		_getSurl() {
			let reg = /(?<=s\/|surl=)([a-zA-Z0-9_-]+)/g;
			if (reg.test(location.href)) {
				return location.href.match(reg)[0];
			}
			return '';
		},

		setBDUSS(custom) {
			if (custom) {
				base.setStorage("baiduyunPlugin_BDUSS", { BDUSS: custom });
				return;
			}
			try {
				GM_cookie('list', { name: 'BDUSS' }, (cookies, error) => {
					if (!error) {
						let BDUSS = cookies?.[0]?.value;
						if (BDUSS) {
							base.setStorage("baiduyunPlugin_BDUSS", { BDUSS });
						}
					} else {
						throw new Error(error)
					}
				});
			} catch (e) {
				console.error("【LinkSwift】\nsetBDUSS\n错误信息：", e)
				try {
					let BDUSS = document.cookie.match(/BDUSS=(.*?)(;|$)/);
					if (!!BDUSS || BDUSS === null) throw new Error("document.cookie dosen't had cookie")
					base.setStorage("baiduyunPlugin_BDUSS", { BDUSS: BDUSS });
				} catch (e) {
					console.error("【LinkSwift】\nsetBDUSS\n错误信息：", e)
				}
			}
		},

		getBDUSS() {
			doc.find('.loading-popup .loading-title').html(`凭证获取中`);
			doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取当前账号凭证~</div>`);
			let baiduyunPlugin_BDUSS = base.getStorage('baiduyunPlugin_BDUSS') ? base.getStorage('baiduyunPlugin_BDUSS') : { BDUSS: '' };
			return baiduyunPlugin_BDUSS.BDUSS || '';
		},

		async getToken() {
			try {
				doc.find('.loading-popup .loading-title').html(`令牌获取中`);
				doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取授权状态~</div>`);

				// 获取授权状态
				let authorize = await base.getFinalUrl(config.$baidu.api.getAccessToken);

				// 判断授权情况
				if (authorize.includes('authorize')) {
					// 没授权，先获取授权的页面
					doc.find('.loading-popup .loading-title').html(`授权获取中`);
					doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取授权页面~</div>`);

					let html = await base.get(config.$baidu.api.getAccessToken, {}, 'text');

					// 提取页面的发送确认授权的参数
					let bdstoken = html.match(/name="bdstoken"\s+value="([^"]+)"/)?.[1];
					let client_id = html.match(/name="client_id"\s+value="([^"]+)"/)?.[1];
					let data = {
						grant_permissions_arr: 'netdisk',
						bdstoken: bdstoken,
						client_id: client_id,
						response_type: "token",
						display: "page",
						grant_permissions: "basic,netdisk"
					};

					doc.find('.loading-popup .loading-title').html(`授权获取中`);
					doc.find('.loading-popup .swal2-html-container').html(`<div>正在自动确认授权~</div>`);
					// 发送请求达到自动进行授权
					await base.post(config.$baidu.api.getAccessToken, base.stringify(data), {
						'Content-Type': 'application/x-www-form-urlencoded',
					});

					// 再次获取授权状态
					let res2 = await base.getFinalUrl(config.$baidu.api.getAccessToken);
					let accessToken = res2.match(/access_token=([^&]+)/)?.[1];
					if (!!accessToken) {
						doc.find('.loading-popup .loading-title').html(`令牌获取中`);
						doc.find('.loading-popup .swal2-html-container').html(`<div>授权成功，令牌已缓存~</div>`);
						base.setValue('baidu_access_token', accessToken);
						return accessToken;
					} else {
						doc.find('.loading-popup .loading-title').html(`令牌获取中`);
						doc.find('.loading-popup .swal2-html-container').html(`<div>授权失败，等待下一步操作~</div>`);
						return '';
					}
				} else if (authorize.includes('access_token=')) {
					let accessToken = authorize.match(/access_token=([^&]+)/)?.[1];
					if (!!accessToken) {
						doc.find('.loading-popup .loading-title').html(`令牌获取中`);
						doc.find('.loading-popup .swal2-html-container').html(`<div>授权成功，令牌已缓存~</div>`);
						base.setValue('baidu_access_token', accessToken);
						return accessToken;
					} else {
						doc.find('.loading-popup .loading-title').html(`令牌获取中`);
						doc.find('.loading-popup .swal2-html-container').html(`<div>授权失败，等待下一步操作~</div>`);
						return '';
					}
				} else {
					return '';
				}
			} catch (error) {
				return '';
			}
		},

		addPageListener() {
			/*
			防止代码因其他原因被执行多次
			这段代码出自 Via轻插件，作者谷花泰
			*/
			const key = encodeURIComponent('LinkSwift:百度网盘');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, back, stop, target,
				};
			}

			doc.on('mouseenter mouseleave click', '.pl-button.g-dropdown-button', function (e) {
				if (e.type === 'mouseleave') {
					$(e.currentTarget).removeClass('button-open');
				} else {
					$(e.currentTarget).addClass('button-open');
					$(e.currentTarget).find('.pl-dropdown-menu').show();
				}
			});
			doc.on('mouseleave', '.pl-button.g-dropdown-button .pl-dropdown-menu', function (e) {
				$(e.currentTarget).hide();
			});

			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				$baidu.getLink();
			});
			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				selectList = $baidu.getSelectedList();
				if (selectList.length === 0) {
					return message.error('提示：<br/>请勾选要保存到网盘的文件哦~');
				}
				message.info('提示：<br/>因网盘限制，请保存到自己网盘后再去下载哦~');
				await base.sleep(500);
				document.querySelector('.tools-share-save-hb').click();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();

				const o = _factory(e);
				const $width = o.item.find('.pl-progress-inner');
				const $text = o.item.find('.pl-progress-inner-text');
				const filename = o.link[0].dataset.filename;
				const path=o.link[0].dataset.path;
				const index = o.link[0].dataset.index;
				const size = Number(o.link[0].dataset.size) || 0;

				base._resetData(index);
				base.get(o.link[0].dataset.link, { "User-Agent": config.$baidu.api.ua.downloadLink }, 'blob', { filename, index, path});

				let startTime = Date.now();
				let prevLoaded = 0;
				let prevTime = startTime;

				ins[index] = setInterval(async function () {
					const prog = +progress[index] || 0;
					const isIDM = !!idm[index];

					if (isIDM) {
						// IDM 捕获处理逻辑
						o.tip.hide();
						o.progress.hide();
						o.copy.show();
						o.directLink.show();
						o.link
							.text('链接已被IDM捕获~请查看IDM下载窗口哦!')
							.animate({ opacity: '0.5' }, "slow")
							.show();

						clearInterval(ins[index]);
						await base.sleep(2000);
						o.link.text('增强下载(基于浏览器文件流)').animate({ opacity: '1' }, "slow");
						idm[index] = false;
						return;
					}

					const currentTime = Date.now();
					const elapsedTime = currentTime - startTime;
					const loaded = prog * size / 100;
					const timeDiff = Math.max(currentTime - prevTime, 1); // 避免除零
					const speed = ((loaded - prevLoaded) / (timeDiff / 1000)) || 0;

					// 计算剩余时间（保护除零）
					const totalProgress = Math.max(prog / 100, 0.01);
					const totalElapsedSeconds = elapsedTime / 1000;
					const estTotalTime = totalElapsedSeconds / totalProgress;
					const remainingTime = estTotalTime - totalElapsedSeconds;

					// 更新界面状态
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// 更新进度条
					$width.css('width', `${prog}%`);
					$text.text(`${prog.toFixed(1)}% | 速度:${base.sizeFormat(speed)} | 剩余:${base.rtimeFormat(remainingTime)}`);

					// 更新历史值
					prevLoaded = loaded;
					prevTime = currentTime;

					// 下载完成
					if (prog >= 100) {
						await base.sleep(1000);
						clearInterval(ins[index]);
						progress[index] = 0;
						o.item.find('.pl-progress-stop').hide();
						$text.text('下载完成~ 浏览器下载框应该弹出来了哦~');
						o.back.show();
						await base.sleep(3000);
						o.link.text('增强下载(基于浏览器文件流)').animate({ opacity: '1' }, "slow");
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('正在取消...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all',async function (e) {
				if(navigator.userAgent.match(/Chrom(e|ium)/)){//Chromium内核
					globalDirHandle = await window.showDirectoryPicker();
				}
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('下载开始，下载进度见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('全部增强下载').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				if (!e.target.dataset.link) {
					$(e.target).removeClass('listener-copy-all').addClass('pl-btn-danger').html(`${config.base.assistant.message}👉<a href="${config.base.assistant.link}" target="_blank" class="pl-a">点击此处安装</a>👈`);
				} else {
					base.setClipboard(decodeURIComponent(e.target.dataset.link));
					$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
					setTimeout(
						function () {
							$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
						}, 2000
					)
				}
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let BDUSS = $baidu.getBDUSS();
				let res = await base.sendLinkToRPC(e.currentTarget.dataset.link, e.currentTarget.dataset.filename,e.currentTarget.dataset.path, [`User-Agent: ${config.$baidu.api.ua.downloadLink}`, `Cookie: BDUSS=${BDUSS}`]);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('发送成功了!快去看看吧~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}👉<a href="${config.base.assistant.link}" target="_blank" class="pl-a">点击此处安装</a>👈`);
				} else {
					target.addClass('pl-btn-danger').text('发送失败，检查一下您的RPC配置信息哦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('发送完成，发送结果见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdate();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function (e) {
				e.preventDefault();
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encodeBase(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
			document.documentElement.addEventListener('mouseup', function (e) {
				if (e.target.nodeName === 'A' && ~e.target.className.indexOf('pl-a')) {
					e.stopPropagation();
				}
			}, true);
		},

		greenerPage() {
			page = $baidu.detectPage();
			base.waitForKeyElements(".wp-s-header-user__vip-center", function (tag) {
				tag.remove();
			}, true);
			base.waitForKeyElements(".wp-s-header-user__create-team-content", function (tag) {
				tag.remove();
			}, true);
			base.waitForKeyElements(".app-user-vip-center-box.vip-center-type-2", function (tag) {
				tag.remove();
			}, true);
			base.waitForKeyElements(".wp-s-header__vip-btn-tip", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".app-user-vip-center-tip", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements("#web-header-text-s-45", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".wp-s-header__vip-btn", function (tag) {
				tag.text("会员中心")
			}, true);
			base.waitForKeyElements(".KQcHyA", function (tag) {
				tag.text("会员中心")
			}, true);
			base.waitForKeyElements(".gOIbzPb", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".wp-s-header-user__create-team-title", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".web-header-ad-item", function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements(".wp-s-header__game-entry", function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements(".bd-aside-ad", function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements(".btn-img-tips", function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements(".nd-operate-guidance", function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements(".module-operation-content", function (tag) {
				tag.fadeOut();
				document.querySelector(".operate-guide-close").click();
				document.querySelector(".module-canvas").click();
			}, true)
			base.waitForKeyElements("[class*='module-'][class*='-box']:not(.module-box), [class*='module-'][class*='-mask']", function (tag) {
				tag.fadeOut();
				tag.find(".close-mask").click();
			}, true)
			base.waitForKeyElements(".newIcon", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".u-badge__content.is-dot", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".wp-side-options.g-clearfix", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".wp-s-header-user__drop-channel", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".app-download", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('.g-button[title*="手机"]', function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements('.yike-entrance', function (tag) {
				tag.remove();
			}, true)
			base.waitForKeyElements("a.tools__item", function (tag) {
				if (tag.attr("linked")) return;
				if (tag.attr('href')) {
					try {
						let url = new URL(tag.closest('a').attr('href'));
						url.search = "";
						url.hash = url.hash.replace(/\?(.*?)(#|$)/, '$2')
						tag.attr('href', url.href)
					} catch (e) { }
				}
				tag.attr("linked", true)
			}, true);
			base.waitForKeyElements("p.wp-s-aside-nav__main-item-text", function (tag) {
				if (tag.attr("linked")) return;
				if (tag.closest('a').attr('href')) {
					try {
						let url = new URL(tag.closest('a').attr('href'));
						url.search = "";
						url.hash = url.hash.replace(/\?(.*?)(#|$)/, '$2')
						tag.closest('a').attr('href', url.href)
					} catch (e) { }
				}
				if (tag.is(":contains('插件'), :contains('相册'), :contains('笔记')") && tag.closest('a').attr('target') !== "_blank") {
					tag.closest('a').fadeOut();
				} else {
					tag.text(tag.text().replace("百度", ""));
				}
				tag.attr("linked", true)
			}, true);
			base.waitForKeyElements('dd[node-type="header-link"]', function (tag) {
				tag.children().each(function () {
					let tag = $(this);
					if (!tag.attr("node-type")) return;
					let type = tag.attr("node-type");
					if (
						type !== "disk-home" &&
						type !== "mbox-homepage" &&
						type !== "find-apps"
					) {
						tag.fadeOut();
					}
				});
			}, true);
			base.waitForKeyElements(".__yunguanjia", function (tag) {
				tag.html(`<div class="yunguanjia-list __yunguanjia row g-clearfix _item sel">
					<span type="radio" class="radio-box _radioInput __yunguanjiaRadio">
						<span class="device-name">添加我的电脑</span>
					</span>
					<div class="__yunguanjiaTips radio-tips" style="display: block;">
						用电脑下载并登录最新百度网盘客户端，即自动完成添加。
						<a href="//pan.baidu.com/download" target="_blank">下载百度网盘客户端</a>
						<br/>由 <a href="https://github.com/hmjz100/LinkSwift/" target="_blank">LinkSwift</a> 修复该选项
					</div>
				</div>`);
			}, true)
			// 美化分享页面
			if (page === 'share') {
				base.waitForKeyElements(`iframe[src^="/buy/ad"]`, function (tag) {
					tag.fadeOut();
				}, true)
				base.addStyle(`${mount}-baiduShare`, 'style', `
					body, .theme-white.init-new, #layoutApp {
						background-color: #DCEFFE !important;
						background: #DCEFFE url(https://nd-static.bdstatic.com/m-static/disk-share/widget/pageModule/init-new/image/init-bg_1708266.png) no-repeat center center;
					}
					#bd-main .bd-left {
						background: #ffffffC0;
						border-radius: 10px;
					}
					iframe[src="/buy/ad/home"] {
						display: none !important;
					}
				`, `.${mount}`);
				base.waitForKeyElements(`.KPDwCE`, function (tag) {
					tag.css('background', 'transparent');
				}, true);
				base.waitForKeyElements('.share-list .KPDwCE .AuPKyz', function (tag) {
					tag.css('background', 'transparent');
				}, true);
				base.waitForKeyElements(`#layoutMain`, function (tag) {
					tag.css({ "border-radius": "24px" });
				}, true)
				base.waitForKeyElements(".frame-content", function (tag) {
					tag.css({ "margin": "auto" });
				}, true)
			}
		},

		addButton() {
			base.waitForKeyElements(config.$baidu.mount.home, (element) => {
				page = $baidu.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'home') return;
				let $button = $(`
					<div class="g-dropdown-button pointer pl-button">
						<div class="baidu-button g-button g-button-blue"><span class="g-button-right"><em class="icon icon-download" style="color:#fff;"></em><span class="text" style="width: 60px;">下载助手</span></span></div>
						<div class="menu" style="color: ${color};border-color: ${color};width:auto;z-index:41;">
							<div class="g-button-menu pl-button-mode" data-mode="api">API 下载</div>
							<div class="g-button-menu pl-button-mode" data-mode="aria">Aria 下载</div>
							<div class="g-button-menu pl-button-mode" data-mode="rpc">RPC 下载</div>
							<div class="g-button-menu pl-button-mode" data-mode="curl">cURL 下载</div>
							<div class="g-button-menu pl-button-mode" data-mode="bc">BC 下载</div>
							<div class="g-button-menu pl-button-mode listener-open-setting">助手设置</div>
							<div class="g-button-menu pl-button-mode listener-open-beautify">助手美化</div>
							<div class="g-button-menu pl-button-mode listener-open-updatelog">更新日志</div>
						</div>
					</div>
				`);
				element.prepend($button);
			})
			base.waitForKeyElements(config.$baidu.mount.main, (element) => {
				page = $baidu.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'main') return;
				let $button = $(`
					<div class="wp-s-agile-tool-bar__h-group pl-button">
						<div class="wp-s-agile-tool-bar__h-action is-need-left-sep is-main">
							<button type="button" class="u-button nd-file-list-toolbar-action-item u-button--primary u-button--small is-round is-has-icon pl-button baidu-button">
								<i class="u-icon u-icon-download"></i>
								<span>下载助手</span>
							</button>
							<ul class="dropdown-list nd-common-float-menu pl-dropdown-menu">
								<li class="sub cursor-p pl-button-mode" data-mode="api">API 下载</li>
								<li class="sub cursor-p pl-button-mode" data-mode="aria">Aria 下载</li>
								<li class="sub cursor-p pl-button-mode" data-mode="rpc">RPC 下载</li>
								<li class="sub cursor-p pl-button-mode" data-mode="curl">cURL 下载</li>
								<li class="sub cursor-p pl-button-mode" data-mode="bc">BC 下载</li>
								<li class="sub cursor-p pl-button-mode listener-open-setting">助手设置</li>
								<li class="sub cursor-p pl-button-mode listener-open-beautify">助手美化</li>
								<li class="sub cursor-p pl-button-mode listener-open-updatelog">更新日志</li>
							</ul>
						</div>
					</div>`);
				element.prepend($button);
			})
			base.waitForKeyElements(config.$baidu.mount.main, (element) => {
				page = $baidu.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'youth') return;
				let $button = $(`
					<div class="wp-s-agile-tool-bar__h-group pl-button">
						<div class="wp-s-agile-tool-bar__h-action is-need-left-sep is-main">
							<button type="button" class="u-button nd-file-list-toolbar-action-item u-button--primary u-button--small is-round is-has-icon pl-button baidu-button" style="font-size:14px;font-weight:700">
								<i class="u-icon u-icon-more"></i>
								<span>网盘助手</span>
							</button>
							<ul class="dropdown-list nd-common-float-menu pl-dropdown-menu">
								<li class="sub cursor-p pl-button-mode listener-open-setting">助手设置</li>
								<li class="sub cursor-p pl-button-mode listener-open-beautify">助手美化</li>
								<li class="sub cursor-p pl-button-mode listener-open-updatelog">更新日志</li>
							</ul>
						</div>
					</div>`);
				element.prepend($button);
			})
			base.waitForKeyElements(config.$baidu.mount.share, (element) => {
				page = $baidu.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'share') return;
				/*let $button = $(`
					<div class="g-dropdown-button pointer pl-button">
						<div class="baidu-button g-button g-button-blue"><span class="g-button-right"><em class="icon icon-download" style="color:#fff;"></em><span class="text" style="width: 60px;">下载助手</span></span></div>
						<div class="menu" style="color: ${color};border-color: ${color};width:auto;z-index:41;">
							<div class="g-button-menu pl-button-mode pl-button-save"><em class="icon icon-save-disk" title="保存到网盘"></em><span style="margin-left: 3px;">保存后下载</span></div>
							<div class="g-button-menu pl-button-mode listener-open-setting">助手设置</div>
							<div class="g-button-menu pl-button-mode listener-open-beautify">助手美化</div>
							<div class="g-button-menu pl-button-mode listener-open-updatelog">更新日志</div>
						</div>
					</div>
				`);*/
				let $button = $(`<a class="g-button tools-share-V20-btn save_btn pl-button" style="padding:0;">
					<span class="g-button-right" style="padding-left:10px">
						<em class="icon icon-download" style="color:#fff;line-height:27px"></em>
						<span class="text" style="width: auto;">下载助手</span>
					</span>
					<ul class="dropdown-list nd-common-float-menu pl-dropdown-menu">
						<li class="sub cursor-p pl-button-mode pl-button-save"><em class="icon noicon-zhuancun_bai"></em>保存后下载</li>
						<li class="sub cursor-p pl-button-mode listener-open-setting">助手设置</li>
						<li class="sub cursor-p pl-button-mode listener-open-beautify">助手美化</li>
						<li class="sub cursor-p pl-button-mode listener-open-updatelog">更新日志</li>
					</ul>
				</a>`)
				element.after($button);
			})
			this.setBDUSS();
		},

		addInitButton() {
			base.waitForKeyElements(config.$baidu.mount.home, (element) => {
				page = $baidu.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'home') return;
				let $button = $(`<div class="g-dropdown-button pointer pl-button-init" style="opacity:0.5"><div style="color:#fff;" class="g-button g-button-blue"><span class="g-button-right"><em class="icon icon-download" style="color:#fff;"></em><span class="text" style="width: 60px;">点我点亮</span></span></div></div>`);
				$button.click(function () { base.initDialog() });
				element.prepend($button);
			})
			base.waitForKeyElements(config.$baidu.mount.main, (element) => {
				page = $baidu.detectPage();
				if ($(".pl-button-init").length > 0 || !page || (page !== 'main' && page !== 'youth')) return;
				let $button = $(`<div class="wp-s-agile-tool-bar__h-group pl-button-init">
					<div class="wp-s-agile-tool-bar__h-action is-need-left-sep is-main">
						<button type="button" class="u-button nd-file-list-toolbar-action-item u-button--primary u-button--small is-round is-has-icon pl-button baidu-button" style="font-size:14px;font-weight:700">
							<i class="u-icon u-icon-download"></i>
							<span>点我点亮</span>
						</button>
					</div>
				</div>`);
				$button.click(function () { base.initDialog() });
				element.prepend($button);
			})
			base.waitForKeyElements(config.$baidu.mount.share, (element) => {
				page = $baidu.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'share') return;
				let $button = $(`<a class="g-button tools-share-V20-btn save_btn pl-button-init" href="javascript:;">
					<span class="g-button-right">
						<em class="icon icon-download" style="color:#fff;line-height:27px"></em>
						<span class="text" style="width: auto;">点我点亮</span>
					</span>
				</a>`)
				$button.click(function () { base.initDialog() });
				element.after($button);
			})
		},

		async getFilesByOnce(file,params){
			try {
				let res;
				if(page=="home"||page=="main"){
					//我找的链接获取文件，1页100个，这个能获取文件夹所有文件我就直接用了
					//TODO path属性被占用，原来设想的从选中文件夹开始的路径改成_path
					let url = `${config.$baidu.api.getFiles.home}&dir=${encodeURIComponent(file.path)}&access_token=${this.accessToken}`;
					res = await base.get(url, { "User-Agent": config.$baidu.api.ua.downloadLink});
				}else if(page=="share"){
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error(`提示：<br/>文件获取请求失败`);
			}
		},

		async getFileUrlByOnce(file,params) {
			try {
				let res;
				if(page=="home"||page=="main"){
					let url = `${config.$baidu.api.getLink.home}&fsids=${params.fsids}&access_token=${this.accessToken}`;
					res = await base.get(url, { "User-Agent": config.$baidu.api.ua.downloadLink });
				}else if(page=="share"){
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error(`提示：<br/>文件下载链接请求失败`);
			}
		},

		async fetchAllPages(file) {
			//分页获取文件夹内文件数据
			let files=[];//文件数据列表
			let res;
			
			//随机停顿防反爬
			this.cnt++;
			if (this.cnt >= 50+Math.random()*10) {
				doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div><div>休息 ${globalSleep} 毫秒...</div>`);
				await base.customSleep();
				this.cnt = 0;
			}

			//发送请求
			res=await this.getFilesByOnce(file,undefined);

			//请求失败
			if(res?.errno){
				return message.error(`提示：<br/>请求失败，失败码：	${res?.errno}	失败信息：${res.errmsg}`);
			}

			//请求成功
			files=files.concat(res.list)//注意变量名
			return files; 
		},

		async fetchFiles(file,pNode) {
			//节点 
			let fileNode={
				name:file.server_filename,//注意变量名
				_path:pNode.name === 'root' ? `` : (pNode._path === '' ? pNode.name : `${pNode._path}/${pNode.name}`),//一般来说，路径不要特别特别长，不然可能会出问题，不过正常是不会的
				children:[]
			}
			pNode.children.push(fileNode);
			file._path=fileNode._path;//TODO path属性被占用，改成 _path

			//判断是否文件夹
			if (!file?.isdir) {//注意变量名
				this.fileCount++;
				doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div>`);
				return file;
			}

			//文件夹内文件遍历
			let files=[];
			for (let f of await this.fetchAllPages(file)) {
				files= files.concat(await this.fetchFiles(f,fileNode));
			}
			return files;
		},

		async getLink() {
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				title: "获取中",
				html: `...`,
				footer: "如果选的文件较多，请耐心等待获取完成哦！",
				customClass: {
					popup: 'loading-popup',
					header: 'loading-header',
					title: 'loading-title',
					content: 'loading-content',
					input: 'loading-input',
					footer: 'loading-footer'
				},
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			// 获取选择的文件列表
			selectList = this.getSelectedList();
			let BDUSS = this.getBDUSS();
			this.accessToken = (base.getValue('baidu_access_token') || await $baidu.getToken());

			if (!this.accessToken) {
				message.info('提示：<br/>稍后请在新标签页中授权助手哦~');
				base.deleteValue('baidu_access_token');
				setTimeout(() => {
					GM_openInTab(config.$baidu.api.getAccessToken, { active: true, insert: true, setParent: true })
					let attempts = 0;
					let interval = setInterval(function () {
						if (!!base.getValue('baidu_access_token')) {
							clearInterval(interval);
							this.accessToken = base.getValue('baidu_access_token')
						}
						attempts++;
						if (attempts > 120) {
							clearInterval(interval);
							return message.error('提示：<br/>时间太长，我先撤下啦~');
						}
					}, 1000);
				}, 3300);
				return;
			}

			if (!BDUSS) {
				async function getBDUSS() {
					let dialog = await Swal.fire({
						icon: 'info',
						title: `提示`,
						html: '你好呀，为了获取百度网盘文件的下载直链<br/>我们需要您安装原作者的辅助扩展<br/>来让 “下载助手” 读取您的网盘账号凭证 (BDUSS)<br/>获取到的凭证仅用于生成直链，请放心安装\\(≧▽≦*)o<br/><br/>不知道如何安装第三方扩展？<a class="pl-a" target="_blank" href="https://www.youxiaohou.com/zh-cn/crx.html ">点此查看详情</a><br/>如果给浏览器开启了“开发者模式”后频繁提示<br/>“关闭开发者模式”，请使用<a class="pl-a" target="_blank" href="https://wws.lanzoub.com/b00vgnrha ">此补丁</a>隐藏提示。<a class="pl-a" target="_blank" href="https://ooo.0x0.ooo/2022/05/04/zrNGX.png ">界面汉化</a><br/>扩展安装后请刷新本页，以应用最新更改',
						showConfirmButton: true,
						showDenyButton: true,
						showCancelButton: true,
						showCloseButton: true,
						allowOutsideClick: false,
						allowEscapeKey: false,
						allowEnterKey: false,
						confirmButtonText: '前往 Chrome（Crx搜搜）',
						denyButtonText: '前往 Firefox（Crx搜搜）',
						cancelButtonText: '装不了扩展，我要手动输入',
						position: 'center',
						...swalDefault
					});

					if (dialog.isConfirmed) {
						GM_openInTab('https://www.crxsoso.com/addon/detail/mphijdmblaalbakceeadippfkbgfgaaa ', { active: true });
					}
					if (dialog.isDenied) {
						GM_openInTab('https://www.crxsoso.com/firefox/detail/baidunetdiskisasb ', { active: true });
					}
					if (dialog.isDismissed && dialog.dismiss === Swal.DismissReason.cancel) {
						while (true) {
							let idialog = await Swal.fire({
								title: '手动输入凭证',
								html: `<div class="bduss-box">
									<h3>Via 浏览器获取方法</h3>
									<p>打开任意百度网盘页面 →</p>
									<p>点击地址栏左侧的安全图标 →</p>
									<p>查看 Cookies →</p>
									<p>找到 "BDUSS=" 字段 →</p>
									<p>复制等于号后面的内容直到分号 (不含分号) →</p>
									<p>然后粘贴到这里</p>
									<hr/>
									<h3>桌面端浏览器获取方法</h3>
									<p>打开任意百度网盘页面 →</p>
									<p>F12 打开开发者工具 →</p>
									<p>转到 应用(Application) 标签 →</p>
									<p>Cookies →</p>
									<p>找到 "BDUSS" 字段 →</p>
									<p>复制其值粘贴到这里</p>
									<div class="input-box">
										<input class="swal2-input init-input" id="init" type="text" style="margin-bottom:0" placeholder="输入凭证...">
									</div>
								</div>
								<style>
									.bduss-box > .input-box {
										display:flex;flex-direction:column;align-items:center
									}
									.bduss-box > hr {
										margin-top: 10px;
									}
									.bduss-box > hr {
										border-style: inset;
										border-width: 1px;
									}
								</style>`,
								showConfirmButton: true,
								showDenyButton: true,
								confirmButtonText: '确认',
								denyButtonText: '取消',
								allowOutsideClick: false,
								allowEscapeKey: false,
								allowEnterKey: false,
								focusConfirm: false,
								...swalDefault
							});
							if (idialog.isConfirmed) {
								let BDUSS = $('#init').val().trim();
								if (BDUSS && BDUSS.length >= 192) {
									$baidu.setBDUSS(BDUSS);
									return message.success('提示：<br/>凭证设置成功<br/>请再获取一次下载链接吧~');
								} else {
									await Swal.fire({
										icon: 'error',
										title: '格式错误',
										text: '请输入有效的 BDUSS（通常长度 ≥ 192 位）',
										confirmButtonText: '确认',
										...swalDefault
									});
									continue;
								}
							} else if (idialog.isDenied) {
								return await getBDUSS();
							}
						}
					}
				}
				return await getBDUSS();
			}
			
			if(page === 'home' || page === 'main'){
			}else if(page=="share"){
				//分享页面所需的变量
			}else{
				return message.error('提示：<br/>页面错误~');
			}

			this.cnt=0; //计数器，用于控制随机延迟
			this.fileCount=0;//文件计数
			let fileList=[];//文件列表，只有文件没有文件夹
			let fileTree = { name: "root", path: ``, children: [] }; // 文件目录树
			if (page === 'home' || page === 'main') {
				if (!selectList.length) {
					return message.error('提示：<br/>先勾选要下载的文件哦~');
				}

				//获取文件目录结构（递归）
				for (let file of selectList) {
					//遍历选中文件
					//统一变量名
					fileList = fileList.concat(await this.fetchFiles(file,fileTree));
				}

				//文件夹为空
				if (!fileList.length) {
					return message.error('提示：<br/>文件夹是空的哦~');
				}

				//列表转字典
				const filesDict = fileList.reduce((acc, file) => {
					acc[file.fs_id] = file;
					return acc;
				}, {});

				//获取下载链接 
				doc.find('.loading-popup .loading-title').html(`链接获取中`);
				doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取文件对应的下载链接~</div>`);
				let fidList = fileList.map(f => f.fs_id);
				let linkList = [];
				let batchSize = globalBatchsize+Math.ceil(Math.random()*5);
				let i=0;
				while (i < fileList.length){
					//url请求
					let params={"fsids":encodeURIComponent(JSON.stringify(fidList.slice(i, i + batchSize)))};
					let res = await this.getFileUrlByOnce(undefined,params);

					if (res?.list?.length && (res.errno === 0 || res.errmsg === "succ")) {
						linkList = linkList.concat(res.list);
						doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${linkList.length} / ${fidList.length} 个链接~</div>`);

					} else {
						if (res?.errno) {
							if (res.errno === 112) {
								return message.error('提示：<br/>页面过期了，刷新重试下吧~<br/>代码：' + res.errno);
							}
							if (res.errno === 9019) {
								base.deleteValue('baidu_access_token');
								return message.error('提示：<br/>访问令牌已过期，刷新网页后再获取一次吧~<br/>代码：' + res.errno);
							}

							base.deleteValue('baidu_access_token');
							return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~<br/>代码：' + res.errno);

						} else {
							return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
						}
					}

					// 每次处理完一个批次后，等待	
					if (i + batchSize < fileList.length){
						doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${i} / ${fileList.length} 个链接,请耐心等待哦~</div><div>休息 ${globalSleep} 毫秒...</div>`);
						await base.customSleep();
					};

					//累加批次
					i += batchSize;
					batchSize = globalBatchsize+Math.ceil(Math.random()*5)
				}

				if (linkList.length) {
					for (let i = 0; i < linkList.length; i++) {//重写下载路径
						linkList[i]._path = filesDict[linkList[i].fs_id]._path;
					}
					base.showMainDialog(config.base.dom.button[mode].title, this.generateDom(linkList), config.base.dom.button[mode].footer);
				} else {
					return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
				}
			} else {
				return message.error('提示：<br/>页面错误~');
			}
		},

		generateDom(list) {
			if (!list) {
				return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			base.sortByName(list);
			list.forEach((v, i) => {
				if (v.isdir === 1) return;
				let filename = v.server_filename || v.filename;
				let size = base.sizeFormat(v.size);
				let dpath=v._path;//属性被占用
				if (!v?.dlink || !v?.dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">获取下载链接失败，刷新网页后再试试吧~</div>
					</div>`;
				} else {
					let dlink = v.dlink + '&access_token=' + base.getValue('baidu_access_token');
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary listener-link-api blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载有可能会被 IDM 捕获下载链接" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-index="${i}" data-path="${dpath}">增强下载(基于浏览器文件流)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="不建议使用本功能，若使用后长时间没有弹出下载提示则代表请求失败，请换用“增强下载”<br/>基于浏览器直接打开链接来下载文件，适用于较为古老但支持 iframe 的浏览器，点击“直接下载”后需等待下载提示弹出才能点击下个“直接下载”，否则只会下载后者，此方式下载有可能会被 IDM 捕获下载链接" data-filename="${filename}" data-link="${dlink}">直接下载(基于浏览器链接)</button>
							<button class="pl-item-copy listener-tip pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误" data-filename="${filename}" data-link="${dlink}">复制链接</button>
							<div class="pl-item-tip" style="display: none"></div>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">正在加载进度...0%</div>
									</div>
								</div>
								<button class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">取消下载</button>
								<button class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">返回</button>
							</div>
						</div>`;
					}
					let BDUSS = this.getBDUSS();
					if (mode === 'aria') {
						let alink = base.convertLinkToAria(dlink, filename, dpath, `--header "User-Agent: ${config.$baidu.api.ua.downloadLink}" --header "Cookie: BDUSS=${BDUSS}"`);
						if (typeof (alink) === 'object') {
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
								<a class="pl-item-link pl-a" target="_blank" href="${alink.link}" title="点击复制 aria2c 命令行" data-filename="${filename}" data-link="${alink.link}">${decodeURIComponent(alink.text)}<br/>复制 ${filename} 下载命令行</a>
							</div>`;
						} else {
							alinkAllText += alink + '\r\n';
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
								<a class="pl-item-link pl-a listener-link-aria" href="${alink}" title="点击复制 aria2c 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
							</div>`;
						}
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
									<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
									<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" 
											data-filename="${filename}" 
											data-link="${dlink}" 
											data-path="${dpath}"> <!-- 添加了 data-path 属性 -->
										<svg class="icon-rpc-devices" viewBox="-10 0 1034 1024">
											<g transform="matrix(1 0 0 -1 0 960)">
												<path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" />
											</g>
										</svg>
										<span style="margin-left: 5px;">将 ${filename} 推送到 RPC 下载器</span>
									</button>
								</div>`;
					}
					if (mode === 'curl') {
						let alink = base.convertLinkToCurl(dlink, filename, dpath, `-A "${config.$baidu.api.ua.downloadLink}" -b "BDUSS=${BDUSS}"`);
						if (typeof (alink) === 'object') {
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
								<a class="pl-item-link pl-a" target="_blank" href="${alink.link}" title="点击复制 curl 命令行" data-filename="${filename}" data-link="${alink.link}">${decodeURIComponent(alink.text)}<br/>复制 ${filename} 下载命令行</a>
							</div>`;
						} else {
							alinkAllText += alink + '\r\n';
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
								<a class="pl-item-link pl-a listener-link-aria" href="${alink}" title="点击复制 curl 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
							</div>`;
						}
					}
					if (mode === 'bc') {
						let alink = base.convertLinkToBC(dlink, filename, `cookie=${encodeURIComponent("BDUSS=" + BDUSS)}&user_agent=${encodeURIComponent(config.$baidu.api.ua.downloadLink)}`);
						if (typeof (alink) === 'object') {
							alinkAllText += decodeURIComponent(alink.text) + '\r\n';
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
								<a class="pl-item-link pl-a" href="${decodeURIComponent(alink.link)}" title="点击用比特彗星下载" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink.text)}<br/>下载 ${filename}</a>
							</div>`;
						} else {
							alinkAllText += alink + '\r\n';
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
								<a class="pl-item-link pl-a" href="${decodeURIComponent(alink)}" title="点击用比特彗星下载" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>下载 ${filename}</a>
							</div>`;
						}
					}
				}
			});

			content += '</div>';
			if (mode === 'rpc') {
				content += `<div class="pl-extra">`
			}
			if (list.length >= 2) {
				if (mode === 'api')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载有可能会被 IDM 捕获下载链接">全部增强下载</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误">复制全部链接</button></div>`;
				if (mode === 'aria')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button></div>`;
				if (mode === 'rpc') {
					content += `<button class="pl-btn-primary listener-send-rpc">发送全部链接</button>`;
				}
				if (mode === 'curl') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">修改终端类型（${terminalType[base.getValue('setting_terminal_type')]}）</button></div>`;
				}
				if (mode === 'bc') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部链接</button></div>`;
				}
			}
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">修改 RPC 参数（${rpc}）</button>
					<button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">查看下载任务</button>
				</div>`;
			}
			return content;
		},

		getSelectedList() {
			let List, selectList
			try {
				List = require("system-core:context/context.js").instanceForSystem.list;
				selectList = List.getSelected();
				/*if (!selectList.length) {
					selectList = List.getCurrentList();
				}*/
				return selectList;
			} catch (e) { }
			try {
				List = unsafeWindow.document.querySelector('.wp-s-core-pan');
				if (List && List.__vue__.selectedList) {
					selectList = List.__vue__.selectedList;
					return selectList;
				}
			} catch (e) { }
			try {
				List = unsafeWindow.document.querySelector('.file-list');
				if (List && List.__vue__.allFileList) {
					selectList = List.__vue__.allFileList.filter(function (item) { return !!item.selected; });
					return selectList;
				}
			} catch (e) { }
		},

		getLogid() {
			let ut = require("system-core:context/context.js").instanceForSystem.tools.baseService;
			return ut.base64Encode(base.getCookie("BAIDUID"));
		},

		getShareData() {
			let res = unsafeWindow.locals.dump();
			shareParams.shareType = 'secret';
			shareParams.sign = '';
			shareParams.timestamp = '';
			shareParams.bdstoken = res.bdstoken.value;
			shareParams.channel = 'chunlei';
			shareParams.clienttype = 0;
			shareParams.web = 1;
			shareParams.app_id = 250528;
			shareParams.encrypt = 0;
			shareParams.product = 'share';
			shareParams.logid = this.getLogid();
			shareParams.shareid = res.shareid.value;
			shareParams.uk = res.share_uk.value;
			shareParams.shareType === 'secret' && (shareParams.extra = this._getExtra());
			shareParams.surl = this._getSurl();
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/disk\/home/.test(path)) return 'home';
			if (/^\/disk\/main/.test(path)) return 'main';
			if (/^\/youth\/pan\/main/.test(path)) return 'youth';
			if (/^\/(s|share)\//.test(path)) return 'share';
			return '';
		},

		async initAuthorize() {
			base.registerMenuCommand();
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				html: `请稍后`,
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				let url = new URL(location.href);
				let auth = new URL(config.$baidu.api.getAccessToken);
				const allowedClientIds = [
					auth.searchParams.get("client_id"),
					'L6g70tBRRIXLsY0Z3HwKqlRE', // pcstest_oauth
					'fSds3K4w43rw37tOqlQmTa2kDwaczK4U', // 小度智能词典笔专业版
					'TFwtw8uwHxpdkvVqVKdIlx1XqXUnr1zG', // 印象笔记
					'9dgBV9yesuBVOXaxls7aVHbLBLqU8yyg', // WPS文档
					'l9DdBOG4RYroMscmzK5OChdaGelgd92M', // 小猴云印PC版
					'Kyr013gHQBf2immy3fQt1jZ3nZVpiGAm', // 简单打印
					'iYCeC9g08h5vuP9UqvPHKKSVrKFXGa1v', // Alist
					'IlLqBbU3GjQ0t46TRwFateTprHWl39zF',  // 百度手机助手
				];
				// https://openapi.baidu.com/oauth/2.0/authorize?response_type=code&client_id=&scope=basic,netdisk,mobile&display=page&redirect_uri=
				if (
					/openapi.baidu.com\/oauth\/2.0\/authorize/.test(location.href) &&
					url.searchParams.get("response_type").includes("token") &&
					url.searchParams.get("scope").includes("netdisk") &&
					allowedClientIds.includes(url.searchParams.get("client_id"))
				) {
					let dialog = await Swal.fire({
						icon: 'info',
						title: `提示`,
						html: '你好呀，为了获取百度网盘文件的下载直链<br/>我们需要您的授权来使 “下载助手” 读取您的网盘文件信息<br/><br/>由于使用了别的应用ID，所以授权的应用名称会有不同<br/>获取到的数据仅用于生成直链，请放心授权ヾ(≧▽≦*)o',
						showConfirmButton: true,
						showDenyButton: true,
						allowOutsideClick: false,
						allowEscapeKey: false,
						allowEnterKey: false,
						confirmButtonText: '授权',
						denyButtonText: '再想想',
						position: 'center'
					});
					if (dialog.isConfirmed) {
						base.waitForKeyElements("button#auth-allow", function (element) {
							element[0].click();
						}, true)
						return;
					}
					if (dialog.isDenied) {
						return await Swal.fire({
							icon: 'question',
							title: `好吧(*￣3￣)╭`,
							html: '那就再想一想<br/>想好了就按下 “授权” 按钮吧~',
							timer: 180000,
							toast: true,
							timerProgressBar: true,
							showConfirmButton: false,
							showDenyButton: false,
							position: 'bottom-end',
						})
					}
				} else if (/openapi.baidu.com\/oauth\/2.0\/login_success/.test(location.href)) {
					let int = setInterval(async function () {
						if (location.href.includes('access_token') && (location.href.includes('basic+netdisk') || location.href.includes('basic,netdisk'))) {
							clearInterval(int)
							let token = location.href.match(/access_token=(.*?)&/)[1];
							base.setValue('baidu_access_token', token);
							let dialog = await Swal.fire({
								icon: 'success',
								title: `成功啦`,
								html: '你已 成功授权/授权过 脚本读取您的网盘文件信息~<br/>等待 <span id="second">3</span> 秒之后将关闭此页面',
								timer: 3000,
								timerProgressBar: true,
								showConfirmButton: true,
								showDenyButton: false,
								allowOutsideClick: false,
								allowEscapeKey: false,
								allowEnterKey: false,
								confirmButtonText: '关闭页面',
								position: 'center',
								willOpen: function () {
									let sec = 3.1;
									setInterval(() => {
										sec -= 0.1;
										document.getElementById("second").innerText = sec.toFixed(1);
									}, 100);
									setTimeout(() => {
										window.close()
									}, 3100);
								},
							});
							if (dialog.isConfirmed) {
								window.close()
								return;
							}
						} else {
							clearInterval(int)
							Swal.close()
						}
					}, 1)
				} else {
					Swal.close()
				}
			} else {
				Swal.close()
			}
		},

		async initPanLinker() {
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		},
	};

	/**
	 * 阿里云盘
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	let $aliyun = {
		cnt:0,//计数器，用于控制随机延迟
		fileCount:0,//文件计数
		authorization:"",

		addPageListener() {
			/*
			防止代码因其他原因被执行多次
			这段代码出自 Via轻插件，作者谷花泰
			*/
			const key = encodeURIComponent('LinkSwift:阿里云盘');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, back, stop, target,
				};
			}

			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				let reactDomGrid = document.querySelector(config.$aliyun.mount.grid);
				if (reactDomGrid) {
					let dialog = await Swal.fire({
						title: '提示',
						html: '<div style="display: flex;align-items: center;justify-content: center;">请先切换到&nbsp;&nbsp;<svg class="icon" class="icon--D3kMk " viewBox="0 0 1024 1024" width="20" height="20" fill="currentColor"><use xlink:href="#PDSDrag"></use></svg>&nbsp;<b>列表视图</b>&nbsp;&nbsp;后再获取下载链接哦</div>',
						icon: 'info',
						showCloseButton: true,
						showDenyButton: true,
						confirmButtonText: '切换',
						denyButtonText: '不要',
						...swalDefault
					});
					if (dialog.isConfirmed) {
						document.querySelector(config.$aliyun.mount.switch).click();
						return message.success('提示：<br/>切换为列表视图成功<br/>请再获取一次下载链接吧~');
					}
					return false;
				}
				selectList = $aliyun.getSelectedList();
				if (selectList.length === 0) {
					return message.error('提示：<br/>请勾选要保存到网盘的文件哦~');
				}
				message.info('提示：<br/>因网盘限制，请保存到自己网盘后再去下载哦~');
				await base.sleep(500);
				document.querySelector('[class*="btn-save--"]').click();
			});

			doc.on('click', '.pl-button-mode', async function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				let reactDomGrid = document.querySelector(config.$aliyun.mount.grid);
				if (reactDomGrid) {
					let dialog = await Swal.fire({
						title: '提示',
						html: '<div style="display: flex;align-items: center;justify-content: center;">请先切换到&nbsp;&nbsp;<svg class="icon" class="icon--D3kMk " viewBox="0 0 1024 1024" width="20" height="20" fill="currentColor"><use xlink:href="#PDSDrag"></use></svg>&nbsp;<b>列表视图</b>&nbsp;&nbsp;后再获取下载链接哦</div>',
						icon: 'info',
						showCloseButton: true,
						showDenyButton: true,
						confirmButtonText: '切换',
						denyButtonText: '不要',
						...swalDefault
					});
					if (dialog.isConfirmed) {
						document.querySelector(config.$aliyun.mount.switch).click();
						return message.success('提示：<br/>切换为列表视图成功<br/>请再获取一次下载链接吧~');
					}
					return false;
				}
				$aliyun.getLink();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();

				const o = _factory(e);
				const $width = o.item.find('.pl-progress-inner');
				const $text = o.item.find('.pl-progress-inner-text');
				const filename = o.link[0].dataset.filename;
				const path=o.link[0].dataset.path;
				const index = o.link[0].dataset.index;
				const size = Number(o.link[0].dataset.size) || 0;

				base._resetData(index);
				base.get(e.currentTarget.dataset.link, { "Referer": `https://${location.host}/` }, 'blob', { filename, index, path});

				let startTime = Date.now();
				let prevLoaded = 0;
				let prevTime = startTime;

				ins[index] = setInterval(async function () {
					const prog = +progress[index] || 0;
					const currentTime = Date.now();
					const elapsedTime = currentTime - startTime;
					const loaded = prog * size / 100;
					const timeDiff = Math.max(currentTime - prevTime, 1); // 避免除零
					const speed = ((loaded - prevLoaded) / (timeDiff / 1000)) || 0;

					// 计算剩余时间（保护除零）
					const totalProgress = Math.max(prog / 100, 0.01);
					const totalElapsedSeconds = elapsedTime / 1000;
					const estTotalTime = totalElapsedSeconds / totalProgress;
					const remainingTime = estTotalTime - totalElapsedSeconds;

					// 更新界面状态
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// 更新进度条
					$width.css('width', `${prog}%`);
					$text.text(`${prog.toFixed(1)}% | 速度:${base.sizeFormat(speed)} | 剩余:${base.rtimeFormat(remainingTime)}`);

					// 更新历史值
					prevLoaded = loaded;
					prevTime = currentTime;

					// 下载完成
					if (prog >= 100) {
						await base.sleep(1000);
						clearInterval(ins[index]);
						progress[index] = 0;
						o.item.find('.pl-progress-stop').hide();
						$text.text('下载完成~ 浏览器下载框应该弹出来了哦~');
						o.back.show();
						await base.sleep(3000);
						o.link.text('增强下载(基于浏览器文件流)').animate({ opacity: '1' }, "slow");
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('正在取消...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-copy-filename', async function (e) {
				base.setClipboard(e.target.dataset.filename);
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await base.sendLinkToRPC(e.currentTarget.dataset.link, e.currentTarget.dataset.filename,e.currentTarget.dataset.path, [`Referer: https://${location.host}/`]);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('发送成功了!快去看看吧~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}👉<a href="${config.base.assistant.link}" target="_blank" class="pl-a">点击此处安装</a>👈`);
				} else {
					target.addClass('pl-btn-danger').text('发送失败，检查一下您的RPC配置信息哦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('发送完成，发送结果见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-download-all',async function (e) {//TODO 这你原本写的是//.listener-download-all.blob，怕你写错改了下
				if(navigator.userAgent.match(/Chrom(e|ium)/)){//Chromium内核
					globalDirHandle = await window.showDirectoryPicker();
				}
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('下载开始，下载进度见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('全部增强下载').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdate();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encodeBase(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
			document.documentElement.addEventListener('mouseup', function (e) {
				if (e.target.nodeName === 'A' && ~e.target.className.indexOf('pl-a')) {
					e.stopPropagation();
				}
			}, true);
		},

		greenerPage() {
			base.waitForKeyElements('[class*="share-list-banner"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('[class*="to-app"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('[class*="btn-mobile-save"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('div[class*="text"]', function (tag) {
				if (tag[0].innerHTML.match("SVIP"))
					tag.fadeOut();
			}, true);
			base.waitForKeyElements('[class*="SplashScreenImg--close"]', function (tag) {
				tag[0].click();
			}, true);
			base.waitForKeyElements('[class*="container"]', function (tag) {
				tag.find('[class^="icon-close"]').click();
			}, true);
			base.waitForKeyElements('[class*="popup_main_close"]', function (tag) {
				tag[0].click();
			}, true);
		},
		svg: `<svg class="ali-btn-icon" style="margin-right: 3px;" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M853.333 938.667H170.667a85.333 85.333 0 0 1-85.334-85.334v-384A85.333 85.333 0 0 1 170.667 384H288a32 32 0 0 1 0 64H170.667a21.333 21.333 0 0 0-21.334 21.333v384a21.333 21.333 0 0 0 21.334 21.334h682.666a21.333 21.333 0 0 0 21.334-21.334v-384A21.333 21.333 0 0 0 853.333 448H736a32 32 0 0 1 0-64h117.333a85.333 85.333 0 0 1 85.334 85.333v384a85.333 85.333 0 0 1-85.334 85.334z" fill="#FFFFFF"></path><path d="M715.03 543.552a32.81 32.81 0 0 0-46.251 0L554.005 657.813v-540.48a32 32 0 0 0-64 0v539.734L375.893 543.488a32.79 32.79 0 0 0-46.229 0 32.427 32.427 0 0 0 0 46.037l169.557 168.811a32.81 32.81 0 0 0 46.251 0l169.557-168.81a32.47 32.47 0 0 0 0-45.974z" fill="#FFFFFF"></path></svg>`,
		addButton() {
			base.waitForKeyElements(config.$aliyun.mount.home, (element) => {
				page = $aliyun.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'home') return;
				let $button = $(`<div class="ali-button pl-button"><span data-role="icon" data-render-as="svg" class="icon">${$aliyun.svg}下载助手</span><ul class="pl-dropdown-menu" style="top: 30px; right: 0;"><li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">API 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria" >Aria 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPC 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURL 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc" >BC 下载</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li></ul></div>`);
				element.append($button);
			})
			base.waitForKeyElements(config.$aliyun.mount.share, (element) => {
				page = $aliyun.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'share') return;
				let $button = $(`<div class="ali-button pl-button"><span data-role="icon" data-render-as="svg" class="icon">${$aliyun.svg}下载助手</span><ul class="pl-dropdown-menu" style="top: 30px; right: 16px;"><li class="pl-dropdown-menu-item pl-button-mode pl-button-save">保存后下载</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li></ul></div>`);
				$button.css({ 'margin-right': '10px', "height": "36px", "width": "auto", "padding": "1px 30px" });
				element.prepend($button);
			})
		},
		addInitButton() {
			let $button = $(`<div class="ali-button pl-button-init"><span data-role="icon" data-render-as="svg" class="icon">${$aliyun.svg}点我点亮</span></div>`);
			$button.click(function () { base.initDialog() });
			base.waitForKeyElements(config.$aliyun.mount.home, (element) => {
				page = $aliyun.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'home') return;
				$button.css({ "width": "auto" });
				element.append($button);
			})
			base.waitForKeyElements(config.$aliyun.mount.share, (element) => {
				page = $aliyun.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'share') return;
				$button.css({ 'margin-right': '10px', "height": "36px", "padding": "1px 30px", "width": "auto" });
				element.prepend($button);
			})
		},

		async getFilesByOnce(file,params){
			let res;
			if(page=="home"||page=="main"){
				res = await base.post(config.$aliyun.api.getFiles.home, {
					"all": false,//TODO 取得全部文件，默认是false，但测试时突然取不到了，不知道是不是阿里改了
					"drive_id": params.drive_id,
					"fields": "*",
					"limit": 100,//TODO 第一次20，之后100。省事先统一100看看,以后有问题再改
					"marker":params.marker,
					"order_by": "name",
					"order_direction": "DESC",
					"parent_file_id": params.parent_file_id,
					"url_expire_sec": 14400//4小时后链接失效
					}, {
					"authorization":this.authorization,
					"content-type": "application/json",
					"referer": "https://www.aliyundrive.com/",
					"x-canary": "client=windows,app=adrive,version=v6.0.0"
					}
				);
			}else if(page=="share"){
			}else{
				return message.error(`提示：<br/>网站页面错误`);
			}
			return res;
		},

		async getFileUrlByOnce(d, f) {
			let res = await base.post(config.$aliyun.api.getLink.home, {
				drive_id: d,
				file_id: f
			}, {
				"authorization":this.authorization,
				"content-type": "application/json;charset=utf-8",
				"referer": "https://www.aliyundrive.com/",
				"x-canary": "client=windows,app=adrive,version=v6.0.0"
			});
			if (res.code === 'AccessTokenInvalid') {
				return message.error('提示：<br/>访问令牌过期了，请刷新网页后再试');
			}
			if (res.url) {
				return res.url;
			}
			return '';
		},

		async fetchAllPages(file) {
			//分页获取文件夹内文件数据
			let files=[];//文件数据列表
			let marker='';//文件夹内下一段数据的令牌
			let res;
			
			while (true) {
				//随机停顿防反爬
				this.cnt++;
				if (this.cnt >= 50+Math.random()*10) {
					doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div><div>休息 ${globalSleep} 毫秒...</div>`);
					await base.customSleep();
					this.cnt = 0;
				}

				//发送请求
				let param={"drive_id":file.drive_id,"parent_file_id":file.file_id,"marker":marker};
				res=await this.getFilesByOnce(file,param);

				//请求失败
				if(!res?.items){
					return message.error(`提示：<br/>请求失败`);
				}

				//请求成功
				files=files.concat(res.items)
				marker=res.next_marker;
				if (!marker)
					break;
			}
			return files; 
		},

		async fetchFiles(file,pNode) {
			//节点 
			let fileNode={
				name:file.name,//注意变量名
				path:pNode.name === 'root' ? `` : (pNode.path === '' ? pNode.name : `${pNode.path}/${pNode.name}`),//一般来说，路径不要特别特别长，不然可能会出问题，不过正常是不会的
				children:[]
			}
			pNode.children.push(fileNode);
			file.path=fileNode.path;

			//判断是否文件夹
			if (file?.type!='folder') {//注意变量名
				this.fileCount++;
				doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div>`);
				return file;
			}

			//文件夹内文件遍历
			let files=[];
			for (let f of await this.fetchAllPages(file)) {
				files= files.concat(await this.fetchFiles(f,fileNode));
			}
			return files;
		},

		async getLink() {
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				title: "获取中",
				html: `...`,
				footer: "如果选的文件较多，请耐心等待获取完成哦！",
				customClass: {
					popup: 'loading-popup',
					header: 'loading-header',
					title: 'loading-title',
					content: 'loading-content',
					input: 'loading-input',
					footer: 'loading-footer'
				},
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('提示：<br/>请勾选要下载的文件哦~');
			}
			
			if(page === 'home'){
			}else if(page=="share"){
				//分享页面所需的变量
			}else{
				return message.error('提示：<br/>页面错误~');
			}

			this.authorization= `${base.getStorage('token').token_type} ${base.getStorage('token').access_token}`;
			this.cnt=0; //计数器，用于控制随机延迟
			this.fileCount=0;//文件计数
			let fileList=[];//文件列表，只有文件没有文件夹
			let fileTree = { name: "root", path: ``, children: [] }; // 文件目录树
			if (page === 'home') {
				//获取文件目录结构（递归）
				for (let file of selectList) {
					//遍历选中文件
					//统一变量名
					file.drive_id=file.drive_id||file.driveId;//driveId、fileId全统一成drive_id、file_id
					file.file_id=file.file_id||file.fileId;
					fileList = fileList.concat(await this.fetchFiles(file,fileTree));
				}

				//文件夹为空
				if (!fileList.length) {
					return message.error('提示：<br/>文件夹是空的哦~');
				}
				
				//获取下载链接 
				doc.find('.loading-popup .loading-title').html(`链接获取中`);
				doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取文件对应的下载链接~</div>`);
				let batchSize = 15+Math.ceil(Math.random()*5);
				let i=0;
				while (i < fileList.length){
					// 分批获取链接
					let batch = fileList.slice(i, i + batchSize);

					// 过滤掉已有 URL 的文件
					let noUrlList = batch.filter(v => !Boolean(v.url))

					// 为没有 URL 的文件生成请求队列
					let queue = [];
					noUrlList.forEach( (item, index) => {
							queue.push(this.getFileUrlByOnce(item.drive_id, item.file_id));//浏览器千万别在这附近下断点，不然直接过不去，卡在这的。
						}
					);

					// 等待本批次的请求结果
					let res = await Promise.all(queue);
					res.forEach( (val, index) => {
						noUrlList[index].url = val;
					}
					);

					// 每次处理完一个批次后，等待	
					if (i + batchSize < fileList.length){
						doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${i} / ${fileList.length} 个链接,请耐心等待哦~</div><div>休息 ${globalSleep} 毫秒...</div>`);
						await base.customSleep();
					};

					//累加批次
					i += batchSize;
					batchSize = 15+Math.ceil(Math.random()*5)
				}
			} else {
				return message.error('提示：<br/>页面错误~');
			}

			//显示下载GUI
			if (fileList.length) {
				let html = this.generateDom(fileList);
				base.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
			} else {
				return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
			}
		},

		generateDom(list) {
			if (!list) {
				return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.type === 'folder') return;
				let filename = v.name;
				let fid = v.fileId;
				let did = v.driveId;
				let size = base.sizeFormat(v.size);
				let dlink = v.downloadUrl || v.url;
				let dpath=v.path;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">获取下载链接失败，刷新网页后再试试吧~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary listener-link-api blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接" data-did="${did}" data-fid="${fid}" data-filename="${filename}" data-link="${dlink}" data-size="${v.size}" data-index="${i}" data-path="${dpath}">增强下载(基于浏览器文件流)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="基于浏览器直接打开链接来下载文件，适用于较为古老但支持 iframe 的浏览器，点击“直接下载”后需等待下载提示弹出才能点击下个“直接下载”，否则只会下载后者，此方式下载有可能会被 IDM 捕获下载链接" data-did="${did}" data-fid="${fid}" data-filename="${filename}" data-link="${dlink}" data-index="${i}" data-path="${dpath}">直接下载(基于浏览器链接)</button>
							<button class="pl-item-copy listener-tip pl-btn-primary pl-btn-success listener-copy-filename" data-title="本网盘于下载高峰期时可能不会显示文件名称，这时需要手动复制文件名称到下载工具中" data-filename="${filename}">复制名称</button>
							<button class="pl-item-copy listener-tip pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误" data-filename="${filename}" data-link="${dlink}">复制链接</button>
							<div class="pl-item-tip" style="display: none"><span><span class="pl-ext"></span></span> <span class="listener-back">返回</span></div>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">正在加载进度...0%</div>
									</div>
								</div>
								<button class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">取消下载</button>
								<button class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">返回</button>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = base.convertLinkToAria(dlink, filename, dpath, `--header "Referer: https://${location.host}/"`);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 aria2c 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					} 
					if (mode === 'rpc') {
						dlink=dlink.replace(' ', '%20')
						content += `<div class="pl-item">
									<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
									<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" 
											data-filename="${filename}" 
											data-link="${dlink}" 
											data-path="${dpath}"> <!-- 添加了 data-path 属性 -->
										<svg class="icon-rpc-devices" viewBox="-10 0 1034 1024">
											<g transform="matrix(1 0 0 -1 0 960)">
												<path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" />
											</g>
										</svg>
										<span style="margin-left: 5px;">将 ${filename} 推送到 RPC 下载器</span>
									</button>
								</div>`;
					}
					if (mode === 'curl') {
						let alink = base.convertLinkToCurl(dlink, filename, dpath, `&refer=${encodeURIComponent(`https://${location.host}/`)}`);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 curl 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = base.convertLinkToBC(dlink, filename, `-e "https://${location.host}/"`);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="点击用比特彗星下载" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>下载 ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';

			if (mode === 'rpc') {
				content += `<div class="pl-extra">`
			}
			if (list.length >= 2) {
				if (mode === 'api')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接">全部增强下载</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误">复制全部链接</button></div>`;
				if (mode === 'aria')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button></div>`;
				if (mode === 'rpc') {
					content += `<button class="pl-btn-primary listener-send-rpc">发送全部链接</button>`;
				}
				if (mode === 'curl') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">修改终端类型（${terminalType[base.getValue('setting_terminal_type')]}）</button></div>`;
				}
				if (mode === 'bc') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部链接</button></div>`;
				}
			}
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">修改 RPC 参数（${rpc}）</button>
					<button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">查看下载任务</button>
				</div>`;
			}

			return content;
		},

		getSelectedList() {
			try {
				let selectedList = [];
				let reactDom = document.querySelector(config.$aliyun.mount.list);
				let reactObj = base.findReact(reactDom, 1);
				let props = reactObj.pendingProps;
				if (props) {
					let fileList = props.dataSource || [];
					let selectedKeys = props.selectedKeys.split(',');
					fileList.forEach(function (val) {
						if (selectedKeys.includes(val.fileId)) {
							selectedList.push(val);
						}
					});
				}
				return selectedList;
			} catch (e) {
				return [];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/(drive)/.test(path)) return 'home';
			if (/^\/(s|share)\//.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].type === 'file') return false;
			}
			return true;
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		}
	};

	/**
	 * 中国移动云盘 / 和彩云
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	let $mcloud = {
		cnt:0,//计数器，用于控制随机延迟
		fileCount:0,//文件计数
		authorization:"",//cookies

		addPageListener() {
			/*
			防止代码因其他原因被执行多次
			这段代码出自 Via轻插件，作者谷花泰
			*/
			const key = encodeURIComponent('LinkSwift:移动云盘');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, back, stop, target,
				};
			}

			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				$mcloud.getLink();
			});
			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				selectList = $mcloud.getSelectedList();
				if (selectList.length === 0) {
					return message.error('提示：<br/>请勾选要直接下载的文件哦~');
				}
				if ($mcloud.isOnlyFolder()) {
					return message.error('提示：<br/>请打开文件夹后再勾选文件~');
				}
				message.info('提示：<br/>因网盘限制，只能够通过页面直接下载哦~');
				await base.sleep(500);
				document.querySelector('.btn-top.btn-top_dl').click();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();

				const o = _factory(e);
				const $width = o.item.find('.pl-progress-inner');
				const $text = o.item.find('.pl-progress-inner-text');
				const filename = o.link[0].dataset.filename;
				const path=o.link[0].dataset.path;
				const index = o.link[0].dataset.index;
				const size = Number(o.link[0].dataset.size) || 0;

				base._resetData(index);
				base.get(e.currentTarget.dataset.link, undefined, 'blob', { filename, index, path});

				let startTime = Date.now();
				let prevLoaded = 0;
				let prevTime = startTime;

				ins[index] = setInterval(async function () {
					const prog = +progress[index] || 0;
					const currentTime = Date.now();
					const elapsedTime = currentTime - startTime;
					const loaded = prog * size / 100;
					const timeDiff = Math.max(currentTime - prevTime, 1); // 避免除零
					const speed = ((loaded - prevLoaded) / (timeDiff / 1000)) || 0;

					// 计算剩余时间（保护除零）
					const totalProgress = Math.max(prog / 100, 0.01);
					const totalElapsedSeconds = elapsedTime / 1000;
					const estTotalTime = totalElapsedSeconds / totalProgress;
					const remainingTime = estTotalTime - totalElapsedSeconds;

					// 更新界面状态
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// 更新进度条
					$width.css('width', `${prog}%`);
					$text.text(`${prog.toFixed(1)}% | 速度:${base.sizeFormat(speed)} | 剩余:${base.rtimeFormat(remainingTime)}`);

					// 更新历史值
					prevLoaded = loaded;
					prevTime = currentTime;

					// 下载完成
					if (prog >= 100) {
						await base.sleep(1000);
						clearInterval(ins[index]);
						progress[index] = 0;
						o.item.find('.pl-progress-stop').hide();
						$text.text('下载完成~ 浏览器下载框应该弹出来了哦~');
						o.back.show();
						await base.sleep(3000);
						o.link.text('增强下载(基于浏览器文件流)').animate({ opacity: '1' }, "slow");
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('正在取消...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all',async function (e) {
				if(navigator.userAgent.match(/Chrom(e|ium)/)){//Chromium内核
					globalDirHandle = await window.showDirectoryPicker();
				}
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('下载开始，下载进度见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('全部增强下载').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await base.sendLinkToRPC(e.currentTarget.dataset.link, e.currentTarget.dataset.filename,e.currentTarget.dataset.path);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('发送成功了!快去看看吧~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}👉<a href="${config.base.assistant.link}" target="_blank" class="pl-a">点击此处安装</a>👈`);
				} else {
					target.addClass('pl-btn-danger').text('发送失败，检查一下您的RPC配置信息哦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('发送完成，发送结果见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdate();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encodeBase(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		greenerPage() {
			base.waitForKeyElements(".adv_swiper_menu", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".client-bubble", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".avs-box", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".top-adv-swiper", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".client_download_icon", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".document_top_memberCenter", function (tag) {
				$(tag[0]).click(function () {
					Swal.fire({
						html: `<iframe style="height: 700px; width: 420px; border: 0;" src="https://vip.yun.139.com/vip/"></iframe>`,
						allowOutsideClick: false,
						showCloseButton: true,
						showConfirmButton: false,
						...swalDefault
					});
				});
			}, true);
		},

		addButton() {
			base.waitForKeyElements(config.$mcloud.mount.home, (element) => {
				page = $mcloud.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'home') return;
				let $button = $(`<div class="pl-button mcloud-button btn-top"><span class="mcloud-btn">下载助手</span><ul class="pl-dropdown-menu" style="top:36px;left:0;letter-spacing:normal;"><li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">API 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria" >Aria 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPC 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURL 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc" >BC 下载</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li></ul></div>`);
				element.prepend($button);
			})
			base.waitForKeyElements(config.$mcloud.mount.share, (element) => {
				page = $mcloud.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'share') return;
				let $button = $(`<div class="pl-button mcloud-share-button"><span class="mcloud-btn">下载助手</span><ul class="pl-dropdown-menu" style="top:36px;left:0;letter-spacing:normal;"><li class="pl-dropdown-menu-item pl-button-mode pl-button-save">直接下载</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li></ul></div>`);
				element.prepend($button);
			})
		},

		addInitButton() {
			let $button = $(`<div class="pl-button-init"><span class="mcloud-btn">点我点亮</span></div>`);
			$button.click(function () { base.initDialog() });
			base.waitForKeyElements(config.$mcloud.mount.home, (element) => {
				page = $mcloud.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'home') return;
				$button.addClass('mcloud-button');
				element.prepend($button);
			})
			base.waitForKeyElements(config.$mcloud.mount.share, (element) => {
				page = $mcloud.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'share') return;
				$button.addClass('mcloud-share-button').css({ "cursor": "pointer" });
				element.prepend($button);
			})
		},

		getRandomString(len) {
			len = len || 16;
			let $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';
			let maxPos = $chars.length;
			let pwd = '';
			for (let i = 0; i < len; i++) {
				pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
			}
			return pwd;
		},

		utob(str) {
			const u = String.fromCharCode;
			return str.replace(/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g, function (t) {
				if (t.length < 2) {
					let e = t.charCodeAt(0);
					return e < 128 ? t : e < 2048 ? u(192 | e >>> 6) + u(128 | 63 & e) : u(224 | e >>> 12 & 15) + u(128 | e >>> 6 & 63) + u(128 | 63 & e);
				}
				e = 65536 + 1024 * (t.charCodeAt(0) - 55296) + (t.charCodeAt(1) - 56320);
				return u(240 | e >>> 18 & 7) + u(128 | e >>> 12 & 63) + u(128 | e >>> 6 & 63) + u(128 | 63 & e);
			});
		},

		getSign(e, t, a, n) {
			let r = "",
				i = "";
			if (t) {
				let s = Object.assign({}, t);
				i = JSON.stringify(s),
					i = i.replace(/\s*/g, ""),
					i = encodeURIComponent(i);
				let c = i.split(""),
					u = c.sort();
				i = u.join("");
			}
			let A = md5(base.encodeBase(this.utob(i)));
			let l = md5(a + ":" + n);
			return md5(A + l).toUpperCase();
		},

		async getFilesByOnce(item,params){
			try {
				let res;
				if(page=="home"){
					let body = {
						"pageInfo": {
							"pageSize": 100,
							"pageCursor": params.pageCursor,
							},
							"orderBy": "updated_at",
							"orderDirection": "DESC",
							"parentFileId": item.fileId,
							"imageThumbnailStyleList": [
							"Small",
							"Large"
							]
					};
					let time = new Date(+new Date() + 8 * 3600 * 1000).toJSON().substr(0, 19).replace('T', ' ');
					let key = this.getRandomString(16);
					let sign = this.getSign(undefined, body, time, key);
					res = await base.post(config.$mcloud.api.getFiles.home, body, {
							'Authorization': this.authorization,
							'Caller': 'web',
							'CMS-DEVICE': 'default',
							'Content-Type': "application/json;charset=UTF-8",
							'mcloud-channel': '1000101',
							'mcloud-client': '10701',
							'mcloud-sign': time + "," + key + "," + sign,
							'mcloud-version': '7.14.2',
							'Origin': 'https://yun.139.com',
							'Referer': 'https://yun.139.com/',
							'X-DeviceInfo': '||9|7.14.2|chrome|119.0.0.0|||windows 10||zh-CN|||',
							'X-Huawei-ChannelSrc': '10000034',
							'X-Inner-Ntwk': '2',
							'X-M4C-Caller': 'PC',
							'X-M4C-Src': '10002',
							'X-SvcType': '1',
							'X-Yun-Api-Version': 'v1',
							'X-Yun-App-Channel': '10000034',
							'X-Yun-Channel-Source': '10000034',
							'X-Yun-Client-Info': '||9|7.14.2|chrome|119.0.0.0|||windows 10||zh-CN|||||',
							'X-Yun-Module-Type': '100',
							'X-Yun-Svc-Type': '1'
						}
					);
				}else if(page=="share"){
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error(`提示：<br/>文件获取请求失败`);
			}
		},

		async getFileUrlByOnce(item, index) {
			try {
				if (item.downloadUrl) return {
					index,
					downloadUrl: item.downloadUrl
				};

				if (this.detectPage() === 'home') {
					let body = {
						fileId: item.fileId
					}
					let time = new Date(+new Date() + 8 * 3600 * 1000).toJSON().substr(0, 19).replace('T', ' ');
					let key = this.getRandomString(16);
					let sign = this.getSign(undefined, body, time, key);

					let res = await base.post(config.$mcloud.api.getLink.home, body, {
						'Authorization': base.getCookie('authorization'),
						'Caller': 'web',
						'CMS-DEVICE': 'default',
						'Content-Type': "application/json;charset=UTF-8",
						'mcloud-channel': '1000101',
						'mcloud-client': '10701',
						'mcloud-sign': time + "," + key + "," + sign,
						'mcloud-version': '7.14.2',
						'Origin': 'https://yun.139.com',
						'Referer': 'https://yun.139.com/',
						'X-DeviceInfo': '||9|7.14.2|chrome|119.0.0.0|||windows 10||zh-CN|||',
						'X-Huawei-ChannelSrc': '10000034',
						'X-Inner-Ntwk': '2',
						'X-M4C-Caller': 'PC',
						'X-M4C-Src': '10002',
						'X-SvcType': '1',
						'X-Yun-Api-Version': 'v1',
						'X-Yun-App-Channel': '10000034',
						'X-Yun-Channel-Source': '10000034',
						'X-Yun-Client-Info': '||9|7.14.2|chrome|119.0.0.0|||windows 10||zh-CN|||||',
						'X-Yun-Module-Type': '100',
						'X-Yun-Svc-Type': '1'
					});
					if (res.success) {
						return {
							index,
							downloadUrl: res.data.url
						};
					} else {
						return {
							index,
							downloadUrl: '获取下载地址失败，刷新后再试试吧~'
						};
					}
				}
				if (this.detectPage() === 'share') {
					let vueDom = document.querySelector(".main_file_list").__vue__;

					let res = await base.post(config.$mcloud.api.getShareLink, `linkId=${vueDom.linkID}&contentIds=${item.path}&catalogIds=`, {
						'Content-Type': 'application/x-www-form-urlencoded',
					});
					if (res.code === 0) {
						return {
							index,
							downloadUrl: res.data.redrUrl
						};
					} else {
						return {
							index,
							downloadUrl: '获取下载地址失败，刷新后再试试吧~'
						};
					}
				}
			} catch (e) {
				return {
					index,
					downloadUrl: '获取下载地址失败，刷新后再试试吧~'
				};
			}
		},
		
		async fetchAllPages(file) {
			//分页获取文件夹内文件数据
			let files=[];//文件数据列表
			let nextPageCursor='';//文件夹内下一段数据的令牌
			let res;
			while (true) {
				//随机停顿防反爬
				this.cnt++;
				if (this.cnt >= 50+Math.random()*10) {
					doc.find('.loading-popup .swal2-html-container').html(`<div>正遍历到的大型文件夹（非全部）已获取 ${files.length} 个文件~</div><div>休息 ${globalSleep} 毫秒...</div>`);
					await base.customSleep();
					this.cnt = 0;
				}

				//发送请求
				let params={"parent_file_id":file.fileId,"pageCursor":nextPageCursor};
				res=await this.getFilesByOnce(file,params);

				//请求失败
				if(!res.success){//注意变量名
					return message.error(`提示：<br/>请求失败，失败码：	${res?.code}	失败信息：${res.message}`);
				}

				//请求成功
				files=files.concat(res.data.items)//注意变量名
				nextPageCursor=res.data.nextPageCursor;
				if (!nextPageCursor)
					break;
			}
			return files;
		},

		async fetchFiles(file,pNode) {
			//获取文件目录结构（递归）
			//节点 
			let fileNode={
				name:file.name,//注意变量名
				path:pNode.name === 'root' ? `` : (pNode.path === '' ? pNode.name : `${pNode.path}/${pNode.name}`),//一般来说，路径不要特别特别长，不然可能会出问题，不过正常是不会的
				children:[]
			}
			pNode.children.push(fileNode);
			file.path=fileNode.path;

			//判断是否文件夹
			if (file?.type!="folder") {//注意变量名
				this.fileCount++;
				doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div>`);
				return file;
			}
			
			//文件夹内文件遍历
			let files=[];
			for (let f of await this.fetchAllPages(file)) {
				files= files.concat(await this.fetchFiles(f,fileNode));
			}
			return files;
		},

		async getLink() {
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				title: "获取中",
				html: `...`,
				footer: "如果选的文件较多，请耐心等待获取完成哦！",
				customClass: {
					popup: 'loading-popup',
					header: 'loading-header',
					title: 'loading-title',
					content: 'loading-content',
					input: 'loading-input',
					footer: 'loading-footer'
				},
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('提示：<br/>请勾选要下载的文件哦~');
			}

			this.cnt=0;
			this.fileCount=0;//文件计数
			this.authorization =  base.getCookie('authorization');
			let fileList=[];//文件列表，只有文件没有文件夹
			let fileTree = { name: "root", path: ``, children: [] }; // 文件目录树
			if (page === 'home') {
				//获取文件目录结构（递归）
				for (let file of selectList) {
					//遍历选中文件
					//统一变量名
					file.name=file.name||file.catalogName;
					file.fileId=file.fileId||file.catalogID;
					if(file.catalogID)file.type="folder";
					fileList = fileList.concat(await this.fetchFiles(file,fileTree));
				}
				
				//文件夹为空
				if (!fileList.length) {
					return message.error('提示：<br/>文件夹是空的哦~');
				}

				//获取下载链接 
				doc.find('.loading-popup .loading-title').html(`链接获取中`);
				doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取文件对应的下载链接~</div>`);
				let batchSize = 15+Math.ceil(Math.random()*5);
				let i=0;
				while (i < fileList.length){
					// 分批获取链接
					let batch = fileList.slice(i, i + batchSize);

					// 生成请求队列
					let queue = [];
					batch.forEach((item, localIndex) => {
						let globalIndex = i + localIndex;
						queue.push(this.getFileUrlByOnce(item, globalIndex)
							.then(val => {
								return val;
							}));
					});

					// 等待本批次的请求结果
					let res = await Promise.all(queue);
					res.forEach(val => {
						fileList[val.index].downloadUrl = val.downloadUrl;
					});

					// 每次处理完一个批次后，等待	
					if (i + batchSize < fileList.length){
						doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${i} / ${fileList.length} 个链接,请耐心等待哦~</div><div>休息 ${globalSleep} 毫秒...</div>`);
						await base.customSleep();
					};

					//累加批次
					i += batchSize;
					batchSize = 15+Math.ceil(Math.random()*5)
				}
			} else {
				return message.error('提示：<br/>页面错误~');
			}

			//显示下载GUI
			let html = this.generateDom(fileList);
			base.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
		},

		generateDom(list) {
			if (!list) {
				return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.dirEtag || v.caName) return;
				let filename = v.contentName || v.coName||v.name;
				let size = base.sizeFormat(v.contentSize || v.coSize||v.size);
				let dlink = v.downloadUrl;
				let dpath=v.path;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">获取下载链接失败，刷新网页后再试试吧~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-default listener-link-api blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接" data-filename="${filename}" data-size="${v.contentSize || v.coSize}" data-link="${dlink}" data-index="${i}" data-path="${dpath}">增强下载(基于浏览器文件流)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="基于浏览器直接打开链接来下载文件，适用于较为古老但支持 iframe 的浏览器，点击“直接下载”后需等待下载提示弹出才能点击下个“直接下载”，否则只会下载后者，此方式下载有可能会被 IDM 捕获下载链接" data-filename="${filename}" data-link="${dlink}">直接下载(基于浏览器链接)</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">复制链接</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">正在加载进度...0%</div>
									</div>
								</div>
								<button class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">取消下载</button>
								<button class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">返回</button>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = base.convertLinkToAria(dlink, filename, dpath);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 aria2c 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
									<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
									<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" 
											data-filename="${filename}" 
											data-link="${dlink}" 
											data-path="${dpath}"> <!-- 添加了 data-path 属性 -->
										<svg class="icon-rpc-devices" viewBox="-10 0 1034 1024">
											<g transform="matrix(1 0 0 -1 0 960)">
												<path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" />
											</g>
										</svg>
										<span style="margin-left: 5px;">将 ${filename} 推送到 RPC 下载器</span>
									</button>
								</div>`;
					}
					if (mode === 'curl') {
						let alink = base.convertLinkToCurl(dlink, filename, dpath);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 curl 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = base.convertLinkToBC(dlink, filename);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="点击用比特彗星下载" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>下载 ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';

			if (mode === 'rpc') {
				content += `<div class="pl-extra">`
			}
			if (list.length >= 2) {
				if (mode === 'api')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接">全部增强下载</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误">复制全部链接</button></div>`;
				if (mode === 'aria')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button></div>`;
				if (mode === 'rpc') {
					content += `<button class="pl-btn-primary listener-send-rpc">发送全部链接</button>`;
				}
				if (mode === 'curl') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">修改终端类型（${terminalType[base.getValue('setting_terminal_type')]}）</button></div>`;
				}
				if (mode === 'bc') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部链接</button></div>`;
				}
			}
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">修改 RPC 参数（${rpc}）</button>
					<button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">查看下载任务</button>
				</div>`;
			}

			return content;
		},

		getSelectedList() {
			try {
				return document.querySelector(".main_file_list").__vue__.selectList.map(val => val.item);
			} catch (e) {
				let vueDom = document.querySelector(".home-page").__vue__;
				let fileList = vueDom._computedWatchers.fileList.value;
				let dirList = vueDom._computedWatchers.dirList.value;
				let selectedFileIndex = vueDom.selectedFile;
				let selectedDirIndex = vueDom.selectedDir;
				let selectFileList = fileList.filter((v, i) => {
					return selectedFileIndex.includes(i);
				});
				let selectDirList = dirList.filter((v, i) => {
					return selectedDirIndex.includes(i);
				});
				return [...selectFileList, ...selectDirList];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/w/.test(path)) return 'home';
			if (/^\/link|shareweb/.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].contentID || selectList[i].contentName) return false;
			}
			return true;
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		}
	};

	/**
	 * 天翼云盘
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	let $tcloud = {
		cnt:0,//计数器，用于控制随机延迟
		fileCount:0,//文件计数
		shareId:0,//分享id
		accessCode:"",//访问码


		addPageListener() {
			/*
			防止代码因其他原因被执行多次
			这段代码出自 Via轻插件，作者谷花泰
			*/
			const key = encodeURIComponent('LinkSwift:天翼云盘');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, back, stop, target,
				};
			}

			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				$tcloud.getLink();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();

				const o = _factory(e);
				const $width = o.item.find('.pl-progress-inner');
				const $text = o.item.find('.pl-progress-inner-text');
				const filename = o.link[0].dataset.filename;
				const path=o.link[0].dataset.path;
				const index = o.link[0].dataset.index;
				const size = Number(o.link[0].dataset.size) || 0;

				base._resetData(index);
				base.get(e.currentTarget.dataset.link, undefined, 'blob', { filename, index, path});

				let startTime = Date.now();
				let prevLoaded = 0;
				let prevTime = startTime;

				ins[index] = setInterval(async function () {
					const prog = +progress[index] || 0;
					const currentTime = Date.now();
					const elapsedTime = currentTime - startTime;
					const loaded = prog * size / 100;
					const timeDiff = Math.max(currentTime - prevTime, 1); // 避免除零
					const speed = ((loaded - prevLoaded) / (timeDiff / 1000)) || 0;

					// 计算剩余时间（保护除零）
					const totalProgress = Math.max(prog / 100, 0.01);
					const totalElapsedSeconds = elapsedTime / 1000;
					const estTotalTime = totalElapsedSeconds / totalProgress;
					const remainingTime = estTotalTime - totalElapsedSeconds;

					// 更新界面状态
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// 更新进度条
					$width.css('width', `${prog}%`);
					$text.text(`${prog.toFixed(1)}% | 速度:${base.sizeFormat(speed)} | 剩余:${base.rtimeFormat(remainingTime)}`);

					// 更新历史值
					prevLoaded = loaded;
					prevTime = currentTime;

					// 下载完成
					if (prog >= 100) {
						await base.sleep(1000);
						clearInterval(ins[index]);
						progress[index] = 0;
						o.item.find('.pl-progress-stop').hide();
						$text.text('下载完成~ 浏览器下载框应该弹出来了哦~');
						o.back.show();
						await base.sleep(3000);
						o.link.text('增强下载(基于浏览器文件流)').animate({ opacity: '1' }, "slow");
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('正在取消...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all',async function (e) {
				if(navigator.userAgent.match(/Chrom(e|ium)/)){//Chromium内核
					globalDirHandle = await window.showDirectoryPicker();
				}
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('下载开始，下载进度见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('全部增强下载').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await base.sendLinkToRPC(e.currentTarget.dataset.link, e.currentTarget.dataset.filename,e.currentTarget.dataset.path);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('发送成功了!快去看看吧~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}👉<a href="${config.base.assistant.link}" target="_blank" class="pl-a">点击此处安装</a>👈`);
				} else {
					target.addClass('pl-btn-danger').text('发送失败，检查一下您的RPC配置信息哦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('发送完成，发送结果见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdate();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encodeBase(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		greenerPage() {
			base.waitForKeyElements(".advertising-mask", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements("a.client-download.nav-block", function (tag) {
				tag.fadeOut();
			}, true);
		},

		addButton() {
			let $button = $(`<div class="pl-button tcloud-button">下载助手&nbsp;<i aria-label="icon: caret-down" class="anticon anticon-caret-down"><svg viewBox="0 0 1024 1024" data-icon="caret-down" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><path d="M840.4 300H183.6c-19.7 0-30.7 20.8-18.5 35l328.4 380.8c9.4 10.9 27.5 10.9 37 0L858.9 335c12.2-14.2 1.2-35-18.5-35z"></path></svg></i><ul class="pl-dropdown-menu"><li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">API 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria" >Aria 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPC 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURL 下载</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc" >BC 下载</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li></ul></div>`);
			$button.find(".pl-dropdown-menu").css({ 'position': 'absolute', 'left': '-1px' })
			base.waitForKeyElements(config.$tcloud.mount.home, (element) => {
				page = $tcloud.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'home') return;
				$button.find(".pl-dropdown-menu").css({ 'top': '28px' })
				element.prepend($button);
			})
			base.waitForKeyElements(config.$tcloud.mount.share, (element) => {
				page = $tcloud.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'share') return;
				$button.css({ 'height': '28px', 'border-radius': '15px' })
				$button.find(".pl-dropdown-menu").css({ 'top': '25px' })
				element.prepend($button);
			})
		},

		addInitButton() {
			let $button = $(`<div class="tcloud-button pl-button-init">点我点亮</div>`);
			$button.click(function () { base.initDialog() });
			base.waitForKeyElements(config.$tcloud.mount.home, (element) => {
				page = $tcloud.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'home') return;
				element.prepend($button);
			})
			base.waitForKeyElements(config.$tcloud.mount.share, (element) => {
				page = $tcloud.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'share') return;
				$button.css({ 'height': '28px', 'border-radius': '15px' })
				element.prepend($button);
			})
		},

		async getToken() {
			doc.find('.loading-popup .loading-title').html(`令牌获取中`);
			doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取状态~</div>`);
			let res = await base.getFinalUrl(config.$tcloud.api.getAccessToken, {});
			let accessToken = res.match(/accessToken=(\w+)/)?.[1];
			accessToken && base.setStorage('accessToken', accessToken);
			doc.find('.loading-popup .loading-title').html(`令牌获取中`);
			doc.find('.loading-popup .swal2-html-container').html(`<div>获取成功，令牌已缓存~</div>`);
			return accessToken;
		},

		async getFilesByOnce(item,params){
			let res;
			try {
				if(page=="home"){
					//TODO 我调试过程中res出现过check ip error - curIp=2409::xxxx:xxxx:xxxx:xxxx:xxxx:xxxx, cookiesIp=120.xxx.xxx.xxx，不知是不是抓IP注意下
					let url = `${config.$tcloud.api.getFiles.home}?noCache=${Math.random()}&pageSize=${60}&pageNum=${params.pageNum}&mediaType=0&folderId=${params.id}&iconOption=5&orderBy=lastOpTime&descending=true`;
					res= await base.get(url, {
						"accept": "application/json;charset=UTF-8",
						"sign-type": 1,
						"accept-encoding": "gzip, deflate, br, zstd",
						"accept-language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
						"priority":"u=1, i",
					});
				}else if(page=="share"){//别从自己盘进自己的分享，不然都拿不到自己的密钥（不过也没有这么怪的用户吧……）
					let url = `${config.$tcloud.api.getFiles.share}?noCache=${Math.random()}&pageSize=${60}&pageNum=${params.pageNum}&fileId=${params.id}&shareDirFileId=${params.id}&isFolder=true&shareId=${this.shareId}&shareMode=1&iconOption=5&orderBy=lastOpTime&descending=true&accessCode=${this.accessCode}`;
					res=await base.get(url, {
						"accept": "application/json;charset=UTF-8",
						"sign-type": 1,
					});
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error(`提示：<br/>文件获取请求失败`);
			}
		},

		async getFileUrlByOnce(item, index, token) {
			try {
				let res;
				if(page=="home"){
					if (item.downloadUrl) return {
						index,
						downloadUrl: item.downloadUrl
					};
					let time = Date.now(),
						fileId = item.id,
						o = "AccessToken=" + token + "&Timestamp=" + time + "&fileId=" + fileId,
						url = config.$tcloud.api.getLink.home + '?fileId=' + fileId;
					if (this.shareId) {
						o = "AccessToken=" + token + "&Timestamp=" + time + "&dt=1&fileId=" + fileId + "&shareId=" + this.shareId;
						url += '&dt=1&shareId=' + this.shareId;
					}
					let sign = md5(o).toString();
					res = await base.get(url, {
						"accept": "application/json;charset=UTF-8",
						"sign-type": 1,
						"accesstoken": token,
						"timestamp": time,
						"signature": sign
					});
					if (res.res_code === 0) {
						return {
							index,
							downloadUrl: res.fileDownloadUrl
						};
					} else if (res.errorCode === 'InvalidSessionKey') {
						return {
							index,
							downloadUrl: '提示：<br/>请先登录网盘~'
						};
					} else if (res.res_code === 'ShareNotFoundFlatDir') {
						return {
							index,
							downloadUrl: '提示：<br/>请[转存]文件，之后再👉前往[我的网盘]中下载哦~'
						};
					} else {
						return {
							index,
							downloadUrl: '获取下载地址失败，刷新后再试试吧~' + (res.res_code ? res.res_code : "")
						};
					}
				}
			} catch (e) {
				return {
					index,
					downloadUrl: '获取下载地址失败，刷新后再试试吧~'
				};
			}
		},
		
		async fetchAllPages(file) {
			//分页获取文件夹内文件数据
			let res;
			let files=[];//文件数据列表
			let folders=[];//文件夹数据列表
			let path = file.path ? `${file.path}/${file.name}` : file.name;
			// let pageCount=Math.ceil(file.fileCount/60);//总页数
			let pageCount=1;//总页数，先设1，之后根据res返回的值修改//share没有file.fileCount，兼容适配
			for (let pageNum=1;pageNum<=pageCount;pageNum++) {
				//随机停顿防反爬
				this.cnt++;
				if (this.cnt >= 50+Math.random()*10) {
					doc.find('#loadingText').html(`<div>文件获取中</div><div>已获取 ${this.fileCount} 个文件，请耐心等待哦~</div><div>>休息 ${globalSleep} 毫秒...</div>`);
					await base.sleep(globalSleep+Math.random()*globalSleepRandSeed);
					this.cnt = 0;
				}
				//发送请求
				let param={"pageNum":pageNum,"id":file.id};
				res=await this.getFilesByOnce(file,param);
				
				//请求失败
				if(!(res?.res_code==0&&res?.res_message=="成功")){
					return message.error(`提示：<br/>请求失败，失败码：	${res?.res_code}	失败信息：${res.res_message}`);
				}
				//请求成功
				if(pageCount==1)pageCount=Math.ceil(res.fileListAO.count/60);
				files=files.concat(res.fileListAO.fileList);//注意别占用fileList的变量名字
				folders=folders.concat(res.fileListAO.folderList);
				this.fileCount+=res.fileListAO.fileList.length;
				files.forEach(f => {f.path=path;});
			}
			return {files,folders}; 
		},

		async fetchFiles(file,pNode) {
			//获取文件目录结构（递归）
			//节点 这的节点树因为不怎么需要就没做完整
			let fileNode={
				name:file.name,//注意变量名
				path:pNode.name === 'root' ? `` : (pNode.path === '' ? pNode.name : `${pNode.path}/${pNode.name}`),//一般来说，路径不要特别特别长，不然可能会出问题，不过正常是不会的
				children:[]
			}
			pNode.children.push(fileNode);
			file.path=fileNode.path;

			//判断是否文件夹
			//这个不用判断是否文件夹，返回的数据已经分开了
			doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div>`);
			
			//文件夹内文件遍历
			let { files, folders }=await this.fetchAllPages(file);
			for (let f of folders) {
				files= files.concat(await this.fetchFiles(f,fileNode));
			}
			return files;
		},

		async getLink() {
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				title: "获取中",
				html: `...`,
				footer: "如果选的文件较多，请耐心等待获取完成哦！",
				customClass: {
					popup: 'loading-popup',
					header: 'loading-header',
					title: 'loading-title',
					content: 'loading-content',
					input: 'loading-input',
					footer: 'loading-footer'
				},
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('提示：<br/>请勾选要下载的文件哦~');
			}

			if(page=="home"){
				this.shareId=0;
				this.accessCode="";
			}else if(page=="share"){
				//分享页面所需的变量
				this.shareId=selectList[0].shareId;//分享内容的id
				let share_link=location.search.substring(6);//分享的链接，地址带上访问码也可比如code=MFNRJ3bAfe6r（访问码：9lik）也太怪了吧？
				const percentIndex = share_link.indexOf('%');
				if (percentIndex !== -1) share_link = share_link.substring(0, percentIndex);
				this.accessCode=base.getCookie(`share_${share_link}`);//访问密钥，在cookie里有，但不同的分享的密钥都堆一起了
			}else{
				return message.error('提示：<br/>页面错误~');
			}
			
			this.cnt=0;
			this.fileCount=0;//文件计数
			let fileList=[];//文件列表，只有文件没有文件夹
			let fileTree = { name: "root", path: ``, children: [] }; // 文件目录树
			//获取文件目录结构（递归）
			for (let file of selectList) {
				//遍历选中文件
				//统一变量名
				file.name=file.name||file.fileName;
				file.id=file.id||file.fileId;
				file.size=file.size||file.fileSize;
				if(!file?.isFolder){//非文件夹
					fileList = fileList.concat(file);
					this.fileCount++;
					continue;
				}
				file.fileCount=file.fileData;
				fileList = fileList.concat(await this.fetchFiles(file,fileTree));
			}

			//文件夹为空
			if (!fileList.length) {
				return message.error('提示：<br/>文件夹是空的哦~');
			}

			//获取下载链接 
			doc.find('.loading-popup .loading-title').html(`令牌获取中`);
			doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取状态~</div>`);
			let token = base.getStorage('accessToken') || await this.getToken();
			if (!token) {
				return message.error('提示：<br/>请先登录网盘~');
			}
			doc.find('.loading-popup .loading-title').html(`令牌获取中`);
			doc.find('.loading-popup .swal2-html-container').html(`<div>获取缓存成功~</div>`);
			doc.find('.loading-popup .loading-title').html(`链接获取中`);
			doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取文件对应的下载链接~</div>`);
			let batchSize = globalBatchsize+Math.ceil(Math.random()*5);
			let i=0;
			while (i < fileList.length){
				// 分批获取链接
				let batch = fileList.slice(i, i + batchSize);

				// 生成请求队列
				let queue = [];
				batch.forEach((item, localIndex) => {
					let globalIndex = i + localIndex;
					queue.push(this.getFileUrlByOnce(item, globalIndex, token)
						.then(val => {
							return val;
						}));
				});

				// 等待本批次的请求结果
				let res = await Promise.all(queue);
				res.forEach(val => {
					fileList[val.index].downloadUrl = val.downloadUrl;
				});

				// 每次处理完一个批次后，等待	
				if (i + batchSize < fileList.length){
					doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${i+batch.length} / ${fileList.length} 个链接,请耐心等待哦~</div><div>休息 ${globalSleep} 毫秒...</div>`);
					await base.customSleep();
				};

				//累加批次
				i += batchSize;
				batchSize = globalBatchsize+Math.ceil(Math.random()*5)
			}

			let html = this.generateDom(fileList);
			base.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
		},

		generateDom(list) {
			console.log(list)
			if (!list) {
				return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v?.isFolder) return;
				let filename = v.name;
				let size = base.sizeFormat(v.size);
				let dlink = v.downloadUrl;
				let dpath=v.path;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">获取下载链接失败，刷新网页后再试试吧~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary listener-link-api blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-index="${i}" data-path="${dpath}">增强下载(基于浏览器文件流)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="基于浏览器直接打开链接来下载文件，适用于较为古老但支持 iframe 的浏览器，点击“直接下载”后需等待下载提示弹出才能点击下个“直接下载”，否则只会下载后者，此方式下载有可能会被 IDM 捕获下载链接" data-filename="${filename}" data-link="${dlink}">直接下载(基于浏览器链接)</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">复制链接</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">正在加载进度...0%</div>
									</div>
								</div>
								<button class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">取消下载</button>
								<button class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">返回</button>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = base.convertLinkToAria(dlink, filename, dpath);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 aria2c 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
									<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
									<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" 
											data-filename="${filename}" 
											data-link="${dlink}" 
											data-path="${dpath}"> <!-- 添加了 data-path 属性 -->
										<svg class="icon-rpc-devices" viewBox="-10 0 1034 1024">
											<g transform="matrix(1 0 0 -1 0 960)">
												<path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" />
											</g>
										</svg>
										<span style="margin-left: 5px;">将 ${filename} 推送到 RPC 下载器</span>
									</button>
								</div>`;
					}
					if (mode === 'curl') {
						let alink = base.convertLinkToCurl(dlink, filename, dpath);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 curl 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = base.convertLinkToBC(dlink, filename);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="点击用比特彗星下载" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>下载 ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';

			if (mode === 'rpc') {
				content += `<div class="pl-extra">`
			}
			if (list.length >= 2) {
				if (mode === 'api')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接">全部增强下载</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误">复制全部链接</button></div>`;
				if (mode === 'aria')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button></div>`;
				if (mode === 'rpc') {
					content += `<button class="pl-btn-primary listener-send-rpc">发送全部链接</button>`;
				}
				if (mode === 'curl') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">修改终端类型（${terminalType[base.getValue('setting_terminal_type')]}）</button></div>`;
				}
				if (mode === 'bc') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部链接</button></div>`;
				}
			}
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">修改 RPC 参数（${rpc}）</button>
					<button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">查看下载任务</button>
				</div>`;
			}

			return content;
		},

		getSelectedList() {
			try {
				return document.querySelector(".c-file-list").__vue__.selectedList;
			} catch (e) {
				return [document.querySelector(".info-detail").__vue__.fileDetail];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/web\/main/.test(path)) return 'home';
			if (/^\/web\/share/.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (!selectList[i].isFolder) return false;
			}
			return true;
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
			this.getToken();
		}
	};

	/**
	 * 迅雷云盘
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	let $xunlei = {
		cnt:0,//计数器，用于控制随机延迟
		fileCount:0,//文件计数
		authorization:"",
		token:{},

		addPageListener() {
			/*
			防止代码因其他原因被执行多次
			这段代码出自 Via轻插件，作者谷花泰
			*/
			const key = encodeURIComponent('LinkSwift:迅雷云盘');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, back, stop, target,
				};
			}

			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				$xunlei.getLink();
			});
			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				selectList = $xunlei.getSelectedList();
				if (selectList.length === 0) {
					return message.error('提示：<br/>请勾选要保存到网盘的文件哦~');
				}
				message.info('提示：<br/>因网盘限制，请保存到自己网盘后再去下载哦~');
				await base.sleep(500);
				document.querySelector('.saveToCloud').click();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();

				const o = _factory(e);
				const $width = o.item.find('.pl-progress-inner');
				const $text = o.item.find('.pl-progress-inner-text');
				const filename = o.link[0].dataset.filename;
				const path=o.link[0].dataset.path;
				const index = o.link[0].dataset.index;
				const size = Number(o.link[0].dataset.size) || 0;

				base._resetData(index);
				base.get(e.currentTarget.dataset.link, undefined, 'blob', { filename, index, path});

				let startTime = Date.now();
				let prevLoaded = 0;
				let prevTime = startTime;

				ins[index] = setInterval(async function () {
					const prog = +progress[index] || 0;
					const currentTime = Date.now();
					const elapsedTime = currentTime - startTime;
					const loaded = prog * size / 100;
					const timeDiff = Math.max(currentTime - prevTime, 1); // 避免除零
					const speed = ((loaded - prevLoaded) / (timeDiff / 1000)) || 0;

					// 计算剩余时间（保护除零）
					const totalProgress = Math.max(prog / 100, 0.01);
					const totalElapsedSeconds = elapsedTime / 1000;
					const estTotalTime = totalElapsedSeconds / totalProgress;
					const remainingTime = estTotalTime - totalElapsedSeconds;

					// 更新界面状态
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// 更新进度条
					$width.css('width', `${prog}%`);
					$text.text(`${prog.toFixed(1)}% | 速度:${base.sizeFormat(speed)} | 剩余:${base.rtimeFormat(remainingTime)}`);

					// 更新历史值
					prevLoaded = loaded;
					prevTime = currentTime;

					// 下载完成
					if (prog >= 100) {
						await base.sleep(1000);
						clearInterval(ins[index]);
						progress[index] = 0;
						o.item.find('.pl-progress-stop').hide();
						$text.text('下载完成~ 浏览器下载框应该弹出来了哦~');
						o.back.show();
						await base.sleep(3000);
						o.link.text('增强下载(基于浏览器文件流)').animate({ opacity: '1' }, "slow");
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('正在取消...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all',async function (e) {
				if(navigator.userAgent.match(/Chrom(e|ium)/)){//Chromium内核
					globalDirHandle = await window.showDirectoryPicker();
				}
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('下载开始，下载进度见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('全部增强下载').animate({ opacity: '1' }, "slow");
				}, 2000)
			});

			doc.on('click', '.listener-copy-filename', async function (e) {
				base.setClipboard(e.target.dataset.filename);
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-bc-btn', async function (e) {
				let mirror = base.getMirrorList(e.target.dataset.dlink, config.$xunlei.api.mirror);
				base.setClipboard(mirror);
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await base.sendLinkToRPC(e.currentTarget.dataset.link, e.currentTarget.dataset.filename,e.currentTarget.dataset.path);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('发送成功了!快去看看吧~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}👉<a href="${config.base.assistant.link}" target="_blank" class="pl-a">点击此处安装</a>👈`);
				} else {
					target.addClass('pl-btn-danger').text('发送失败，检查一下您的RPC配置信息哦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('发送完成，发送结果见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdate();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encodeBase(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		addButton() {
			base.waitForKeyElements(config.$xunlei.mount.home, (element) => {
				page = $xunlei.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'home') return;
				let $button = $(`<div class="xunlei-button pl-button"><i class="xlpfont xlp-download"></i><span style="font-size: 13px;margin-left: 6px;">下载助手</span>
					<ul class="pl-dropdown-menu" style="top: 34px;">
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">API 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria">Aria 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURL 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc">BC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li>
					</ul>
				</div>`);
				element.prepend($button);
			})
			base.waitForKeyElements(config.$xunlei.mount.share, (element) => {
				page = $xunlei.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'share') return;
				let $button = $(`<div class="xunlei-button pl-button">
					<i class="xlpfont xlp-download"></i><span style="font-size: 13px;margin-left: 6px;">下载助手</span>
					<ul class="pl-dropdown-menu" style="top: 34px;">
						<li class="pl-dropdown-menu-item pl-button-mode pl-button-save"><i class="xlpfont xlp-file-upload"></i><span style="margin-left: 3px;">转存后下载</span></li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li>
					</ul>
				</div>`);
				$button.css({ 'margin-right': '10px' });
				element.prepend($button);
			})
		},

		addInitButton() {
			let $button = $(`<div class="xunlei-button pl-button-init"><i class="xlpfont xlp-download"></i><span style="font-size: 13px;margin-left: 6px;">点我点亮</span></div>`);
			$button.click(function () { base.initDialog() });
			base.waitForKeyElements(config.$xunlei.mount.home, (element) => {
				page = $xunlei.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'home') return;
				element.prepend($button);
			})
			base.waitForKeyElements(config.$xunlei.mount.share, (element) => {
				page = $xunlei.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'share') return;
				$button.css({ 'margin-right': '10px' });
				element.prepend($button);
			})
		},

		getToken() {
			doc.find('.loading-popup .loading-title').html(`令牌获取中`);
			doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取状态~</div>`);
			let credentials = {}, captcha = {};
			for (let i = 0; i < localStorage.length; i++) {
				if (/^credentials_/.test(localStorage.key(i))) {
					credentials = base.getStorage(localStorage.key(i));
					base.setStorage('');
				}
				if (/^captcha_[\w]{16}/.test(localStorage.key(i))) {
					captcha = base.getStorage(localStorage.key(i));
				}
			}
			let deviceid = /(\w{32})/.exec(base.getStorage('deviceid').split(','))[0];
			let token = {
				credentials,
				captcha,
				deviceid
			};
			return token;
		},

		async getFilesByOnce(item,params){
			let res;
			try {
				if(page=="home"){
					//limit最多只能获取到200，res返回参数里有个 next_page_token 是令牌，如果是空的就说明不需要下一页
					//中间奇怪的那段是URL编码的JSON字符串,第1次请求是不带parent_id之前的&的，后面请求是带parent_id前的&的，但都适用
					let url=`${config.$xunlei.api.getFiles.home}page_token=${params.next_page_token}&parent_id=${params.parent_id}&filters=%7B%22phase%22%3A%7B%22eq%22%3A%22PHASE_TYPE_COMPLETE%22%7D%2C%22trashed%22%3A%7B%22eq%22%3Afalse%7D%7D&with_audit=true&limit=50`;
					res = await base.get(url, {
						'Authorization': this.authorization,
						'content-type': "application/json",
						'x-captcha-token': this.token.captcha.token,
						'x-device-id': this.token.deviceid,
					});
				}else if(page=="share"){
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error('提示：<br/>请先登录网盘后再刷新页面呢~');
			}
		},

		async getFileUrlByOnce(item, index, token) {
			let res;
			try {
				if(page=="home"){
					if (item.downloadUrl) return {
						index,
						downloadUrl: item.downloadUrl
					};
					res = await base.get(config.$xunlei.api.getLink.home + item.id, {
						'Authorization': `${token.credentials.token_type} ${token.credentials.access_token}`,
						'content-type': "application/json",
						'x-captcha-token': token.captcha.token,
						'x-device-id': token.deviceid,
					});
					if (res.web_content_link) {
						return {
							index,
							downloadUrl: res.web_content_link
						};
					} else {
						return {
							index,
							downloadUrl: '获取下载地址失败，刷新后再试试吧~'
						};
					}
				}else if(page=="share"){
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error('提示：<br/>请先登录网盘后再刷新页面呢~');
			}
		},
		
		async fetchAllPages(file) {
			//分页获取文件夹内文件数据
			let files=[];//文件数据列表
			let next_page_token='';//文件夹内下一段数据的令牌
			let res;
			while (true) {
				//随机停顿防反爬
				this.cnt++;
				if (this.cnt >= 50+Math.random()*10) {
					doc.find('.loading-popup .swal2-html-container').html(`<div>正遍历到的大型文件夹（非全部）已获取 ${files.length} 个文件~</div><div>休息 ${globalSleep} 毫秒...</div>`);
					await base.customSleep();
					this.cnt = 0;
				}

				//发送请求
				let param={"next_page_token":next_page_token,"parent_id":file.id};
				res=await this.getFilesByOnce(file,param);

				//请求失败
				if(!res?.files){//注意变量名
					return message.error(`提示：<br/>请求失败，失败码：	${res?.code}	失败信息：${res.message}`);
				}

				//请求成功
				files=files.concat(res.files)//注意变量名
				next_page_token=res.next_page_token;
				if (!next_page_token)
					break;
			}
			return files;
		},

		async fetchFiles(file,pNode) {
			//获取文件目录结构（递归）
			//节点 
			let fileNode={
				name:file.name,//注意变量名
				path:pNode.name === 'root' ? `` : (pNode.path === '' ? pNode.name : `${pNode.path}/${pNode.name}`),//一般来说，路径不要特别特别长，不然可能会出问题，不过正常是不会的
				children:[]
			}
			pNode.children.push(fileNode);
			file.path=fileNode.path;

			//判断是否文件夹
			if (file?.kind!='drive#folder') {//注意变量名
				this.fileCount++;
				doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div>`);
				return file;
			}
			
			//文件夹内文件遍历
			let files=[];
			for (let f of await this.fetchAllPages(file)) {
				files= files.concat(await this.fetchFiles(f,fileNode));
			}
			return files;
		},

		async getLink() {
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				title: "获取中",
				html: `...`,
				footer: "如果选的文件较多，请耐心等待获取完成哦！",
				customClass: {
					popup: 'loading-popup',
					header: 'loading-header',
					title: 'loading-title',
					content: 'loading-content',
					input: 'loading-input',
					footer: 'loading-footer'
				},
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('提示：<br/>请勾选要下载的文件哦~');
			}

			if(page=="home"){
			}else if(page=="share"){
				//分享页面所需的变量
			}else{
				return message.error('提示：<br/>页面错误~');
			}
			this.token =  this.getToken();
			this.authorization = `${this.token.credentials.token_type} ${this.token.credentials.access_token}`;

			this.cnt=0;
			this.fileCount=0;//文件计数
			let fileList=[];//文件列表，只有文件没有文件夹
			let fileTree = { name: "root", path: ``, children: [] }; // 文件目录树
			if (page === 'home') {
				//获取文件目录结构（递归）
				for (let file of selectList) {
					//遍历选中文件
					//统一变量名
					fileList = fileList.concat(await this.fetchFiles(file,fileTree));
				}
	
				//文件夹为空
				if (!fileList.length) {
					return message.error('提示：<br/>文件夹是空的哦~');
				}
	
				//获取下载链接 
				doc.find('.loading-popup .loading-title').html(`链接获取中`);
				doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取文件对应的下载链接~</div>`);
				let batchSize = globalBatchsize+Math.ceil(Math.random()*5);
				let i=0;
				while (i < fileList.length){
					// 分批获取链接
					let batch = fileList.slice(i, i + batchSize);

					// 生成请求队列
					let queue = [];
					batch.forEach((item, localIndex) => {
						let globalIndex = i + localIndex;
						queue.push(this.getFileUrlByOnce(item, globalIndex, this.token)
							.then(val => {
								// doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${processed} / ${selectList.length} 个链接~</div>`);
								return val;
							}));
					});

					let res = await Promise.all(queue);
					res.forEach(val => {
						fileList[val.index].downloadUrl = val.downloadUrl;
					});

					// 每次处理完一个批次后，等待	
					if (i + batchSize < fileList.length){
						doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${i+batch.length} / ${fileList.length} 个链接,请耐心等待哦~</div><div>休息 ${globalSleep} 毫秒...</div>`);
						await base.customSleep();
					};
	
					//累加批次
					i += batchSize;
					batchSize = globalBatchsize+Math.ceil(Math.random()*5)
				}
			} else {
				return message.error('提示：<br/>页面错误~');
			}
			let html = this.generateDom(fileList);
			base.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);

		},

		generateDom(list) {
			if (!list) {
				return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.kind === 'drive#folder') return;
				let filename = v.name;
				let size = base.sizeFormat(+v.size);
				let dlink = v.downloadUrl;
				let dpath=v.path;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">获取下载链接失败，刷新网页后再试试吧~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary listener-link-api blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，下载完成可自动命名，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-index="${i}" data-path="${dpath}">增强下载(基于浏览器文件流)</button>
							<a class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="基于浏览器直接打开链接来下载文件，适用于较为古老但支持 iframe 的浏览器，点击“直接下载”后需等待下载提示弹出才能点击下个“直接下载”，否则只会下载后者，若服务器未回报文件名，此方式下载不会被 IDM 捕获下载链接，此时建议右键此按钮，选择 “使用 IDM 下载”" data-filename="${filename}" data-link="${dlink}" href="${dlink}">直接下载(基于浏览器链接)</a>
							<button class="pl-item-copy listener-tip pl-btn-primary pl-btn-success listener-copy-filename" data-title="本网盘下载时可能不会显示文件名称，这时需要手动复制文件名称到下载工具中" data-filename="${filename}">复制名称</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">复制链接</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">正在加载进度...0%</div>
									</div>
								</div>
								<button class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">取消下载</button>
								<button class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">返回</button>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = base.convertLinkToAria(dlink, filename, dpath);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 aria2c 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
									<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
									<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" 
											data-filename="${filename}" 
											data-link="${dlink}" 
											data-path="${dpath}"> <!-- 添加了 data-path 属性 -->
										<svg class="icon-rpc-devices" viewBox="-10 0 1034 1024">
											<g transform="matrix(1 0 0 -1 0 960)">
												<path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" />
											</g>
										</svg>
										<span style="margin-left: 5px;">将 ${filename} 推送到 RPC 下载器</span>
									</button>
								</div>`;
					}
					if (mode === 'curl') {
						let alink = base.convertLinkToCurl(dlink, filename, dpath);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 curl 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = base.convertLinkToBC(dlink, filename);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="点击用比特彗星下载" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>下载 ${filename}</a>
							<button class="pl-btn-primary listener-link-bc-btn" data-dlink="${dlink}">复制镜像地址</div>
						</div>`;
					}
				}
			});
			content += '</div>';

			if (mode === 'rpc') {
				content += `<div class="pl-extra">`
			}
			if (list.length >= 2) {
				if (mode === 'api')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接">全部增强下载</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误">复制全部链接</button></div>`;
				if (mode === 'aria')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button></div>`;
				if (mode === 'rpc') {
					content += `<button class="pl-btn-primary listener-send-rpc">发送全部链接</button>`;
				}
				if (mode === 'curl') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">修改终端类型（${terminalType[base.getValue('setting_terminal_type')]}）</button></div>`;
				}
				if (mode === 'bc') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部链接</button></div>`;
				}
			}
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">修改 RPC 参数（${rpc}）</button>
					<button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">查看下载任务</button>
				</div>`;
			}

			return content;
		},

		getSelectedList() {
			try {
				let doms = document.querySelectorAll('.SourceListItem__item--XxpOC');
				let selectedList = [];
				for (let dom of doms) {
					let domVue = dom.__vue__;
					if (domVue.selected.includes(domVue.info.id)) {
						selectedList.push(domVue.info);
					}
				}
				return selectedList;
			} catch (e) {
				return [];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/$/.test(path)) return 'home';
			if (/^\/(s|share)\//.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].kind === 'drive#file') return false;
			}
			return true;
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		}
	};

	/**
	 * 夸克网盘
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	let $quark = {
		cnt:0,//计数器，用于控制随机延迟
		fileCount:0,//文件计数

		addPageListener() {
			/*
			防止代码因其他原因被执行多次
			这段代码出自 Via轻插件，作者谷花泰
			*/
			const key = encodeURIComponent('LinkSwift:夸克网盘');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, back, stop, target,
				};
			}

			window.addEventListener('hashchange', async function (e) {
				let home = 'https://pan.quark.cn/list#/', all = 'https://pan.quark.cn/list#/list/all';
				if (e.oldURL === home && e.newURL === all) return;
				await base.sleep(150);
				if ($('.quark-button').length > 0) return;
				if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
					this.addButton();
					this.addPageListener();
				} else {
					this.addInitButton();
				}
			});
			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				$quark.getLink();
			});
			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				selectList = $quark.getSelectedList();
				if (selectList.length === 0) {
					return message.error('提示：<br/>请勾选要保存到网盘的文件哦~');
				}
				message.info('提示：<br/>因网盘限制，请保存到自己网盘后再去下载哦~');
				await base.sleep(500);
				document.querySelector('.share-path').click();
				base.waitForKeyElements(".btn-file.btn-file-primary.confirm-btn", (element) => {
					element.one("click", async () => {
						await base.sleep(1000);
						document.querySelector('.share-save').click();
					})
					return true;
				}, true)
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();

				const o = _factory(e);
				const $width = o.item.find('.pl-progress-inner');
				const $text = o.item.find('.pl-progress-inner-text');
				const filename = o.link[0].dataset.filename;
				const path=o.link[0].dataset.path;
				const index = o.link[0].dataset.index;
				const size = Number(o.link[0].dataset.size) || 0;

				base._resetData(index);
				base.get(e.currentTarget.dataset.link, undefined, 'blob', { filename, index, path});

				let startTime = Date.now();
				let prevLoaded = 0;
				let prevTime = startTime;

				ins[index] = setInterval(async function () {
					const prog = +progress[index] || 0;
					const currentTime = Date.now();
					const elapsedTime = currentTime - startTime;
					const loaded = prog * size / 100;
					const timeDiff = Math.max(currentTime - prevTime, 1); // 避免除零
					const speed = ((loaded - prevLoaded) / (timeDiff / 1000)) || 0;

					// 计算剩余时间（保护除零）
					const totalProgress = Math.max(prog / 100, 0.01);
					const totalElapsedSeconds = elapsedTime / 1000;
					const estTotalTime = totalElapsedSeconds / totalProgress;
					const remainingTime = estTotalTime - totalElapsedSeconds;

					// 更新界面状态
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// 更新进度条
					$width.css('width', `${prog}%`);
					$text.text(`${prog.toFixed(1)}% | 速度:${base.sizeFormat(speed)} | 剩余:${base.rtimeFormat(remainingTime)}`);

					// 更新历史值
					prevLoaded = loaded;
					prevTime = currentTime;

					// 下载完成
					if (prog >= 100) {
						await base.sleep(1000);
						clearInterval(ins[index]);
						progress[index] = 0;
						o.item.find('.pl-progress-stop').hide();
						$text.text('下载完成~ 浏览器下载框应该弹出来了哦~');
						o.back.show();
						await base.sleep(3000);
						o.link.text('增强下载(基于浏览器文件流)').animate({ opacity: '1' }, "slow");
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('正在取消...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all',async function (e) {
				if(navigator.userAgent.match(/Chrom(e|ium)/)){//Chromium内核
					globalDirHandle = await window.showDirectoryPicker();
				}
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('下载开始，下载进度见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('全部增强下载').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await base.sendLinkToRPC(e.currentTarget.dataset.link, e.currentTarget.dataset.filename,e.currentTarget.dataset.path, [`Cookie: ${document.cookie}`]);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('发送成功了!快去看看吧~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}👉<a href="${config.base.assistant.link}" target="_blank" class="pl-a">点击此处安装</a>👈`);
				} else {
					target.addClass('pl-btn-danger').text('发送失败，检查一下您的RPC配置信息哦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('发送完成，发送结果见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdate();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encodeBase(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		greenerPage() {
			base.waitForKeyElements('[class*="Activity--video-toolbar-activity"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('span[class*="SectionHeaderController--icon-download"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('div[class*="SectionHeaderController--download-popover"]', function (tag) {
				tag.find(".ant-popover-arrow").css({ "left": "75%" });
			}, true);
			base.waitForKeyElements('div[class*="DetailLayout--client-download"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".next-box.share-right-side-content", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('[class*="DetailLayout--container"] .feature-screen', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('.ant-modal-content .ant-modal-body .right-wrap', function (tag) {
				if (tag.find(".hint").text().includes("客户端")) tag.fadeOut();
			}, true);
			base.waitForKeyElements(".pc-member-entrance span.button-text", function (tag) {
				tag.text("会员中心");
				let observer = new MutationObserver(function (mutations) {
					mutations.forEach(function (mutation) {
						if (tag.text() === "会员中心") return
						tag.text("会员中心");
					});
				});
				let config = { subtree: true, characterData: true, childList: true };
				observer.observe(tag[0], config);
			}, true);
			base.waitForKeyElements(".pc-member-entrance .tips", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".modal .modal-content .halo-animated-background .halo-content .pay-modal .close", function (tag) {
				tag[0].click();
			}, true);
			base.waitForKeyElements(".modal .modal-content .halo-animated-background .halo-content .red-envelope .close", function (tag) {
				tag[0].click();
			}, true);
		},
		svg: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNOSAxMmwyIDIgMi0yeiIvPjxwYXRoIGQ9Ik0xNCA4aDEuNTUzYy44NSAwIDEuMTYuMDkzIDEuNDcuMjY3LjMxMS4xNzQuNTU2LjQzLjcyMi43NTYuMTY2LjMyNi4yNTUuNjUuMjU1IDEuNTR2NC44NzNjMCAuODkyLS4wODkgMS4yMTUtLjI1NSAxLjU0LS4xNjYuMzI3LS40MS41ODMtLjcyMi43NTctLjMxLjE3NC0uNjIuMjY3LTEuNDcuMjY3SDYuNDQ3Yy0uODUgMC0xLjE2LS4wOTMtMS40Ny0uMjY3YTEuNzc4IDEuNzc4IDAgMDEtLjcyMi0uNzU2Yy0uMTY2LS4zMjYtLjI1NS0uNjUtLjI1NS0xLjU0di00Ljg3M2MwLS44OTIuMDg5LTEuMjE1LjI1NS0xLjU0LjE2Ni0uMzI3LjQxLS41ODMuNzIyLS43NTcuMzEtLjE3NC42Mi0uMjY3IDEuNDctLjI2N0gxMSIvPjxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0iTTExIDN2MTAiLz48L2c+PC9zdmc+',
		addButton() {
			base.waitForKeyElements(config.$quark.mount.home, (element) => {
				page = $quark.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'home') return;
				let $button = $(`<div class="ant-dropdown-trigger pl-button">
					<button type="button" class="quark-button ant-btn btn-file ant-btn-primary">
						<img class="quark-btn-icon" src="${$quark.svg}"><span>下载助手</span>
					</button>
					<ul class="pl-dropdown-menu">
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">API 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria">Aria 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURL 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc">BC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li>
					</ul>
				</div>`);
				$button.css({ "margin-right": "10px", "display": "inline-block" });
				element.prepend($button);
			})
			base.waitForKeyElements(config.$quark.mount.share, (element) => {
				page = $quark.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'share') return;
				let $button = $(`<button type="button" class="ant-btn btn-file ant-btn-primary pl-button quark-button"><img class="quark-btn-icon" src="${$quark.svg}"><span>下载助手</span><ul class="pl-dropdown-menu" style="bottom:20px;left:0"><li class="pl-dropdown-menu-item pl-button-mode pl-button-save"><span class="share-save-ico"></span>保存后下载</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li></ul></button>`);
				$button.css({ "height": "36px", "margin-left": "16px", "border-radius": "6px", "display": "inline-block" });
				element.append($button);
			})
		},

		addInitButton() {
			base.waitForKeyElements(config.$quark.mount.home, (element) => {
				page = $quark.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'home') return;
				let $button = $(`<div class="ant-dropdown-trigger pl-button-init"><button type="button" class="quark-button ant-btn btn-file ant-btn-primary"><img class="quark-btn-icon" src="${$quark.svg}"><span>点我点亮</span></button></div>`);
				$button.css({ "margin-right": "10px", "display": "inline-block" });
				$button.click(function () { base.initDialog() });
				element.prepend($button);
			})
			base.waitForKeyElements(config.$quark.mount.share, (element) => {
				page = $quark.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'share') return;
				let $button = $(`<button type="button" class="ant-btn btn-file ant-btn-primary pl-button-init quark-button"><img class="quark-btn-icon" src="${$quark.svg}"><span>点我点亮</span></button>`);
				$button.css({ "height": "36px", "margin-left": "16px", "border-radius": "6px", "display": "inline-block" });
				$button.click(function () { base.initDialog() });
				element.append($button);
			})
		},

		async getFilesByOnce(item,params){
			try {
				let res;
				if(page=="home"){
					let url=`${config.$quark.api.getFiles.home}&uc_param_str=&pdir_fid=${item.fid}&_page=${params.pageNum}&_size=50&_fetch_total=1&_fetch_sub_dirs=0&_sort=file_type:asc,file_name:asc`;
					res = await base.get(url, { "User-Agent": config.$quark.api.ua.downloadLink });
				}else if(page=="share"){
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error(`提示：<br/>文件获取请求失败`);
			}
		},

		async getFileUrlByOnce(item, params) {
			try {
				let res;
				if(page=="home"){
					res = await base.post(config.$quark.api.getLink.home, { "fids": params.fids }, { "content-type": "application/json;charset=utf-8", "user-agent": config.$quark.api.ua.downloadLink });
				}else if(page=="share"){
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error(`提示：<br/>文件下载链接请求失败`);
			}
		},
		
		async fetchAllPages(file) {
			//分页获取文件夹内文件数据
			let files=[];//文件数据列表
			let pageCount=Math.ceil(file.include_items/50);//总页数
			for (let pageNum=1;pageNum<=pageCount;pageNum++) {
				//随机停顿防反爬
				this.cnt++;
				if (this.cnt >= 50+Math.random()*10) {
					doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div><div>休息 ${globalSleep} 毫秒...</div>`);
					await base.customSleep();
					this.cnt = 0;
				}
				//发送请求
				let param={"page":pageNum};
				let res=await this.getFilesByOnce(file,param);
				//请求失败
				if (res.code === 31001) {//TODO 可能是这样，没测试，可能要等很久账号掉了，我没时间等
					return message.error('提示：<br/>请先登录网盘~<br/>代码：' + res.code);
				}
				if (res.code !== 0) {
					return message.error('提示：<br/>获取链接失败了~<br/>代码：' + res.code);
				}
				//请求成功
				files=files.concat(res.data.list)
			}
			return files; 
		},

		async fetchFiles(file,pNode) {
			//获取文件目录结构（递归）
			//节点
			let fileNode={
				name:file.file_name,
				path:pNode.name === 'root' ? `` : (pNode.path === '' ? pNode.name : `${pNode.path}/${pNode.name}`),//一般来说，路径不要特别特别长，不然可能会出问题，不过正常是不会的
				children:[]
			}
			pNode.children.push(fileNode)
			file.path=fileNode.path;

			//判断是否文件夹
			if (!file?.dir) {
				this.fileCount++;
				doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div>`);
				return file;
			}

			//文件夹内文件遍历
			let files=[];
			for (let f of await this.fetchAllPages(file)) {
				files= files.concat(await this.fetchFiles(f,fileNode));
			}
			return files;
		},

		async getLink() {
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				title: "获取中",
				html: `...`,
				footer: "如果选的文件较多，请耐心等待获取完成哦！",
				customClass: {
					popup: 'loading-popup',
					header: 'loading-header',
					title: 'loading-title',
					content: 'loading-content',
					input: 'loading-input',
					footer: 'loading-footer'
				},
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('提示：<br/>请勾选要下载的文件哦~');
			}

			if(page=="home"){
			}else if(page=="share"){
				//分享页面所需的变量
			}else{
				return message.error('提示：<br/>页面错误~');
			}
			
			this.cnt=0; //计数器，用于控制随机延迟
			this.fileCount=0;//文件计数
			let fileList=[];//文件列表，只有文件没有文件夹
			let fileTree = { name: "root", path: ``, children: [] }; // 文件目录树

			if (page === 'home') {
				//获取文件目录结构（递归）
				for (let file of selectList) {
					//遍历选中文件
					//统一变量名
					fileList = fileList.concat(await this.fetchFiles(file,fileTree));
				}

				//文件夹为空
				if (!fileList.length) {
					return message.error('提示：<br/>文件夹是空的哦~');
				}

				//获取下载链接 
				//TODO 我认为连续访问网盘的接口不如直接拿全部ID合适，post协议本身不作数据长度上限，即使后台限制为1M，也有65536个文件ID了，你如果觉得不合适可以修改
				let fids = fileList.map(item => item.fid);
				let params={"fids":fids};
				let res = await this.getFileUrlByOnce(undefined,params);
				if (res.code === 31001) {
					return message.error('提示：<br/>请先登录网盘~<br/>代码：' + res.code);
				}
				if (res.code !== 0) {
					return message.error('提示：<br/>获取链接失败了~<br/>代码：' + res.code);
				}
				if (res.data.length!=fids.length)
					return message.error('提示：<br/>获取下载链接数目不对，请重新尝试，若文件数目太多，如好几万个文件，请联系作者修改<br/>');

				//显示下载GUI
				let data = res.data.map((element, index) => {
					return {
						...element,
						path: fileList[index].path//TODO 请求的ID和返回的ID的列表顺序是一一对应的，如果有问题请告诉我或自行修改
					};
				});
				let html = this.generateDom(data);
				base.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
			} else {
				return message.error('提示：<br/>页面错误~');
			}
		},

		generateDom(list) {
			if (!list) {
				return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.file === false) return;
				let filename = v.file_name;
				let fid = v.fid;
				let size = base.sizeFormat(v.size);
				let dlink = v.download_url;
				let dpath=v.path;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">获取下载链接失败，刷新网页后再试试吧~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-default listener-link-api blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-fid="${fid}" data-index="${i}" data-path="${dpath}">增强下载(基于浏览器文件流)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="基于浏览器直接打开链接来下载文件，适用于较为古老但支持 iframe 的浏览器，点击“直接下载”后需等待下载提示弹出才能点击下个“直接下载”，否则只会下载后者，此方式下载有可能会被 IDM 捕获下载链接" data-filename="${filename}" data-link="${dlink}" data-fid="${fid}">直接下载(基于浏览器链接)</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">复制链接</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">正在加载进度...0%</div>
									</div>
								</div>
								<button class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">取消下载</button>
								<button class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">返回</button>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = base.convertLinkToAria(dlink, filename, dpath, `--header "Cookie: ${document.cookie}"`);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 aria2c 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
									<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
									<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" 
											data-filename="${filename}" 
											data-link="${dlink}" 
											data-path="${dpath}"> <!-- 添加了 data-path 属性 -->
										<svg class="icon-rpc-devices" viewBox="-10 0 1034 1024">
											<g transform="matrix(1 0 0 -1 0 960)">
												<path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" />
											</g>
										</svg>
										<span style="margin-left: 5px;">将 ${filename} 推送到 RPC 下载器</span>
									</button>
								</div>`;
					}
					if (mode === 'curl') {
						let alink = base.convertLinkToCurl(dlink, filename, dpath, `-b "${document.cookie}"`);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 curl 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = base.convertLinkToBC(dlink, filename, `cookie=${encodeURIComponent(document.cookie)}`);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="点击用比特彗星下载" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>下载 ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';

			if (mode === 'rpc') {
				content += `<div class="pl-extra">`
			}
			if (list.length >= 2) {
				if (mode === 'api')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接">全部增强下载</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误">复制全部链接</button></div>`;
				if (mode === 'aria')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button></div>`;
				if (mode === 'rpc') {
					content += `<button class="pl-btn-primary listener-send-rpc">发送全部链接</button>`;
				}
				if (mode === 'curl') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">修改终端类型（${terminalType[base.getValue('setting_terminal_type')]}）</button></div>`;
				}
				if (mode === 'bc') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部链接</button></div>`;
				}
			}
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">修改 RPC 参数（${rpc}）</button>
					<button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">查看下载任务</button>
				</div>`;
			}

			return content;
		},

		getSelectedList() {
			try {
				let selectedList = [];
				let reactDom = document.getElementsByClassName('file-list')[0];
				let reactObj = base.findReact(reactDom);
				let props = reactObj.props;
				if (props) {
					let fileList = props.list || [];
					let selectedKeys = props.selectedRowKeys || [];
					fileList.forEach(function (val) {
						if (selectedKeys.includes(val.fid)) {
							selectedList.push(val);
						}
					});
				}
				return selectedList;
			} catch (e) {
				return [];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/(list)/.test(path)) return 'home';
			if (/^\/(s|share)\//.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].file) return false;
			}
			return true;
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		}
	};

	/**
	 * UC网盘
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	let $uc = {
		cnt:0,//计数器，用于控制随机延迟
		fileCount:0,//文件计数

		addPageListener() {
			/*
			防止代码因其他原因被执行多次
			这段代码出自 Via轻插件，作者谷花泰
			*/
			const key = encodeURIComponent('LinkSwift:UC网盘');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, back, stop, target,
				};
			}

			window.addEventListener('hashchange', async function (e) {
				let home = 'https://drive.uc.cn/list#/', all = 'https://drive.uc.cn/list#/list/all';
				if (e.oldURL === home && e.newURL === all) return;
				await base.sleep(150);
				if ($('.uc-button').length > 0) return;
				if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
					this.addButton();
					this.addPageListener();
				} else {
					this.addInitButton();
				}
			});
			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				$uc.getLink();
			});
			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				selectList = $uc.getSelectedList();
				if (selectList.length === 0) {
					return message.error('提示：<br/>请勾选要保存到网盘的文件哦~');
				}
				message.info('提示：<br/>因网盘限制，请保存到自己网盘后再去下载哦~');
				await base.sleep(500);
				document.querySelector('.file-info_r').click();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();

				const o = _factory(e);
				const $width = o.item.find('.pl-progress-inner');
				const $text = o.item.find('.pl-progress-inner-text');
				const filename = o.link[0].dataset.filename;
				const path=o.link[0].dataset.path;
				const index = o.link[0].dataset.index;
				const size = Number(o.link[0].dataset.size) || 0;

				base._resetData(index);
				base.get(e.currentTarget.dataset.link, undefined, 'blob', { filename, index, path});

				let startTime = Date.now();
				let prevLoaded = 0;
				let prevTime = startTime;

				ins[index] = setInterval(async function () {
					const prog = +progress[index] || 0;
					const currentTime = Date.now();
					const elapsedTime = currentTime - startTime;
					const loaded = prog * size / 100;
					const timeDiff = Math.max(currentTime - prevTime, 1); // 避免除零
					const speed = ((loaded - prevLoaded) / (timeDiff / 1000)) || 0;

					// 计算剩余时间（保护除零）
					const totalProgress = Math.max(prog / 100, 0.01);
					const totalElapsedSeconds = elapsedTime / 1000;
					const estTotalTime = totalElapsedSeconds / totalProgress;
					const remainingTime = estTotalTime - totalElapsedSeconds;

					// 更新界面状态
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// 更新进度条
					$width.css('width', `${prog}%`);
					$text.text(`${prog.toFixed(1)}% | 速度:${base.sizeFormat(speed)} | 剩余:${base.rtimeFormat(remainingTime)}`);

					// 更新历史值
					prevLoaded = loaded;
					prevTime = currentTime;

					// 下载完成
					if (prog >= 100) {
						await base.sleep(1000);
						clearInterval(ins[index]);
						progress[index] = 0;
						o.item.find('.pl-progress-stop').hide();
						$text.text('下载完成~ 浏览器下载框应该弹出来了哦~');
						o.back.show();
						await base.sleep(3000);
						o.link.text('增强下载(基于浏览器文件流)').animate({ opacity: '1' }, "slow");
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('正在取消...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all',async function (e) {
				if(navigator.userAgent.match(/Chrom(e|ium)/)){//Chromium内核
					globalDirHandle = await window.showDirectoryPicker();
				}
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('下载开始，下载进度见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('全部增强下载').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await base.sendLinkToRPC(e.currentTarget.dataset.link, e.currentTarget.dataset.filename,e.currentTarget.dataset.path, [`Cookie: ${document.cookie}`]);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('发送成功了!快去看看吧~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}👉<a href="${config.base.assistant.link}" target="_blank" class="pl-a">点击此处安装</a>👈`);
				} else {
					target.addClass('pl-btn-danger').text('发送失败，检查一下您的RPC配置信息哦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('发送完成，发送结果见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdate();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encodeBase(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		greenerPage() {
			base.waitForKeyElements('[class*="VideoDetail--content-footer"]', function (tag) {
				tag.children().each(function () {
					const $child = $(this);
					if ($child.text().includes('手机客户端')) {
						$child.hide();
					}
				});
			}, true);
			base.waitForKeyElements('[class*="PCLandingBanner--ad-block"]', function (tag) {
				tag.hide();
			}, true);
		},

		svg: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNOSAxMmwyIDIgMi0yeiIvPjxwYXRoIGQ9Ik0xNCA4aDEuNTUzYy44NSAwIDEuMTYuMDkzIDEuNDcuMjY3LjMxMS4xNzQuNTU2LjQzLjcyMi43NTYuMTY2LjMyNi4yNTUuNjUuMjU1IDEuNTR2NC44NzNjMCAuODkyLS4wODkgMS4yMTUtLjI1NSAxLjU0LS4xNjYuMzI3LS40MS41ODMtLjcyMi43NTctLjMxLjE3NC0uNjIuMjY3LTEuNDcuMjY3SDYuNDQ3Yy0uODUgMC0xLjE2LS4wOTMtMS40Ny0uMjY3YTEuNzc4IDEuNzc4IDAgMDEtLjcyMi0uNzU2Yy0uMTY2LS4zMjYtLjI1NS0uNjUtLjI1NS0xLjU0di00Ljg3M2MwLS44OTIuMDg5LTEuMjE1LjI1NS0xLjU0LjE2Ni0uMzI3LjQxLS41ODMuNzIyLS43NTcuMzEtLjE3NC42Mi0uMjY3IDEuNDctLjI2N0gxMSIvPjxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0iTTExIDN2MTAiLz48L2c+PC9zdmc+',
		addButton() {
			base.waitForKeyElements(config.$uc.mount.home, (element) => {
				page = $uc.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'home') return;
				let $button = $(`<div class="ant-dropdown-trigger pl-button">
					<button type="button" class="uc-button ant-btn btn-file ant-btn-primary">
						<img class="uc-btn-icon" src="${$uc.svg}"><span>下载助手</span>
					</button>
					<ul class="pl-dropdown-menu" style="top: 39px;">
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">API 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria">Aria 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURL 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc">BC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li>
					</ul>
				</div>`);
				$button.css({ "margin-right": "10px", "display": "inline-block" });
				element.prepend($button);
			})
			base.waitForKeyElements(config.$uc.mount.share, (element) => {
				page = $uc.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'share') return;
				let $button = $(`<div class="ant-dropdown-trigger pl-button"><button type="button" class="uc-button ant-btn btn-file ant-btn-primary" style="height: 40px;"><img class="uc-btn-icon" src="${$uc.svg}"><span>下载助手</span></button><ul class="pl-dropdown-menu"><li class="pl-dropdown-menu-item pl-button-mode pl-button-save"><span class="save-btn-icon"></span>保存后下载</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li></ul></div>`);
				$button.css({ "margin-left": "10px", "display": "inline-block" });
				element.append($button);
			})
		},

		addInitButton() {
			let $button = $(`<div class="ant-dropdown-trigger pl-button-init"><button type="button" class="uc-button ant-btn btn-file ant-btn-primary" style="height: 40px;"><img class="uc-btn-icon" src="${$uc.svg}"><span>点我点亮</span></button></div>`);
			$button.click(function () { base.initDialog() });
			base.waitForKeyElements(config.$uc.mount.home, (element) => {
				page = $uc.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'home') return;
				$button.css({ "margin-right": "10px", "display": "inline-block" });
				element.prepend($button);
			})
			base.waitForKeyElements(config.$uc.mount.share, (element) => {
				page = $uc.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'share') return;
				$button.css({ "margin-left": "10px", "display": "inline-block" });
				element.append($button);
			})
		},

		async getFilesByOnce(item,params){
			try {
				let res;
				if(page=="home"){
					let url=`${config.$uc.api.getFiles.home}?pr=UCBrowser&fr=pc&pdir_fid=${params.fid}&_page=${params.pageNum}&_size=50&_fetch_total=1&_fetch_sub_dirs=0&_sort=file_type:asc,updated_at:desc`;
					res = await base.get(url, {
						"content-type": "application/json;charset=utf-8", 
						// "user-agent": config.$quark.api.ua.downloadLink //TODO 怎么是夸克的？
						"user-agent": config.$uc.api.ua.downloadLink
					});
				}else if(page=="share"){
					
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error(`提示：<br/>文件获取请求失败`);
			}
		},

		async getFileUrlByOnce(item, index, token) {
			try {
				if (item.downloadUrl) return {
					index,
					downloadUrl: item.downloadUrl
				};
				let res = await base.get(config.$xunlei.api.getLink.home + item.id, {
					'Authorization': `${token.credentials.token_type} ${token.credentials.access_token}`,
					'content-type': "application/json",
					'x-captcha-token': token.captcha.token,
					'x-device-id': token.deviceid,
				});
				if (res.web_content_link) {
					return {
						index,
						downloadUrl: res.web_content_link
					};
				} else {
					return {
						index,
						downloadUrl: '获取下载地址失败，刷新后再试试吧~'
					};
				}
			} catch (e) {
				return message.error('提示：<br/>请先登录网盘后再刷新页面呢~');
			}
		},
		
		async fetchAllPages(file) {
			//分页获取文件夹内文件数据
			let res;
			let files=[];//文件数据列表
			let pageCount=Math.ceil(file.include_items/50);//总页数
			for (let pageNum=1;pageNum<=pageCount;pageNum++) {
				//随机停顿防反爬
				this.cnt++;
				if (this.cnt >= 50+Math.random()*10) {
					doc.find('.loading-popup .swal2-html-container').html(`<div>正遍历到的大型文件夹（非全部）已获取 ${files.length} 个文件~</div><div>休息 ${globalSleep} 毫秒...</div>`);
					await base.customSleep();
					this.cnt = 0;
				}

				//发送请求
				let param={"fid":file.fid,"pageNum":pageNum};
				res=await this.getFilesByOnce(file,param);

				//请求失败
				if(res?.code){//注意变量名
					return message.error(`提示：<br/>请求失败，失败码：	${res?.code}	失败信息：${res.message}`);
				}

				//请求成功
				files=files.concat(res.data.list)//注意变量名
			}
			return files;
		},

		async fetchFiles(file,pNode) {
			//获取文件目录结构（递归）
			//节点 
			let fileNode={
				name:file.file_name,//注意变量名
				path:pNode.name === 'root' ? `` : (pNode.path === '' ? pNode.name : `${pNode.path}/${pNode.name}`),//一般来说，路径不要特别特别长，不然可能会出问题，不过正常是不会的
				children:[]
			}
			pNode.children.push(fileNode);
			file.path=fileNode.path;

			//判断是否文件夹
			if (!file?.dir) {//注意变量名
				this.fileCount++;
				doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div>`);
				return file;
			}
			
			//文件夹内文件遍历
			let files=[];
			for (let f of await this.fetchAllPages(file)) {
				files= files.concat(await this.fetchFiles(f,fileNode));
			}
			return files;
		},

		async getLink() {
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				title: "获取中",
				html: `...`,
				footer: "如果选的文件较多，请耐心等待获取完成哦！",
				customClass: {
					popup: 'loading-popup',
					header: 'loading-header',
					title: 'loading-title',
					content: 'loading-content',
					input: 'loading-input',
					footer: 'loading-footer'
				},
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('提示：<br/>请勾选要下载的文件哦~');
			}

			if(page=="home"){
			}else if(page=="share"){
				//分享页面所需的变量
			}else{
				return message.error('提示：<br/>页面错误~');
			}

			this.cnt=0;
			this.fileCount=0;//文件计数
			let fileList=[];//文件列表，只有文件没有文件夹
			let fileTree = { name: "root", path: ``, children: [] }; // 文件目录树
			if (page === 'home') {
				//获取文件目录结构（递归）
				for (let file of selectList) {
					//遍历选中文件
					//统一变量名
					fileList = fileList.concat(await this.fetchFiles(file,fileTree));
				}
	
				//文件夹为空
				if (!fileList.length) {
					return message.error('提示：<br/>文件夹是空的哦~');
				}
	
				//获取下载链接 
				//TODO 我认为连续访问网盘的接口不如直接拿全部ID合适，post协议本身不作数据长度上限，即使后台限制为1M，也有65536个文件ID了，你如果觉得不合适可以修改
				let fids = fileList.map(item => item.fid);
				// 发起请求获取链接
				let res = await base.post(config.$uc.api.getLink.home, { "fids": fids }, { "content-type": "application/json;charset=utf-8", "user-agent": config.$uc.api.ua.downloadLink });
				if (res.code !== 0) {
					return message.error(`提示：<br/>请求失败，失败码：	${res?.code}	失败信息：${res.message}`);
				}
				if (res.data.length!=fids.length)
					return message.error('提示：<br/>获取下载链接数目不对，请重新尝试，若文件数目太多，如好几万个文件，请联系作者修改<br/>');

				//显示下载GUI
				let data = res.data.map((element, index) => {
					return {
						...element,
						path: fileList[index].path//TODO 请求的ID和返回的ID的列表顺序是一一对应的，如果有问题请告诉我或自行修改
					};
				});
				let html = this.generateDom(data);
				base.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
			} else {
				return message.error('提示：<br/>页面错误~');
			}
		},

		generateDom(list) {
			if (!list) {
				return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.file === false) return;
				let filename = v.file_name;
				let fid = v.fid;
				let size = base.sizeFormat(v.size);
				let dlink = v.download_url;
				let dpath=v.path;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">获取下载链接失败，刷新网页后再试试吧~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-default listener-link-api blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-fid="${fid}" data-index="${i}" data-path="${dpath}">增强下载(基于浏览器文件流)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="基于浏览器直接打开链接来下载文件，适用于较为古老但支持 iframe 的浏览器，点击“直接下载”后需等待下载提示弹出才能点击下个“直接下载”，否则只会下载后者，此方式下载有可能会被 IDM 捕获下载链接" data-filename="${filename}" data-link="${dlink}" data-fid="${fid}">直接下载(基于浏览器链接)</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">复制链接</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">正在加载进度...0%</div>
									</div>
								</div>
								<button class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">取消下载</button>
								<button class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">返回</button>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = base.convertLinkToAria(dlink, filename, dpath, `--header "Cookie: ${document.cookie}"`);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 aria2c 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
									<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
									<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" 
											data-filename="${filename}" 
											data-link="${dlink}" 
											data-path="${dpath}"> <!-- 添加了 data-path 属性 -->
										<svg class="icon-rpc-devices" viewBox="-10 0 1034 1024">
											<g transform="matrix(1 0 0 -1 0 960)">
												<path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" />
											</g>
										</svg>
										<span style="margin-left: 5px;">将 ${filename} 推送到 RPC 下载器</span>
									</button>
								</div>`;
					}
					if (mode === 'curl') {
						let alink = base.convertLinkToCurl(dlink, filename, dpath, `-b "${document.cookie}"`);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 curl 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = base.convertLinkToBC(dlink, filename, `cookie=${encodeURIComponent(document.cookie)}`);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="点击用比特彗星下载" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>下载 ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';

			if (mode === 'rpc') {
				content += `<div class="pl-extra">`
			}
			if (list.length >= 2) {
				if (mode === 'api')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接">全部增强下载</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误">复制全部链接</button></div>`;
				if (mode === 'aria')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button></div>`;
				if (mode === 'rpc') {
					content += `<button class="pl-btn-primary listener-send-rpc">发送全部链接</button>`;
				}
				if (mode === 'curl') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">修改终端类型（${terminalType[base.getValue('setting_terminal_type')]}）</button></div>`;
				}
				if (mode === 'bc') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部链接</button></div>`;
				}
			}
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">修改 RPC 参数（${rpc}）</button>
					<button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">查看下载任务</button>
				</div>`;
			}

			return content;
		},

		getSelectedList() {
			try {
				let selectedList = [];
				let reactDom = document.getElementsByClassName('file-list')[0];
				let reactObj = base.findReact(reactDom);
				let props = reactObj.props;
				if (props) {
					let fileList = props.list || [];
					let selectedKeys = props.selectedRowKeys || [];
					fileList.forEach(function (val) {
						if (selectedKeys.includes(val.fid)) {
							selectedList.push(val);
						}
					});
				}
				return selectedList;
			} catch (e) {
				return [];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/(list)/.test(path)) return 'home';
			if (/^\/(s|share)\//.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].file) return false;
			}
			return true;
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		}
	};

	/**
	 * 123云盘
	 * @author 油小猴
	 * @author hmjz100
	 * @author KanouAo
	 */
	let $123pan = {
		cnt:0,//计数器，用于控制随机延迟
		fileCount:0,//文件计数
		token:{},
		ShareKey:"",

		addPageListener() {
			/*
			防止代码因其他原因被执行多次
			这段代码出自 Via轻插件，作者谷花泰
			*/
			const key = encodeURIComponent('LinkSwift:123云盘');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, back, stop, target,
				};
			}

			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				$123pan.getLink();
			});
			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				selectList = $123pan.getSelectedList();
				if (selectList.length === 0) {
					return message.error('提示：<br/>请勾选要保存到网盘的文件哦~');
				}
				message.info('提示：<br/>因网盘限制，请保存到自己网盘后再去下载哦~');
				await base.sleep(500);
				document.querySelector('.file-info_r').click();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();

				const o = _factory(e);
				const $width = o.item.find('.pl-progress-inner');
				const $text = o.item.find('.pl-progress-inner-text');
				const filename = o.link[0].dataset.filename;
				const path=o.link[0].dataset.path;
				const index = o.link[0].dataset.index;
				const size = Number(o.link[0].dataset.size) || 0;

				base._resetData(index);
				base.get(e.currentTarget.dataset.link, undefined, 'blob', { filename, index, path});

				let startTime = Date.now();
				let prevLoaded = 0;
				let prevTime = startTime;

				ins[index] = setInterval(async function () {
					const prog = +progress[index] || 0;
					const currentTime = Date.now();
					const elapsedTime = currentTime - startTime;
					const loaded = prog * size / 100;
					const timeDiff = Math.max(currentTime - prevTime, 1); // 避免除零
					const speed = ((loaded - prevLoaded) / (timeDiff / 1000)) || 0;

					// 计算剩余时间（保护除零）
					const totalProgress = Math.max(prog / 100, 0.01);
					const totalElapsedSeconds = elapsedTime / 1000;
					const estTotalTime = totalElapsedSeconds / totalProgress;
					const remainingTime = estTotalTime - totalElapsedSeconds;

					// 更新界面状态
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// 更新进度条
					$width.css('width', `${prog}%`);
					$text.text(`${prog.toFixed(1)}% | 速度:${base.sizeFormat(speed)} | 剩余:${base.rtimeFormat(remainingTime)}`);

					// 更新历史值
					prevLoaded = loaded;
					prevTime = currentTime;

					// 下载完成
					if (prog >= 100) {
						await base.sleep(1000);
						clearInterval(ins[index]);
						progress[index] = 0;
						o.item.find('.pl-progress-stop').hide();
						$text.text('下载完成~ 浏览器下载框应该弹出来了哦~');
						o.back.show();
						await base.sleep(3000);
						o.link.text('增强下载(基于浏览器文件流)').animate({ opacity: '1' }, "slow");
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('正在取消...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all',async function (e) {
				if(navigator.userAgent.match(/Chrom(e|ium)/)){//Chromium内核
					globalDirHandle = await window.showDirectoryPicker();
				}
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('下载开始，下载进度见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('全部增强下载').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('复制成功').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('重新复制').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await base.sendLinkToRPC(e.currentTarget.dataset.link, e.currentTarget.dataset.filename,e.currentTarget.dataset.path);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('发送成功了!快去看看吧~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}👉<a href="${config.base.assistant.link}" target="_blank" class="pl-a">点击此处安装</a>👈`);
				} else {
					target.addClass('pl-btn-danger').text('发送失败，检查一下您的RPC配置信息哦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('发送完成，发送结果见上方按钮哦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdate();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encodeBase(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		greenerPage() {
			base.waitForKeyElements(".new-menu-item-image, .special-menu-item-container-migration--label, .sider-member-btn, .video-new-user-tips", (tag) => {
				if (tag.is(":hidden")) return;
				tag.hide();
			}, true)
			let allowedTexts = ["其他网盘数据转入", "同步空间", "回收站", "下载客户端"];
			base.waitForKeyElements(`.ant-menu.ant-menu-root.ant-menu-inline[role="menu"]`, (tag) => {
				tag.find(`[role="menuitem"]`).each(function () {
					const menuText = $(this).text().trim();
					if (!allowedTexts.includes(menuText) || $(this).is(":hidden")) return;
					$(this).hide();
				});
			}, true)
			base.waitForKeyElements(".special-menu-item-container", (tag) => {
				tag.find(".special-menu-item-container-migration").each(function () {
					const menuText = $(this).text().trim();
					if (!allowedTexts.includes(menuText) || $(this).is(":hidden")) return;
					$(this).hide();
				});
			}, true)
			base.waitForKeyElements(`.header-btn-list`, (tag) => {
				tag.find(`.btn-item`).each(function () {
					const menuText = $(this).text().trim();
					if (!allowedTexts.includes(menuText) || $(this).is(":hidden")) return;
					$(this).hide();
				});
			}, true)
			base.waitForKeyElements(`.rightInfo .register:not(.pl-button, .pl-button-init),
				.homeClass > div > .ant-dropdown-trigger:not(.pl-button, .pl-button-init),
				.homeClass > div > .sysbut`, function (tag) {
				let hasTextNode = false;
				tag.contents().each(function () {
					if (this.nodeType === 3 && $.trim(this.textContent)) {
						hasTextNode = true;
						return;
					}
				});
				if (!hasTextNode) return;
				tag.css({ "width": "38px" });
				tag.contents().each(function () {
					if (this.nodeType === 3) {
						$(this).remove();
					}
				});
				tag.find('svg').css({ "margin-right": "0" });
			});
			base.waitForKeyElements('.rightInfo .qrcode_btn', function (tag) {
				tag.hide();
			}, true);
		},

		getToken() {
			doc.find('.loading-popup .loading-title').html(`令牌获取中`);
			doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取令牌~</div>`);
			let token = base.getStorage("authorToken");
			return token;
		},
		
		getRandomNum(len) {
			len = len || 16;
			let $chars = '0123456789';
			let maxPos = $chars.length;
			let pwd = '';
			for (let i = 0; i < len; i++) {
				pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
			}
			return pwd;
		},

		async getFilesByOnce(item,params){
			try {
				let res;
				params.driveId=0;//TODO 看起来是个变量，但我定值是0，也没细看这变量怎么产生的，以后出问题再看。
				params.operateType=8;//文件夹初次打开拿第1页数据时是4，鼠标下滑增加数据是8
				params.next=0;//如何文件100个以内不用拉数据的是0，超过100的是-1，都填0都适配
				let time = Date.now();
				if(page=="home"){
					//TODO 这URL中间有XXX=时间戳-XXX-XXX的格式，我发觉那放3个随机数竟然也行，如果不合适你就找下。
					let url=`${config.$123pan.api.getFiles.home}?${this.getRandomNum()}=${time}-${this.getRandomNum()}-${this.getRandomNum()}&driveId=${params.driveId}&limit=100&next=${params.next}&orderBy=update_time&orderDirection=desc&parentFileId=${params.FileId}&trashed=false&SearchData=&Page=${params.pageNum}&OnlyLookAbnormalFile=0&event=homeListFile&operateType=${params.operateType}&inDirectSpace=false`;
					res = await base.get(url, {
						"content-type": "application/json;charset=utf-8",
						"authorization": `Bearer ${this.token}`,
						"platform": "web"//TODO ios？打错？不合适就换回来
					});
				}else if(page=="share"){
					//TODO 这URL中间有XXX=时间戳-XXX-XXX的格式，我发觉那放3个随机数竟然也行，如果不合适你就找下。
					let url=`${config.$123pan.api.getFiles.share}?${this.getRandomNum()}=${time}-${this.getRandomNum()}-${this.getRandomNum()}&limit=100&next=${params.next}&orderBy=file_name&orderDirection=asc&shareKey=${this.ShareKey}&ParentFileId=${params.FileId}&Page=${params.pageNum}&event=homeListFile&operateType=${params.operateType}`;
					res = await base.get(url, {
						"content-type": "application/json;charset=utf-8",
						"authorization": `Bearer ${this.token}`,
						"platform": "web"//TODO ios？打错？不合适就换回来
					});
				}else{
					return message.error(`提示：<br/>网站页面错误`);
				}
				return res;
			} catch (e) {
				return message.error(`提示：<br/>文件获取请求失败`);
			}
		},

		async getFileUrlByOnce(item, index) {
			try {
				if (item.DownloadUrl) return {
					index,
					downloadUrl: item.DownloadUrl
				};
				let res = null;
				if (this.ShareKey) {
					res = await base.post(config.$123pan.api.getLink.share, {
						"ShareKey": this.ShareKey,
						"FileID": item.FileId,
						"S3keyFlag": item.S3KeyFlag,
						"Size": item.Size,
						"Etag": item.Etag
					}, {
						"content-type": "application/json;charset=utf-8",
						"authorization": `Bearer ${this.token}`,
						"platform": "ios"//为啥IOS不是WEB？IOS更好点？
					});
				} else {
					res = await base.post(config.$123pan.api.getLink.home, {
						"driveId": 0,
						"etag": item.Etag,
						"fileId": item.FileId,
						"s3keyFlag": item.S3KeyFlag,
						"type": item.Type,
						"fileName": item.FileName,
						"size": item.Size
					}, {
						"content-type": "application/json;charset=utf-8",
						"authorization": `Bearer ${this.token}`,
						"platform": "web"//TODO ios？打错？不合适就换回来
					});
				}
				if (res.data?.DownloadUrl) {
					let url = res.data.DownloadUrl;
					let surl = new URL(url).searchParams.get("params");
					if (surl) url = base.decodeBase(surl);
					url = await base.getFinalUrl(url);
					return {
						index,
						downloadUrl: url
					};
				} else if (res.data?.DownloadURL) {
					let url = res.data.DownloadURL;
					let surl = new URL(url).searchParams.get("params");
					if (surl) url = base.decodeBase(surl);
					url = await base.getFinalUrl(url);
					return {
						index,
						downloadUrl: url
					};
				} else if (res?.code === 5112) {
					return message.error('提示：<br/>请先登录网盘后再获取链接呢~');
				} else {
					return {
						index,
						downloadUrl: '获取下载地址失败，刷新后再试试吧~'
					};
				}
			} catch (e) {
				return {
					index,
					downloadUrl: '获取下载地址失败，刷新后再试试吧~'
				};
			}
		},
		
		async fetchAllPages(file) {
			//分页获取文件夹内文件数据
			let res;
			let files=[];//文件数据列表
			let pageCount=1;//总页数，先设1，之后根据res返回的值修改//share没有file.fileCount，兼容适配
			for (let pageNum=1;pageNum<=pageCount;pageNum++) {
				//随机停顿防反爬
				this.cnt++;
				if (this.cnt >= 50+Math.random()*10) {
					doc.find('#loadingText').html(`<div>文件获取中</div><div>已获取 ${this.fileCount} 个文件，请耐心等待哦~</div><div>>休息 ${globalSleep} 毫秒...</div>`);
					await base.sleep(globalSleep+Math.random()*globalSleepRandSeed);
					this.cnt = 0;
				}
				//发送请求
				let param={"pageNum":pageNum,"FileId":file.FileId};
				res=await this.getFilesByOnce(file,param);
				
				//请求失败
				if(!(res?.code==0&&res?.message=="ok")){
					return message.error(`提示：<br/>请求失败，失败码：	${res?.res_code}	失败信息：${res.res_message}`);
				}
				//请求成功
				if(pageCount==1)pageCount=Math.ceil(res.data.Total/100);
				files=files.concat(res.data.InfoList);//注意变量名
			}
			return files;
		},

		async fetchFiles(file,pNode) {
			//获取文件目录结构（递归）
			//节点 
			let fileNode={
				name:file.FileName,//注意变量名
				path:pNode.name === 'root' ? `` : (pNode.path === '' ? pNode.name : `${pNode.path}/${pNode.name}`),//一般来说，路径不要特别特别长，不然可能会出问题，不过正常是不会的
				children:[]
			}
			pNode.children.push(fileNode);
			file.path=fileNode.path;

			//判断是否文件夹
			if (file.Type === 0) {//注意变量名
				this.fileCount++;
				doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${this.fileCount} 个文件~</div>`);
				return file;
			}
			
			//文件夹内文件遍历
			let files=[];
			for (let f of await this.fetchAllPages(file)) {
				files= files.concat(await this.fetchFiles(f,fileNode));
			}
			return files;
		},

		async getLink() {
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				title: "获取中",
				html: `...`,
				footer: "如果选的文件较多，请耐心等待获取完成哦！",
				customClass: {
					popup: 'loading-popup',
					header: 'loading-header',
					title: 'loading-title',
					content: 'loading-content',
					input: 'loading-input',
					footer: 'loading-footer'
				},
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('提示：<br/>请勾选要下载的文件哦~');
			}

			if(page=="home"){
			}else if(page=="share"){
				//分享页面所需的变量
				let pathSplit = location.pathname.split('/').filter(Boolean);
				this.ShareKey = pathSplit[1];
			}else{
				return message.error('提示：<br/>页面错误~');
			}
			this.token =  this.getToken();

			this.cnt=0;
			this.fileCount=0;//文件计数
			let fileList=[];//文件列表，只有文件没有文件夹
			let fileTree = { name: "root", path: ``, children: [] }; // 文件目录树
			// if (page === 'home') {
				//获取文件目录结构（递归）
				for (let file of selectList) {
					//遍历选中文件
					//统一变量名
					fileList = fileList.concat(await this.fetchFiles(file,fileTree));
				}
	
				//文件夹为空
				if (!fileList.length) {
					return message.error('提示：<br/>文件夹是空的哦~');
				}
	
				//获取下载链接 
				doc.find('.loading-popup .loading-title').html(`链接获取中`);
				doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取文件对应的下载链接~</div>`);
				let batchSize = globalBatchsize+Math.ceil(Math.random()*5);
				let i=0;
				while (i < fileList.length){
					// 分批获取链接
					let batch = fileList.slice(i, i + batchSize);

					// 生成请求队列
					let queue = [];
					batch.forEach((item, localIndex) => {
						let globalIndex = i + localIndex;
						queue.push(this.getFileUrlByOnce(item, globalIndex)
							.then(val => {
								// processed++;
								// doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${processed} / ${selectList.length} 个链接~</div>`);
								return val;
							}));
					});

					// 等待本批次的请求结果
					let res = await Promise.all(queue);
					res.forEach(val => {
						fileList[val.index].DownloadUrl = val.downloadUrl;
					});

					// 每次处理完一个批次后，等待	
					if (i + batchSize < fileList.length){
						doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${i+batch.length} / ${fileList.length} 个链接,请耐心等待哦~</div><div>休息 ${globalSleep} 毫秒...</div>`);
						await base.customSleep();
					};

					//累加批次
					i += batchSize;
					batchSize = globalBatchsize+Math.ceil(Math.random()*5)
				}
				let html = this.generateDom(fileList);
				base.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
			// } else if (page === 'share') {
			// 	let batchSize = 15;
			// 	let processed = 0;
			// 	selectList = selectList.filter(item => item.Type === 0);
			// 	console.log(selectList)
			// 	for (let i = 0; i < selectList.length; i += batchSize) {
			// 		let batch = selectList.slice(i, i + batchSize);
			// 		let queue = [];

			// 		doc.find('.loading-popup .loading-title').html(`链接获取中`);
			// 		doc.find('.loading-popup .swal2-html-container').html(`<div>正在获取文件对应的下载链接~</div>`);
			// 		batch.forEach((item, localIndex) => {
			// 			let globalIndex = i + localIndex;
			// 			queue.push(this.getFileUrlByOnce(item, globalIndex)
			// 				.then(val => {
			// 					processed++;
			// 					doc.find('.loading-popup .swal2-html-container').html(`<div>已获取 ${processed} / ${selectList.length} 个链接~</div>`);
			// 					return val;
			// 				}));
			// 		});

			// 		let res = await Promise.all(queue);
			// 		res.forEach(val => {
			// 			selectList[val.index].DownloadUrl = val.downloadUrl;
			// 		});

			// 		await base.sleep(1000);
			// 	}
			// 	let html = this.generateDom(selectList);
			// 	base.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
			// } else {
			// 	return message.error('提示：<br/>页面错误~');
			// }
		},

		generateDom(list) {
			if (!list) {
				return message.error('提示：<br/>获取下载链接失败，刷新网页后再试试吧~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.Type !== 0) return;
				let filename = v.FileName;
				let fileid = v.FileId;
				let size = base.sizeFormat(v.Size);
				let dlink = v.DownloadUrl || v.DownloadURL;
				let dpath=v.path;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">获取下载链接失败，刷新网页后再试试吧~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-default listener-link-api blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-fid="${fileid}" data-index="${i}" data-path="${dpath}">增强下载(基于浏览器文件流)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="基于浏览器直接打开链接来下载文件，适用于较为古老但支持 iframe 的浏览器，点击“直接下载”后需等待下载提示弹出才能点击下个“直接下载”，否则只会下载后者，此方式下载有可能会被 IDM 捕获下载链接" data-filename="${filename}" data-link="${dlink}" data-fid="${fileid}">直接下载(基于浏览器链接)</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">复制链接</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">正在加载进度...0%</div>
									</div>
								</div>
								<button class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">取消下载</button>
								<button class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">返回</button>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = base.convertLinkToAria(dlink, filename, dpath);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 aria2c 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
									<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
									<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" 
											data-filename="${filename}" 
											data-link="${dlink}" 
											data-path="${dpath}"> <!-- 添加了 data-path 属性 -->
										<svg class="icon-rpc-devices" viewBox="-10 0 1034 1024">
											<g transform="matrix(1 0 0 -1 0 960)">
												<path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" />
											</g>
										</svg>
										<span style="margin-left: 5px;">将 ${filename} 推送到 RPC 下载器</span>
									</button>
								</div>`;
					}
					if (mode === 'curl') {
						let alink = base.convertLinkToCurl(dlink, filename, dpath);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="点击复制 curl 命令行" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>复制 ${filename} 下载命令行</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = base.convertLinkToBC(dlink, filename);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" data-path="${dpath}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="点击用比特彗星下载" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>下载 ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';

			if (mode === 'rpc') {
				content += `<div class="pl-extra">`
			}
			if (list.length >= 2) {
				if (mode === 'api')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all blob" data-title="不建议使用本功能，若文件过大下载完成后有可能不会弹出窗口，此时请换用“RPC 下载 + Mortix”的组合<br/>基于浏览器的 Blob 文件流下载文件，适用于较新的浏览器，可以在此窗口中显示下载剩余时间和下载速度，此方式下载不会被 IDM 捕获下载链接">全部增强下载</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="不建议使用本功能，在本网盘单独复制链接并粘贴下载可能会导致服务器回报 403 错误">复制全部链接</button></div>`;
				if (mode === 'aria')
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button></div>`;
				if (mode === 'rpc') {
					content += `<button class="pl-btn-primary listener-send-rpc">发送全部链接</button>`;
				}
				if (mode === 'curl') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部命令行</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">修改终端类型（${terminalType[base.getValue('setting_terminal_type')]}）</button></div>`;
				}
				if (mode === 'bc') {
					content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">复制全部链接</button></div>`;
				}
			}
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">修改 RPC 参数（${rpc}）</button>
					<button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">查看下载任务</button>
				</div>`;
			}

			return content;
		},

		getSelectedList() {
			try {
				let selectedList = [];
				let reactDom = document.getElementsByClassName('ant-table-body')[0];
				let reactObj = base.findReact(reactDom);
				let props = reactObj.memoizedProps.props;
				if (props) {
					let fileList = props.data || [];
					fileList.forEach(function (val) {
						if (val?.checked === true) {
							selectedList.push(val);
						}
					});
				}
				return selectedList;
			} catch (e) {
				return [];
			}
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].Type === 0) return false;
			}
			return true;
		},

		addButton() {
			base.waitForKeyElements(config.$123pan.mount.home, (element) => {
				element = element.parent();
				page = $123pan.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'home') return;
				let $button = $(`<div class="ant-dropdown-trigger sysdiv parmiryButton pl-button">
					<svg class="icon" aria-hidden="true" style="font-size: 22px; color: rgb(255, 255, 255);"><use xlink:href="#top_btn_download2"></use></svg>下载助手
					<ul class="pl-dropdown-menu" style="top:37px">
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">API 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria">Aria 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURL 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc">BC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li>
					</ul>
				</div>`);
				$button.css({ "margin-right": "22px", "width": "110px" })
				element.prepend($button);
			})
			base.waitForKeyElements(config.$123pan.mount.share, (element) => {
				element = element.parent();
				page = $123pan.detectPage();
				if ($(".pl-button").length > 0 || !page || page !== 'share') return;
				let $button = $(`<div class="register pl-button">
					<svg class="icon" aria-hidden="true" style="color:rgb(255, 255, 255);margin-right:5px;"><use xlink:href="#top_btn_download2"></use></svg>下载助手
					<ul class="pl-dropdown-menu" style="top:37px">
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">API 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria">Aria 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURL 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc">BC 下载</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">助手设置</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">助手美化</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">更新日志</li>
					</ul>
				</div>`);
				$button.css({ "width": "100px" })
				element.append($button);
			})
		},

		addInitButton() {
			base.waitForKeyElements(config.$123pan.mount.home, (element) => {
				element = element.parent();
				page = $123pan.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'home') return;
				let $button = $(`<div class="ant-dropdown-trigger sysdiv parmiryButton pl-button-init">
					<svg class="icon" aria-hidden="true" style="font-size: 22px; color: rgb(255, 255, 255);"><use xlink:href="#top_btn_download2"></use></svg>点我点亮
				</div>`);
				$button.click(function () { base.initDialog() });
				$button.css({ "margin-right": "22px", "width": "110px" })
				element.prepend($button);
			})
			base.waitForKeyElements(config.$123pan.mount.share, (element) => {
				element = element.parent();
				page = $123pan.detectPage();
				if ($(".pl-button-init").length > 0 || !page || page !== 'share') return;
				let $button = $(`<div class="register pl-button-init">
					<svg class="icon" aria-hidden="true" style="color:rgb(255, 255, 255);margin-right:5px;"><use xlink:href="#top_btn_download2"></use></svg>点我点亮
				</div>`);
				$button.click(function () { base.initDialog() });
				$button.css({ "width": "100px" })
				element.append($button);
			})
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/$/.test(path)) return 'home';
			if (/^\/s\//.test(path)) return 'share';
			return '';
		},

		async initPanLinker() {
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		},
	};

	// 油小猴
	let $youxiaohou = {
		async initPanLinker() {
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
			} else {
				this.addInitButton();
			}
		},
		addButton() {
			let $button = `<div class="nav-item">
				<div class="dropdown-wrapper">
					<button type="button" aria-label="(改)下载助手" class="dropdown-title">
						<span class="title">(改)下载助手⬇️</span>
						<span class="arrow down"></span>
					</button>
					<button type="button" aria-label="(改)下载助手" class="mobile-dropdown-title">
						<span class="title">(改)下载助手⬇️</span>
						<span class="arrow right"></span>
					</button>
					<ul class="nav-dropdown" style="display:none;">
						<li class="dropdown-item">
							<h4>
								助手
							</h4>
							<ul class="dropdown-subitem-wrapper">
								<li class="dropdown-subitem">
									<a href="javascript:void(0)" class="listener-open-info nav-link">
										🛠️ 调试(查看暗号/协议)
									</a>
								</li>
							</ul>
						</li>
						<li class="dropdown-item">
							<h4>
								选项
							</h4>
							<ul class="dropdown-subitem-wrapper">
								<li class="dropdown-subitem">
									<a href="javascript:void(0)" class="listener-open-setting nav-link">
										⚙️ 助手设置
									</a>
								</li>
								<li class="dropdown-subitem">
									<a href="javascript:void(0)" class="listener-open-beautify nav-link">
										🍃️ 助手美化
									</a>
								</li>
								<li class="dropdown-subitem">
									<a href="javascript:void(0)" class="listener-open-updatelog nav-link">
										📃️ 更新日志
									</a>
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
			`;
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdate();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-open-info', function () {
				base.showDebug();
			});

			document.querySelectorAll(".nav-links").forEach(function (element) {
				element.innerHTML += $button
			})
		},
		addInitButton() {
			let $button = `<div class="nav-item">
				<div class="dropdown-wrapper">
					<a class="nav-link listener-open-init">(改)点我点亮⬇️</a>
				</div>
			</div>
			`;
			doc.on('click', '.listener-open-init', function () {
				base.initDialog();
			});

			document.querySelectorAll(".nav-links").forEach(function (element) {
				element.innerHTML += $button
			})
		}
	}
	// 主代码
	let main = {
		async init() {
			base.waitForKeyElements(`html:not(:has(> ${mount})) head`, (element) => {
				element.after(`<${mount} class="${mount}" />`)
			}, true)
			// 先加载默认设置
			base.initDefaultConfig();
			// 再加载网页样式
			base.addPanLinkerStyle();
			base.createDownloadIframe();

			/**
			 * 控制台输出
			 * @author 油小猴
			 * @author hmjz100
			 * @description 来自【网盘智能识别助手】，有改动
			 */
			console.log(`%c %c LinkSwift\n一个基于 JavaScript 的网盘文件下载地址获取工具\n版本：${sversion}\n领域：${(window.self !== window.top ? "[iframe] " : "") + (document.title ? (document.title + " (" + location.origin + location.pathname + ")") : location.href)}`, `background:url(${sicon}) center center no-repeat;background-size:12px;padding:3px`, "");

			let storedVersion = base.getValue("setting_init_version");
			if (!storedVersion || base.isNewerVersion(sversion, storedVersion)) {
				base.waitForKeyElements("body", () => {
					base.showUpdate();
					base.setValue("setting_init_version", sversion);
					return true;
				}, true)
			}

			// 最后判断页面地址并加载对应的initPanLinker
			if (/(pan|yun).baidu.com/.test(location.host)) {
				$baidu.initPanLinker();
				$baidu.greenerPage();
			}
			if (/openapi.baidu.com\/oauth/.test(location.href)) {
				$baidu.initAuthorize()
			}
			if (/www.(aliyundrive|alipan).com/.test(location.host)) {
				$aliyun.initPanLinker();
				$aliyun.greenerPage();
			}
			if (/(yun|caiyun).139.com/.test(location.host)) {
				$mcloud.initPanLinker();
				$mcloud.greenerPage();
			}
			if (/cloud.189.cn/.test(location.host)) {
				$tcloud.initPanLinker();
				$tcloud.greenerPage();
			}
			if (/pan.xunlei.com/.test(location.host)) {
				$xunlei.initPanLinker();
			}
			if (/pan.quark.cn/.test(location.host)) {
				$quark.initPanLinker();
				$quark.greenerPage();
			}
			if (/drive.uc.cn/.test(location.host)) {
				$uc.initPanLinker();
				$uc.greenerPage();
			}
			if (/(www|login).(123(pan|684|865|952|912).com|123pan.cn)/.test(location.host)) {
				$123pan.initPanLinker();
				$123pan.greenerPage();
			}
			if (/www.youxiaohou.com/.test(location.host)) {
				$youxiaohou.initPanLinker();
			}
		}
	};
	main.init();

	// 这是啥？我不到啊
	function idontknow(input) {
		let charArray = input.split('');
		// Fisher-Yates 洗牌算法
		for (let i = charArray.length - 1; i > 0; i--) {
			let j = Math.floor(Math.random() * (i + 1));
			[charArray[i], charArray[j]] = [charArray[j], charArray[i]];
		}
		return charArray.join('');
	}
})();